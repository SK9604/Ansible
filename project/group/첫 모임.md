### 주제

컨테이너 장단점 - 이창한

kops vs eks - 김선경 / 이창한

클라우드 사용하는 이유 - 허윤하

ecr vs docker hub, 시나리오, 프로젝트 계획 - 이현찬

## 오늘의 할 일

AMI 생성하기

1. **EC2 인스턴스 생성**

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5d668a54-2573-4044-ac6d-fdfb4701ccdd/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5d668a54-2573-4044-ac6d-fdfb4701ccdd/Untitled.png)

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ac582361-b2d6-4124-b412-c42d7051368b/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ac582361-b2d6-4124-b412-c42d7051368b/Untitled.png)

2. **PuTTY 연결**

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e52ec1d1-746f-4aec-ad84-6d4c7164c3f7/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e52ec1d1-746f-4aec-ad84-6d4c7164c3f7/Untitled.png)

3. **AWS CLI 설치**

    ```bash
    ~$ curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    ~$ sudo apt install unzip
    ~$ unzip awscliv2.zip
    ~$ sudo ./aws/install
    ~$ aws --version
    aws-cli/2.1.39 Python/3.8.8 Linux/5.4.0-1038-aws exe/x86_64.ubuntu.20 prompt/off
    ```

4. **사용자 생성 및 aws config**

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3a19d5a4-5614-4aa3-9e67-cbb6e94b0f2a/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3a19d5a4-5614-4aa3-9e67-cbb6e94b0f2a/Untitled.png)

    ```bash
    ~$ aws configure
    AWS Access Key ID [****************OCQJ]: s3user의 access key id
    AWS Secret Access Key [****************O+wg]: s3user의 secret access key
    Default region name [ap-northeast-2]:
    Default output format [json]:
    ```

5. **쿠버네티스 사용을 위한 준비**

    ```bash
    ~$ curl -LO  https://github.com/kubernetes/kops/releases/download/1.18.0/kops-linux-amd64
    ~$ chmod +x ./kops-linux-amd64
    ~$ sudo mv ./kops-linux-amd64 /usr/local/bin/
    ======================================================================================
    ~$ wget -O kubectl \
    http://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/linux/amd64/kubectl
    ~$ chmod +x kubectl
    ~$ ls -al
    ~$ sudo mv kubectl /usr/local/bin/
    ```

6. **버킷 생성**

    ```bash
    ~$ aws s3api create-bucket \
    --bucket sk-k8s-bucket \
    --create-bucket-configuration LocationConstraint=ap-northeast-2
    ```

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/13425201-8284-41c2-87d4-6d29ce891837/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/13425201-8284-41c2-87d4-6d29ce891837/Untitled.png)

7. **환경 변수 설정**

    ```bash
    ~$ export NAME=mycluster.k8s.local
    ~$ export KOPS_STATE_STORE=s3://sk-k8s-bucket
    ```

8. **SSH 키 생성**

    ```bash
    ~$ ssh-keygen -t rsa -N "" -f ./id_rsa
    Generating public/private rsa key pair.
    Your identification has been saved in ./id_rsa
    Your public key has been saved in ./id_rsa.pub
    The key fingerprint is:
    SHA256:P4SoZpAZXb7U69ESwtR3PZYLQWatC6qQTAjG7A3GSKI ubuntu@ip-172-31-44-247
    The key's randomart image is:
    +---[RSA 3072]----+
    |B.    o.   .=+ . |
    |=B . = .. .oo *  |
    |E.+.. = o. . + o |
    | ..=.. + =. . .  |
    |  +o .o S.o. .   |
    |   .+. ..=  .    |
    |    +. .. o      |
    |   o  .    .     |
    |                 |
    +----[SHA256]-----+
    ```

9. **yaml 파일 생성**

    ```bash
    ~$ mkdir yml
    ~$ cd yml
    ~/yml$ vi deploymentwebapp.yml
    ~/yml$ vi app-svc.yml
    ~/yml$ vi ingress-nginx.yml
    ~/yml$ vi ingress.yml
    ```

    deploymentwebapp.yml

    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: my-webapp-deployment
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: my-webapp
      template:
        metadata:
          name: urmywebapp
          labels:
            app: my-webapp
        spec:
          containers:
          - name: urmywebapp
            image: 778893145182.dkr.ecr.ap-northeast-2.amazonaws.com/skecr/skecr:1.0
            ports:
            - containerPort: 3010
              name: flask-port
          imagePullSecrets:
          - name: regcred
    ```

    app-svc.yml

    ```yaml
    apiVersion: v1
    kind: Service
    metadata:
      name: urmywebapp-svc-clusterip
    spec:
      ports:
        - name: webapp-port
          port: 80
          targetPort: flask-port
      selector:
        app: my-webapp
      type: ClusterIP
    ```

    ingress-nginx.yml

    ```yaml
    apiVersion: v1
    kind: Service
    metadata:
      labels:
        app.kubernetes.io/component: controller
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: ingress-nginx
      name: ingress-nginx-controller-nodeport
      namespace: ingress-nginx
    spec:
      ports:
      - name: http
        nodePort: 31000
        port: 80
        protocol: TCP
        targetPort: http
      - name: https
        nodePort: 32000
        port: 443
        protocol: TCP
        targetPort: https
      selector:
        app.kubernetes.io/component: controller
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/name: ingress-nginx
      type: NodePort
    ```

    ingress.yml

    ```yaml
    apiVersion: networking.k8s.io/v1beta1
    kind: Ingress
    metadata:
      name: myingress
      annotations:
        nginx.ingress.kubernetes.io/rewrite-target: /
        kubernetes.io/ingress.class: "nginx"
    spec:
      rules:
      - host: kimsk-kr.cf
        http:
          paths:
          - path: /login
            pathType: Prefix
            backend:
              serviceName: urmywebapp-svc-clusterip
              servicePort: 80
          - path: /register
            pathType: Prefix
            backend:
              serviceName: urmywebapp-svc-clusterip
              servicePort: 80
          - path: /friendlist
            pathType: Prefix
            backend:
              serviceName: urmywebapp-svc-clusterip
              servicePort: 80
    ```

10. **kops 실행**

    ```bash
    ~$ kops create cluster \
    --zones ap-northeast-2a \
    --networking calico \
    --ssh-public-key ./id_rsa.pub \
    $NAME
    ```

    - 오류 발생

    ```bash
    ~$ kops edit ig nodes --name $NAME
    ~$ kops edit ig master-ap-northeast-2a --name $NAME
    ~$ kops update cluster --yes $NAME
    ~$ kops validate cluster
    Using cluster from kubectl context: mycluster.k8s.local

    Validating cluster mycluster.k8s.local

    INSTANCE GROUPS
    NAME                    ROLE    MACHINETYPE     MIN     MAX     SUBNETS
    master-ap-northeast-2a  Master  t3.medium       1       1       ap-northeast-2a
    nodes                   Node    t3.medium       2       2       ap-northeast-2a

    NODE STATUS
    NAME                                                    ROLE    READY
    ip-172-20-35-145.ap-northeast-2.compute.internal        node    True
    ip-172-20-37-209.ap-northeast-2.compute.internal        node    True
    ip-172-20-40-218.ap-northeast-2.compute.internal        master  True

    Your cluster mycluster.k8s.local is ready
    ```

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bc2f40b0-8f67-4341-8fc8-24894cca8285/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bc2f40b0-8f67-4341-8fc8-24894cca8285/Untitled.png)

    삭제

    ```bash
    ~$ kops delete cluster $NAME --yes
    ```

11. **kops create cluster 명령어**

    ```bash
    kops create cluster \
      --zones=ap-northeast-1a,ap-northeast-1c \        # Node가 사용할 AZ
      --master-zones=ap-northeast-1a,ap-northeast-1c \ # master가 사용할 AZ
      --node-count=2 \ # Node instance count
      --node-size=t2.small \ # Node instance type - 연습용으로는 t2.small, medium 정도가 적당하다.                 
      --node-volume-size=20 \ # Node instance EBS size
      --node-security-groups=sg-090e1a638b1910292,sg-0a322c2385e859d4a \ # Node에 설정할 Security Group 나는 dev-default 와 dev-ssh-from-bastion 의 SG id를 입력했다.
      --master-count=3 \ # Master instance count 1, 3, 5..  
      --master-size=t2.small \ # Master instance type - t2.medium 이상은 되야 덜 답답했다.
      --master-volume-size=20 \ # Master intance EBS size
      --master-security-groups=sg-090e1a638b1910292,sg-0a322c2385e859d4a\ # Master에 설정할 Security Group 나는 dev-default 와 dev-ssh-from-bastion 의 SG id를 입력했다.
      --topology=private \ # 클러스터를 public, private 어떻게 오픈할 것인가?
      --api-loadbalancer-type=internal \ # K8s api-server의 LB는 public, internal 중 어떤 것으로 할 것인가?
      --admin-access=172.16.0.0/16 \ # K8s api-server에 access를 허용할 ip 대역, 우선 VPC 대역 전체를 허용했다. 필요에 따라 수정한다.
      --vpc=vpc-007605415dedcb611 \ # dev VPC
      --network-cidr=172.16.0.0/16 \ # dev VPC의 CIDR
      --subnets=subnet-06da6f4bfca8b579b,subnet-0b4f2f38e17055fba \ # private subnet - 위에서 설명한 AWS cloud provider가 인식하기 위한 태그를 kops가 붙여준다.
      --utility-subnets=subnet-038e0115b3816692b,subnet-08f020f81a02421b4 \ # public subnet 
      --image='ami-0dbe2acf413e40198' \ # 도쿄 리전의 core os AMI ID
      --networking=calico \ # calico, weave 등 overlay network driver를 선택할 수 있다.  
      --cloud-labels "Owner=asbubam,Blog=blog.2dal.com" # 생성되는 AWS 리소스에 자동으로 붙여주고 싶은 tag 리스트
    ```

    - 앞으로 고민 해야 함

        ```bash
        kops create cluster \
          --zones=ap-northeast-2c \
          --master-zones=ap-northeast-2c \
          --node-count=2 \
          --node-size=t3a.large \
          --node-volume-size=8 \
          --node-security-groups=sg-08211d9654159eb20 \
          --master-count=1 \
          --master-size=t3a.large \
          --master-volume-size=8 \
          --master-security-groups=sg-08211d9654159eb20 \
          --topology=private \
          --api-loadbalancer-type=public \
          --api-ssl-certificate=arn:aws:acm:ap-northeast-2:088755231083:certificate/cc6de7ba-749c-4899-9862-e562eca0bf02 \
          --admin-access=172.31.0.0/16 \
          --vpc=vpc-b5678dde \
          --network-cidr=172.31.0.0/16 \
          --subnets=subnet-0ade62f8f25ec8be8 \
          --utility-subnets=subnet-0ade62f8f25ec8be8 \
          --image='ami-00f1068284b9eca92' \
          --networking=calico \
          --cloud-labels "Owner=sk" \
          --ssh-public-key ./id_rsa.pub \
          $NAME
        ```

        ```bash
        kops create cluster \
          --zones=ap-northeast-2c \
          --state s3://sk-k8s-bucket \
          --master-zones=ap-northeast-2c \
          --node-count=2 \
          --node-size=t3a.large \
          --node-volume-size=8 \
          --node-security-groups=sg-05a7eec7a74892bb8 \
          --master-count=1 \
          --master-size=t3a.large \
          --master-volume-size=8 \
          --master-security-groups=sg-05a7eec7a74892bb8 \
          --topology=public \
          --api-loadbalancer-type=public \
          --admin-access=172.31.0.0/16 \
          --vpc=vpc-b5678dde \
          --network-cidr=172.31.0.0/16 \
          --subnets=subnet-0c8008973ec84832e \
          --utility-subnets=subnet-0c8008973ec84832e \
          --image='ami-00f1068284b9eca92' \
          --networking=calico \
          --cloud-labels "Owner=sk" \
          --ssh-public-key ./id_rsa.pub \
          $NAME
        ```

12. **이미지 생성**

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/4766516b-66f1-4345-8556-45c65527af0f/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/4766516b-66f1-4345-8556-45c65527af0f/Untitled.png)

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c3fe3521-0885-4cc4-8f1c-bdd076c3dbb6/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c3fe3521-0885-4cc4-8f1c-bdd076c3dbb6/Untitled.png)

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a5fd6456-bace-431e-943a-7b168776a939/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a5fd6456-bace-431e-943a-7b168776a939/Untitled.png)

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7719a929-cef4-4410-9da3-2e7f41641893/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7719a929-cef4-4410-9da3-2e7f41641893/Untitled.png)

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/079cf9de-6614-4531-a69e-243f5cb6eab6/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/079cf9de-6614-4531-a69e-243f5cb6eab6/Untitled.png)

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f87f9fee-cccc-48ca-88c5-134d36329bcd/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f87f9fee-cccc-48ca-88c5-134d36329bcd/Untitled.png)

    템플릿 수정시 새 버전이 자동으로 생성되고 기존 버전 설정을 올려주면 된다.

    ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/55ece568-347b-482e-b144-cba9e526021b/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/55ece568-347b-482e-b144-cba9e526021b/Untitled.png)
