# STP(Spanning Tree Protocol)

### Frame Looping

1. Ethernet Frame이 장비들 사이에서 사라지지 않고 빙빙 도는 것을 Ethernet Frame Looping이라고 한다.
2. STP는 스위치에서 Ethernet Frame Looping을 방지해 주는 프로토콜이다.
3. STP는 IEEE에서 2004년에 개정한 802.1D-2004 표준에 의해 RSTP(Rapid STP)로 대체되었다.
4. Ethernet Frame Loop가 발생하면 아래와 같은 여러 이상 현상이 발생한다.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/fa72e8cf-d1ab-492a-8725-509773ac9d0b/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/fa72e8cf-d1ab-492a-8725-509773ac9d0b/Untitled.png)

### STP 기본

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ef1dbafa-4eec-44d0-baa8-d6bc7d56aa7b/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ef1dbafa-4eec-44d0-baa8-d6bc7d56aa7b/Untitled.png)

1. STP가 동작하면 물리적으로 루프 구조인 네트워크에서 특정 포트를 차단상태로 바꾸어 논리적으로 루프가 발생하지 않게 한다.
2. 동작중인 스위치나 포트가 다운되면 차단상태의 포트를 다시 전송상태로 바꾸어 계속적인 통신을 보장한다.
3. STP는 BPDU(Bridge Protocol Data Unit) Frame을 이용하여 루프가 없는 경로를 구성한다.
4. BPDU는 Configuration BPDU와 TCN(Topology Change Notification) BPDU가 있다.
5. Configuration BPDU는 스위치 및 포트의 역할을 결정하고, TCN BPDU는 스위치 네트워크 구조(Topology)가 변경되었음을 알릴 때 사용된다.

### STP 동작 방식

1. 전체 스위치 중에서 Root 스위치를 선택한다.
2. Root 스위치가 아닌 모든 스위치에서 Root 포트를 하나씩 선택한다.
3. 각 스위치에서 Segment당 Designated 포트를 하나씩 선택한다.
4. Root 포트 및 Designated 포트가 아닌 포트는 Alternate 포트로 지정한다. (항상 차단됨)

### STP 동작 - 세부사항

1. Root 스위치 선택: 브리지 ID 값이 가장 낮은 스위치가 선택된다.
    1. 브리지 ID 값은 2Byte의 Priority와 6Byte의 MAC Address로 이루어진다.
    2. Priority는 0~65535이며 기본값은 중간인 32768이다.
2. Root 포트 선택: Root 스위치 외의 스위치는 Root 스위치를 기준으로 다음 사항을 비교하여 Root 포트를 하나씩 선택한다.
    1. 경로값(Path Cost)의 합이 가장 작은 포트
    2. 인접한 스위치의 브리지 ID가 가장 낮은 포트
    3. 인접한 스위치의 포트 ID가 가장 낮은 포트

        ![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d00c9bd2-9a4e-4e52-b181-8538f5fbb857/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d00c9bd2-9a4e-4e52-b181-8538f5fbb857/Untitled.png)

3. Designated 포트 선택: 스위치 및 라우터 사이를 연결하는 Segment에서 하나씩 선택한다. Segment 사이에 허브가 위치하여도 무시된다. Root 스위치의 모든 포트는 항상 Designated 포트가 되며 다른 스위치의 Designated 포트는 다음 사항을 비교하여 선택된다.
    1. 경로값의 합이 작은 스위치의 포트
    2. 브리지 ID가 낮은 스위치의 포트
    3. 포트 ID가 낮은 포트
4. CISCO 스위치에서는 하나의 VLAN당 하나씩의 STP가 동작하며, 이를 PVST(per VLAN Spanning Tree) 또는 PVST+라고 한다.

    ```
    SW1# show spanning-tree vlan 1
    ```

### Spanning Tree 포트상태

1. Blocking:
    1. Data Frame은 송수신하지 않지만 BPDU는 수신한다.
    2. 포트가 활성화되면 포트역할에 따라 Blocking 및 Listening 상태가 된다.
    3. RP(Root Port)와 DP(Designated Port)이면 바로 Listening 상태가 되고,
    4. AP(Alternate Port)이면 Blocking 상태가 된다.
    5. AP에서 RP 또는 DP로 변경되면 20초(Max Age) 후에 Listening 상태가 된다.
2. Listening:
    1. DP가 BPDU를 송신하기 시작한다.
    2. 기본적으로 15초 후 Learning 상태로 변경된다. (Forward Delay)
3. Learning:
    1. MAC Address Table을 작성한다.
    2. 기본적으로 15초 후 Forwarding 상태로 변경된다. (Forward Delay)
4. Forwarding:
    1. Data Frame을 정상적으로 송수신한다.
    2. 정상적인 네트워크라면 Forwarding 또는 Blocking 상태로 머문다.
5. Disabled State:
    1. 다운 상태에 있는 포트이다.
    2. 포트 사이에 STP 설정이 잘못되었거나, Shutdown 되어 있을 경우 Data 및 BPDU 모두 송수신하지 않는다.
    3. 스위치에 전원이 인가되면 스위치 POST과정 후 DP와 RP는 Listening 상태부터 출발하여 30초 후에 Forwarding 상태로 된다.

### Portfast

```
SW1(config-if)# spanning-tree portfast
```

1. 기본적으로 스위치는 PC와 같은 end-device가 달려 있어도 STP에 의해 Forwarding 되기까지 여러 과정을 거친다.
2. Portfast는 Port가 활성화되면 바로 Forwarding 상태가 되게 하는 것을 말한다.
3. 경고 메세지: Portfast는 단일 호스트가 접속된 포트에 설정해야 한다. 허브나 스위치 등에 설정하면 일시적인 루프가 발생할 수 있다.
4. 
5. Root Switch 조정
    1. 별도의 조정이 없으면 모든 스위치의 Bridge Priority가 동일하므로 MAC 주소가 낮은 스위치가 Root Switch가 된다.
    2. 모든 VLAN에 대해 동일한 스위치가 Root Switch가 되고 효율적인 네트워크운영이 안된다.
    3. VLAN당 서로 다른 스위치를 Root Switch로 동작시켜 Load Balancing을 유도하는 것이 바람직하다.
    4. Priority 값을 조정하여 Root Switch를 조정하는 방법

        ```
        SW1(config)# spanning-tree vlan 10 priority 0
        SW2(config)# spanning-tree vlan 10 priority 4096
        ```

    5. 직접 Root Switch를 설정하는 방법

        ```
        SW1(config)# spanning-tree vlan 10 root primary
        SW2(config)# spanning-tree vlan 10 root secondary
        ```

### EtherChannel

1. 두 스위치 사이에 연결된 여러 포트를 하나의 포트처럼 동작시키는 것이다.
2. 물리적 포트 종류에 따라 Fast EtherChannel, Giga EtherChannel, 10G EtherChannel이 있다.
3. EtherChannel은 L2, L3 Interface 및 Access Port, Trunk Port 에서 사용할 수 있다.
4. STP는 EtherChannel을 하나의 포트로 간주한다.
5. Access 포트로 EtherChannel을 구성하기 위해서는 포트의 속도, 듀플렉스, VLAN ID가 같아야 한다.
6. Trunk 포트로 EtherChannel을 구성하기 위해서는 Encapsulation, Native VLAN, 허용 VLAN이 같아야 한다.
7. STP에서는 EtherChannel을 하나의 포트로 간주되므로 Block 되는 포트가 없다.
8. EtherChannel은 최대 8개의 포트를 묶어 하나의 포트처럼 사용한다.

```
SW1(config-if-range)# switchport trunk encapsulation dot1q
SW1(config-if-range)# switchport mode trunk
SW1(config-if-range)# channel-group 1 mode on
SW1# show etherchannel summary
SW1# show spanning-tree vlan 10
```
