# NTP 서버 개요

■ NTP (network time protocol, 네트웍 시간 프로토콜)

NTP는 네트웍으로 연결되어 있는 컴퓨터들끼리 클록 시각을 동기화시키는데 사용되는 프로토콜이다. NTP는 미국 델라웨어 대학의 데이빗 밀스에 의해 처음 개발되었으나, 이제는 **인터넷 표준**이 되었다. NTP는 컴퓨터 클록 시간을 1/1000 초 이하까지 동기화시키기 위해 협정 세계시각(UTC)을 사용한다.

컴퓨터 네트웍 전반에 걸쳐 정확한 시각을 유지하는 것은 여러 가지 이유로 중요한데, 그 이유는 심지어 수십 분의 1초 정도의 차이만으로도 큰 문제가 발생될 수 있기 때문이다. 예를 들어 협정 세계시에 기반을 두면, 지역적으로 분산된 업무처리 환경에서도 작업 순서가 정확히 유지될 수 있다. 보안 메커니즘 역시 네트웍 전체에 걸쳐 협정 세계시에 기반을 두고 있다. 여러 대의 컴퓨터가 하나의 파일 시스템을 수정하는 것 역시 정확히 동기화된 클록 시각에 의존해야 한다. 항공기의 운항 궤적을 그림으로 표시해 주는 항공관제 시스템에도 매우 정확한 시간측정이 요구되는 것은 당연하다.

협정세계 시각은 무선이나 위성 시스템 등, 여러 가지 방법으로 얻어진다. GPS나 정부기관 등과 같은 특수한 수신자들은 보다 높은 수준의 서비스를 이용하는 것이 가능하지만,모든 컴퓨터에 수신기를 장착하는 것은 비경제적이며, 현실성이 없다. 그 대신에, 시각 서버로 지정된 컴퓨터들에만 수신기를 장착하고, 이 서버들과 네트웍으로 연결되어 있는 컴퓨터들의 클록 시각은 NTP와 같은 프로토콜을 사용하여 동기화하는 것이다.

협정세계시로부터 떨어져 있는 수준을 표시하기 위해 흔히 계층번호를 쓰는데, 0번 계층은 전용 송신기 또는 위성 위치추적 시스템으로부터 수신된 실제 시각인 무선 클록을, 1번 계층은 이 무선 클록과 직접 연결되어 있는 컴퓨터의 클록을, 2번 계층은 1번 계층으로부터 시각을 받은 컴퓨터 등으로 원천 협정 세계시로부터 멀수록 계층 번호가 커져 간다.

NTP라는 용어는, 프로토콜과 컴퓨터상에서 실행되는 클라이언트/서버 프로그램, 둘 모두에 대해 사용된다. 프로그램은 사용자에 의해 NTP 클라이언트, NTP 서버, 또는 둘 모두로 해석될 수 있다. NTP 클라이언트는 시각 서버에 정확한 현재 시각을 교환할 것을 요구한다. 이 교환의 결과를 통해, 클라이언트는 서버의 시각과의 차이를 이용하여 링크 지연시간을 계산할 수 있으며, 자신의 클록을 서버에 있는 클록과 일치하도록 조정할 수 있다. 하나의 규칙으로서, 처음 클록을 맞추기 위해서는 5~10분 동안 모두 6번의 시각 교환이 요구된다. 일단 시각 동기화가 끝나면, 클라이언트는 매 10분마다 메시지 교환을 통해 클록을 수정한다. 클록 동기화의 신뢰도 및 정확도를 높이기 위해, 여러 대의 서로 다른 서버와 다양한 네트웍 경로가 사용된다. 클라이언트/서버 동기화에 아울러, NTP는 브로드캐스트를 통한 컴퓨터 클록 동기화도 지원한다. NTP는 매우 높은 수준의 내고장성과 확장 가능성을 염두에 두고 설계되었다.

NTP 서버에서 사용되는 용어에 대해 알아보자.

(1). 기본적인 용어

■ Reference Clock - GMT, UTC과 같이 표준시간(기준시간) 또는 참고 시간

(예: 한국 : GMT/UTC + 9 시간)

■ Strata - NTP 서버의 계층적 구조

■ Stratum-1 Server - NTP 1계층 서버

Stratum-2 Server - NTP 2계층 서버

... -15 .... - NTP 15계층 서버(15까지 존재)

■ Drift File - PPM(Parts-Per-Million)단위로 오프셋에 일치하는 단일 부동 소수점이 들어가 있다. (예: /var/ntp/ntp.drift)

■ xntpd - NTP 서버/클라이언트 데몬

■ ntp.conf - NTP 서버/클라이언트 주 설정 파일

(2). 추가적인 용어

■ Resolution - 시간 제공 장치에서 사용하는 시간의 최소 단위.

(예) 손목시계의 Resolution : 1초

■ Precision - 컴퓨터 프로그램에서 사용하는 시간의 최소 단위.

■ Accuracy - 시간의 정확성. 기준시간(UTC)과 얼마나 근접한가를 나타냄.

■ Jitter - 시간을 측정했을 때 생기는 오차 중 작은 값.

■ Wander - 시간을 측정했을 때 생기는 오차 중 큰 값.

```bash
[참고] UTC & GMT
● UTC(Universal Time Coordinate) 협정 세계시, 그리니치 표준시 대신 방송에 사용되는 표준시. 협정 세계시는 국제 사회가 사용하는 과학적 시간의 표준입니다. 1972년1월1일부터시행된협정세계시에서는67년국제도량형총회가정한세슘원자의 진동수에 의거한 초의 길이가 그 기준(원자초)으로 쓰인다. 그 때까지 시간의 기준으로는 지구의 자전에 의한 평균태양시와 지구의 공전에 의한 태양년에서 산출한 초의 길이가 쓰였다. 그리니치표준시(GMT)는 원래 평균태양시를 기준으로 한 것이었다. 따라서 원자시계를 표준으로 하면서부터 GMT라는 명칭이 실체(實體)를 바르게 나타내지 못하는 불합리한 점이 생겼다. 이러한 문제를 없애기 위해서 1978년 국제무선통신자문위원회(CCIS) 총회는 통신분야에서는 금후 그리니치평균시를 협정세계시(UTC)로 바꾸어 쓰자는 권고안을 채택하였다.
 
● GMT(Greenwich Mean Time) 그리니치 표준시. 그리니치천문대를 지나는 본초자오선(그리니치자오선)을 기준으로 하는 시. 약호 GMT. 약칭하여 그리니치시라고도 한다. 1925년 이전의 그리니치시는 정오(正午)를0시로하여 시간을 재기 시작하는 방식의 천문학용 평균태양시의 명칭이었다. 이에 반해 일상생활에서는 자정을0시로하여시간을재는방식이사용되었으며,이것을그리니치상용시(GCT)라고 하였다. 1925년1월1일국제천문연합에서는그리니치시를12시간앞당겨그리니치 상용시와 일치시켰으며, 이를 세계시(世界時)라고 하여 전세계 공통의 표준시로 사용하였다. 그러나 지구의 자전을 근거로 한 이 세계시는 수정시계나 원자시계와 비교한 결과 지구 자전의 불규칙성에 의한 오차가 있으므로 1972년 이후에는 새로이 협정세계시가 세계표준시로 사용되었다. 협정세계시란 세계시와는 달리 원자 방사(放射)의 진동수를 기준으로 하고, 원자시의 초(秒)를 세분하여 세계시와의 차이가 0.9초 이내가 되도록 만든 것이다.
```

[참고] 참고 URL(시, 시간의 인식, 시의 척도, 시법, 하루의 시작, 보시등)

http://kr.dic.yahoo.com/search/enc/result.html?p=UTC&pk=15348300&subtype=&type=enc&field=id

[참고] Stratum 1 / Stratum 2

http://www.ntp.org

Stratum 1 Server : http://support.ntp.org/bin/view/Servers/StratumOneTimeServers

Stratum 2 Server : http://support.ntp.org/bin/view/Servers/StratumTwoTimeServers

[참고] 

현재 많은 서비스가 ntpd , chronyd에 의존적이다. 

그런데 현재 서비스 내에서 시간 서비스를 구동할때 ntpd를 사용하는 경우가 대부분이다. 
chronyd로 구성을 해둔 경우에는 인식불가능한 경우도 존재한다.

[참고]

최소설치 버전인 경우에는 기본적으로 설치가 되어 있지 않기 때문에 설치 부터 진행을 한다.

**[SERVER1]# rpm -qa | grep chrony**

**[SERVER1]# dnf -y install chrony**

```
마지막 메타 데이터 만료 확인 : 5:51:37 전에 2020년 07월 27일 (월) 오후 06시 51분 29초.
Dependencies resolved.
===========================================================================================================
 Package                   Architecture           Version                     Repository              Size
===========================================================================================================
Installing:
 chrony                    x86_64                 3.5-1.el8                   BaseOS                 271 k
Installing weak dependencies:
 timedatex                 x86_64                 0.5-3.el8                   BaseOS                  32 k

Transaction Summary
===========================================================================================================
설치  2 Packages

Total download size: 303 k
Installed size: 731 k
패키지 다운로드중:
(1/2): timedatex-0.5-3.el8.x86_64.rpm                                      187 kB/s |  32 kB     00:00    
(2/2): chrony-3.5-1.el8.x86_64.rpm                                         515 kB/s | 271 kB     00:00    
-----------------------------------------------------------------------------------------------------------
합계                                                                       269 kB/s | 303 kB     00:01     
트랜잭션 점검 실행 중
트랜잭션 검사가 성공했습니다.
트랜잭션 테스트 실행 중
트랜잭션 테스트가 완료되었습니다.
거래 실행 중
  준비 중입니다  :                                                                                     1/1 
  Installing     : timedatex-0.5-3.el8.x86_64                                                          1/2 
  스크립틀릿 실행: timedatex-0.5-3.el8.x86_64                                                          1/2 
  스크립틀릿 실행: chrony-3.5-1.el8.x86_64                                                             2/2 
  Installing     : chrony-3.5-1.el8.x86_64                                                             2/2 
  스크립틀릿 실행: chrony-3.5-1.el8.x86_64                                                             2/2 
  확인 중        : chrony-3.5-1.el8.x86_64                                                             1/2 
  확인 중        : timedatex-0.5-3.el8.x86_64                                                          2/2 

설치됨:
  chrony-3.5-1.el8.x86_64                            timedatex-0.5-3.el8.x86_64                           

완료되었습니다!
```

**[SERVER1]# rpm -ql chrony**

**[SERVER1]# rpm -ql chrony | grep conf**

```
**/etc/chrony.conf**
/etc/sysconfig/chronyd
/usr/share/man/man5/chrony.conf.5.gz
```

[삭제예정]

```bash
# systemctl stop chronyd
# yum -y remove chrony
# yum -y install ntp
# systemctl start ntpd
# rpm -ql ntp | grep conf | grep etc 
# vi /etc/ntp.conf
-------
기존에 존재하던 server 라인을 주석처리하고 
server 192.168.10.200 iburst 
-----
# systemctl enable ntpd 
# timedatectl status 
 > ntp sync 부분이 삭제가 되어 있기때문에 sync를 다시 설정한다.
# timedatectl setup-ntp true
# timedatectl status 
```

### NTP 서버 동작 원리(NTP Server Concept)

(1). NTP 서비스 관리

```bash
# systemctl status chronyd
# systemctl enable chronyd
# timedatectl
# date
# chronyc [option]
```

(2). NTP Network Transfer Time Check

```bash
NTP Client           NTP Server
     |                    	|
  T1 | ------------------>	| T2
     |                    	|
     |                    	|
  T4 | <------------------	| T3
     |                    	|
     |                    	|
```

네트워크에서 보낸시간 = [(T2-T1)+(T4-T3)] / 2

(a). NTP Client는 NTP 서버에 현재 시간을 요구하는 요청을 보낼 때, 패킷에 클라이언트의 현재 시간(T1)을 포함하여 보낸다.

(b). 클라이언트의 요청을 받은 NTP 서버는 요청을 받았을 때의 서버 시간(T2)을 패킷에 포함한다.

(c). NTP 서버는 현재 UTC 시간을 패킷에 포함하고, 클라리언트로 보내는 순간을 서버 시간(T3)도 패킷에 포함하여 클라이언트의 요청에 응답한다.

(d). 클라이언트는 서버의 응답을 받는 순간의 시간(T4)과 나머지 시간들을 이용하여 네트워크에서 얼만큼의 시간을 보냈는지 판단하여 UTC 시간에 더한 후 시스템의 시간으로 설정한다.

# NTP 서버/클라이언트 실습

■ NTP 서버/클라이언트 실습

```bash
(실습 환경)

￭ NTP Main Server : (NAT, ens33)  192.168.10.200
￭ NTP Client      : (NAT, ens33)  192.168.10.210
￭ NTP Client      : (NAT, ens33)  192.168.10.220
```

> NTP 주 설정 파일 설정

**[SERVER1]# cat /etc/chrony.conf**

```
pool 2.centos.pool.ntp.org iburst  < NTP 클라이언트가 어느 서버에 접속하여 시간 정보를 받아 올 것인가를 지정
**server ntp.example.com iburst** < NTP 클라이언트가 특정 서버에 접속하여 시간 정보를 받아 올 것인가를 지정
allow 192.168.10.0/24          < NTP 서버로서 클라이언트에게 시간 정보를 전송하는 경우 어느 네트워크 대역에 전송할 것인지를 작성

특정 경우에 사용되는 옵션
restrict 192.168.10.0 mask 255.255.255.0 nomodify notrap noquery
nomodify  클라이언트가 서버에 접근하여 변경 하지 못하도록 하는 경우
notrap    Trap 서비스에 대한 거절 - 원격지 이벤트 로그를 저장하는 프로그램에 의하여 사용되는 제어 메시지 프로토콜
noquery  정보 및 설정 요청에 대한 무시
```

iburst 옵션의 의미 

타임 서버들은 초기 서비스에 걸리는 동기화 시간이 존재한다. 서비스를 시작하고 외부, 내부망에서 네트워크를 확인한 뒤 패킷을 보내 동기화를 시작

패킷을 전송하고 다음 패킷까지 걸리는 시간은 16초가 걸린다. 이 시간을 줄이기 위해서 한번에 8개를 동시에 전송하라는 옵션이다.  

**[SERVER1]# vim /etc/chrony.conf**

```
# Use public servers from the pool.ntp.org project.
# Please consider joining the pool (http://www.pool.ntp.org/join.html).
pool 2.centos.pool.ntp.org iburst    < 메인서버로 동작시킬 클라이언트 이기 때문에 외부에서 NTP 정보를 받아와야 한다. 이 부분은 그대로 유지한다.
                                     
# Record the rate at which the system clock gains/losses time.
driftfile /var/lib/chrony/drift

# Allow the system clock to be stepped in the first three updates
# if its offset is larger than 1 second.
makestep 1.0 3

# Enable kernel synchronization of the real-time clock (RTC).
rtcsync

# Enable hardware timestamping on all interfaces that support it.
#hwtimestamp *

# Increase the minimum number of selectable sources required to adjust
# the system clock.
#minsources 2

# Allow NTP client access from local network.
#allow 192.168.0.0/16       < 클라이언트로 동작시킬 pool을 지정
allow 192.168.10.0/24       < 추가해줄 라인 

# Serve time even if not synchronized to a time source.
#local stratum 10

# Specify file containing keys for NTP authentication.
keyfile /etc/chrony.keys

# Get TAI-UTC offset and leap seconds from the system tz database.
leapsectz right/UTC

# Specify directory for log files.
logdir /var/log/chrony

# Select which information is logged.
#log measurements statistics tracking
```

ntp 서버 straum의 의미 

외부 ntp서버의 경우 호스트 네임 앞에 숫자가 붙는다.

```
**2.centos.pool.ntp.org**
```

NTP 계층을 나타내는 번호

straum 0 원자시계, GPS , 표준주파수

straum 1 물리적으로 연결되어 시간을 얻는 서버 전세계에서 수백 이상의 1 서버가 운영중

straum 2 메인서버인 straum 1 에서 연결되어 경유된 서버, NTP 서버를 하나씩 지날때마다 straum이 1씩 증가

외부에서 NTP 서버를 구성하여 사용하는 경우에는 straum 2을 일반적으로 사용한다.

> 서비스 데몬 start 및 확인

**[SERVER1]# timedatectl**

```
               Local time: 화 2020-07-28 01:31:13 KST
           Universal time: 월 2020-07-27 16:31:13 UTC
                 RTC time: 월 2020-07-27 16:31:13
                Time zone: Asia/Seoul (KST, +0900)
System clock synchronized: no
              NTP service: inactive
          RTC in local TZ: no
```

**[SERVER1]# timedatectl set-ntp false**

**[SERVER1]# systemctl enable chronyd**

**[SERVER1]# systemctl status chronyd**

```
● chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; enabled; vendor preset: enabled)
   **Active: inactive (dead)**
     Docs: man:chronyd(8)
           man:chrony.conf(5)
```

**[SERVER1]# systemctl start chronyd**

**[SERVER1]# systemctl status chronyd**

**[SERVER1]# pgrep -lf chronyd**

```
22676 chronyd
```

> 설정 확인

**[SERVER1]# timedatectl status**

```
               Local time: 월 2020-07-27 11:56:42 KST
           Universal time: 월 2020-07-27 02:56:42 UTC
                 RTC time: 월 2020-07-27 02:56:34
                Time zone: Asia/Seoul (KST, +0900)
System clock synchronized: no
              **NTP service: active**
          RTC in local TZ: no
```

[SERVER1]# chronyc sources

```
210 Number of sources = 4
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
^x clock.sjc.he.net              1   6    17   129  +7437ms[ -129ms] +/-   71ms
^x node1.ardoin.me               2   6    57    62  +7564ms[+7564ms] +/-  135ms
^x ntp3.junkemailfilter.com      2   6    17   124  +6800ms[ -766ms] +/-   93ms
^x time.cloudflare.com           3   6    37    63  +7581ms[  +15ms] +/-   80ms
```

[SERVER1]# timedatectl status

```
Local time: 월 2020-07-27 11:59:07 KST
Universal time: 월 2020-07-27 02:59:07 UTC
RTC time: 월 2020-07-27 02:59:05
Time zone: Asia/Seoul (KST, +0900)
System clock synchronized: no  NTP 클라이언트
NTP service: active   NTP  서버 활성화
RTC in local TZ: no   RTC 시간을 활성화 유무
```

[SERVER1]# timedatectl set-ntp true

[SERVER1]# timedatectl set-ntp yes

[SERVER1]# timedatectl

```
           Local time: 월 2020-07-27 12:01:38 KST
           Universal time: 월 2020-07-27 03:01:38 UTC
                 RTC time: 월 2020-07-27 03:01:37
                Time zone: Asia/Seoul (KST, +0900)
**System clock synchronized: yes ntp클라이언트로 시간 서버에서 동기화가 진행 중이다.**
              NTP service: active
          RTC in local TZ: no
```

**[SERVER1]# chronyc sources -v**

```
210 Number of sources = 4

  .-- Source mode  '^' = server, '=' = peer, '#' = local clock.
 / .- Source state '*' = current synced, '+' = combined , '-' = not combined,
| /   '?' = unreachable, 'x' = time may be in error, '~' = time too variable.
||                                                 .- xxxx [ yyyy ] +/- zzzz
||	Reachability register (octal) -.           |  xxxx = adjusted offset,
||	Log2(Polling interval) --.	|          |  yyyy = measured offset,
||                                \     |          |  zzzz = estimated error.
||                                 |    |           \
MS Name/IP address         Stratum Poll Reach LastRx Last sample
===============================================================================
^? ntp2.wiktel.com               1   7   140   327   +248ms[ -139ms] +/-   94ms
^? time.cloudflare.com           0   6     0     -     +0ns[   +0ns] +/-    0ns
^- formularfetischisten.de	 2   6   363    64    -13ms[  -13ms] +/-  178ms
**^* 111.230.189.174**               2   6   273    65   +101ms[ +152ms] +/-   60ms
```

[SERVER1]# chronyc sources

```
210 Number of sources = 4
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
^* dadns.cdnetworks.co.kr        2   6    37     4  -3158ns[-5671us] +/-   45ms
^- 210.183.236.141               2   6    37     3  -1052us[-1052us] +/-   52ms
^- send.mx.cdnetworks.com        2   6    37     3   -269us[ -269us] +/-   44ms
^- 106.247.248.106               2   6    37     2   +524us[ +524us] +/-   32ms

```

**[SERVER1]# chronyc -a makestep**

```
200 OK
chronyc -a makestep 이 명령어는 NTP 서버와 최대한 근접하게 시간을 수정하여 동기화 되는 시간을 줄여줄수 있다.
```

**[SERVER1]# chronyc sources**

```
210 Number of sources = 4
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
**^* dadns.cdnetworks.co.kr        2   6   377    15  -1015us[-1165us] +/-   48ms**
^+ 210.183.236.141               2   6   377    15  -1849us[-1998us] +/-   54ms
^+ send.mx.cdnetworks.com        2   6   377    14  -1244us[-1244us] +/-   46ms
^+ 106.247.248.106               2   6   375    13   -897us[ -897us] +/-   35ms

동기화가 완료 되면 Reach 값이 377로 유지된다.
```

**[SERVER1]# firewall-cmd --permanent --add-service=ntp**

```
success
```

**[SERVER1]# firewall-cmd --reload**

```
success
```

> NTP 클라이언트 구성

**[SERVER2]# dnf -y install chrony**

**[SERVER2]# systemctl enable chronyd**

**[SERVER2]# systemctl start chronyd**

**[SERVER2]# systemctl status chronyd**

**[SERVER2]# vi /etc/chrony.conf**

```
# Use public servers from the pool.ntp.org project.
# Please consider joining the pool (http://www.pool.ntp.org/join.html).
**server 192.168.10.200 iburst**
```

**[SERVER2]# systemctl restart chronyd**

**[SERVER2]# timedatectl set-ntp false**

**[SERVER2]# timedatectl set-ntp yes**

**[SERVER2]# timedatectl**

```
               Local time: 월 2020-07-27 12:24:54 KST
           Universal time: 월 2020-07-27 03:24:54 UTC
                 RTC time: 월 2020-07-27 12:03:42
                Time zone: Asia/Seoul (KST, +0900)
System clock synchronized: **yes**
              NTP service: active
          RTC in local TZ: no
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/10fbbadc-54b5-4bec-aa9a-bc4594449765/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/10fbbadc-54b5-4bec-aa9a-bc4594449765/Untitled.png)

- 도메인으로 받아오기
    1. [SERVER1]dns 설정

        ```bash
        # cat server.zone 
        $TTL 4
        @	IN SOA	ns1.example.com. root.example.com. (
        					43	; serial
        					1D	; refresh
        					1H	; retry
        					1W	; expire
        					3H )	; minimum
        	NS	@
        	A	192.168.10.200
        	AAAA	::1
        	IN	NS	ns1
        ns1	IN	A	192.168.10.200
        www	IN	A	192.168.10.200
        ntp	IN	A	192.168.10.200
        ```

    2. [SERVER1]named-chroot 재시작

        ```bash
        # systemctl restart named-chroot
        ```

    3. [SERVER3]dns 확인

        ```bash
        # nslookup ntp.example.com
        Server:		8.8.8.8
        Address:	8.8.8.8#53

        #** server can't find ntp.example.com: NXDOMAIN

        # nmcli con mod ens33 ipv4.dns 192.168.10.200
        # nmcli con down ens33; nmcli con up ens33
        Connection 'ens33' successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/1)
        Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/4)
        # nslookup ntp.example.com
        Server:		192.168.10.200
        Address:	192.168.10.200#53

        Name:	ntp.example.com
        Address: 192.168.10.200
        ```

    4. [SERVER3]/etc/chrony.conf 수정

        ```bash
        # cat /etc/chrony.conf 
        # Use public servers from the pool.ntp.org project.
        # Please consider joining the pool (http://www.pool.ntp.org/join.html).
        server ntp.example.com iburst
        ```

    5. [SERVER3]재시작 및 확인

        ```bash
        # systemctl restart chronyd
        # timedatectl set-ntp false; timedatectl set-ntp true
        # chronyc -a makestep
        200 OK
        # chronyc sources
        210 Number of sources = 1
        MS Name/IP address         Stratum Poll Reach LastRx Last sample               
        ===============================================================================
        ^* server1.example.com           3   6    17    25    -35us[  +20us] +/- 9371us
        # timedatectl 
                       Local time: Tue 2021-01-19 12:28:51 KST
                   Universal time: Tue 2021-01-19 03:28:51 UTC
                         RTC time: Tue 2021-01-19 03:28:50
                        Time zone: Asia/Seoul (KST, +0900)
        System clock synchronized: yes
                      NTP service: active
                  RTC in local TZ: no
        ```

> NTP Peer 서버 설정 확인

**[SERVER2]# timedatectl status**

**[SERVER2]# chronyc tracking**

```
Reference ID    : C0A80AC8 (server1.example.com)
Stratum         : 4
Ref time (UTC)  : Mon Jul 27 03:26:00 2020
**System time     : 0.000001609 seconds fast of NTP time**
Last offset     : -0.000994429 seconds
RMS offset      : 0.000994429 seconds
Frequency       : 6.467 ppm slow
Residual freq   : -0.089 ppm
Skew            : 5.550 ppm
Root delay      : 0.021902602 seconds
Root dispersion : 0.027237635 seconds
Update interval : 64.8 seconds
Leap status     : Normal
```

**[SERVER2]# chronyc -a makestep**

```
200 OK
```

**[SERVER2]# chronyc sources**

```
210 Number of sources = 1
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
^* server1.example.com           3   6   177    49    +22us[  -67us] +/-   39ms
```

**[SERVER2]# chronyc sources -v**

```
210 Number of sources = 1

  .-- Source mode  '^' = server, '=' = peer, '#' = local clock.
 / .- Source state '*' = current synced, '+' = combined , '-' = not combined,
| /   '?' = unreachable, 'x' = time may be in error, '~' = time too variable.
||                                                 .- xxxx [ yyyy ] +/- zzzz
||      Reachability register (octal) -.           |  xxxx = adjusted offset,
||      Log2(Polling interval) --.      |          |  yyyy = measured offset,
||                                \     |          |  zzzz = estimated error.
||                                 |    |           \
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
^* server1.example.com           3   6   377     7   +376us[ +714us] +/-   39ms
```

출력 결과 해석시

```
*                현재 NTP 서버와 동기화 중
+                NTP 서버와 통신은 가능하지만 현재 동기화는 하고 있지 않음
-                NTP 서버와 통신은 가능하지만 동기화 목록에서 제외된 경우
blank or INIT    NTP 서버와 통신이 불가능

reach = reachability	reach 값은 타임서버에 완전히 접속하기 위한 8진수로 377이어야 합니다.
delay = delay		delay 값은 양의 수여야 하며 가능한 작은 값이어야 합니다.
```

# FTP

# 단원목표

---

- FTP 개요
- FTP 프로그램의 종류
- vsFTP 개요
- vsFTP 서버 실습
- FTP 보안

---

# FTP(File Transfer Protocol) 개요

■ FTP (File Transfer Protocol) 파일 전송 프로토콜

FTP[에프 티 피]는 인터넷상의 컴퓨터들간에 파일을 교환하기 위한 표준 프로토콜로서 가장 간단한 방법이기도 하다. 화면에 표시할 수 있는 웹 페이지와 관련 파일들을 전송하는 HTTP, 전자우편을 전송하는 SMTP 등과 같이, FTP 역시 인터넷의 TCP/IP 응용 프로토콜 중의 하나이다. FTP는 웹 페이지 파일들을 인터넷상에서 모든 사람이 볼 수 있도록 하기 위해 저작자의 컴퓨터로부터 서버로 옮기는 과정에서 사용된다. 또한, 다른 서버들로부터 자신의 컴퓨터로 프로그램이나 파일들을 다운로드 하는 데에도 많이 사용된다.

사용자 입장에서는 간단한 명령을 이용하여 FTP를 쓰거나, 또는 그래픽 사용자 인터페이스를 제공하는 상용 프로그램을 쓸 수도 있다. 보통은 웹 브라우저도 웹 페이지로부터 선택한 프로그램을 다운로드 하는데 FTP를 사용한다. FTP를 사용하여 서버에 있는 파일을 지우거나 이름을 바꾸거나 옮기거나 복사하는 등 갱신작업을 할 수도 있다. FTP 서버에는 로그온을 해야하지만, 익명의 FTP를 사용하여 모든 사람들에게 공개된 파일들을 쉽게 접근할 수 있도록 하고 있다.

FTP는 보통 TCP/IP에 함께 딸려오는 일련의 프로그램 속에 포함되어 있다.

■ Anonymous FTP (anonymous File Transfer Protocol) ; 익명 FTP

인터넷에서 FTP를 사용할 때 anonymous FTP는 사용자들이 서버에 자신을 식별시키지 않고서도 파일에 접근할 수 있는 방법을 제공한다. 보통의 FTP 사이트들은 오직 적법한 사용자 아이디와 패스워드를 가진 사람만이 이용할 수 있는데 반해, anonymous FTP는 파일을 보거나 다운로드하기 위해 해당 서버에서 부여된 사용자 아이디나 패스워드가 없더라도 작업이 가능하기 때문에 anonymous 라고 부른다.

Anonymous FTP 서버에 접속한 뒤 사용자 아이디로 "anonymous" 라고 입력하고, 패스워드에는 자신의 이메일 주소를 입력하면 로그인이 허용된다 (이때, 패스워드를 넣지 않거나 어떤 내용을 넣더라도 로그인 하는데 문제가 없지만, 대개 자신의 이메일 주소를 쳐 넣는 것이 통신상의 예의로 되어있다).

# FTP(File Transfer Protocol) 프로그램의 종류

리눅스에서 사용할수 있는 FTP 프로그램은 여러가지이다.

- wu-ftpd : 예전 RedHat Linux에서 사용하던 기본 FTP 프로그램
- **vsftpd** : 현재 많이 사용되고 있는 기본 FTP 프로그램
- proftpd : 현재 많이 사용되고 있는 기본 FTP 프로그램
- 기타(gssftp, tftp, sftp...)

이 교재에서는 vsftpd 프로그램에 대해서만 다룬다.

(1) vsftpd, proftpd 프로그램의 차이점

```bash
종류                           특징 설명
vsftpd 특징
		● UNIX 시스템에서 사용할 수 있는 Free FTP daemon
		● 리눅스, Solaris, HP, FreeBSD 등에 지원된다.
		● 보안부분을 특히 강조한 서버 데몬
		● Redhat, SUSE, OPEN-BSD에서 기본 FTP 데몬으로 채택
		● 가상 IP 설정(Virtual IP Configuration) 
		● 가상 유저 지원(Virtual Users)
		● Standalon 또는 inetd(xinetd) 지원
		● 전송 대역폭 조절 기능(Bandwidth Throttling)
		● 환경설정파일을 IP별로 독립적인 지원(Per-source-IP Configurability)
		● IP별 제한 기능(Per-source-IP Limits)
		● IPv6 지원
		● SSL을 사용한 암호화 지원(Encryption support through SSL integration)
		● (vsftpd 사이트) http://vsftpd.beasts.org
     
proftpd 특징
		● UNIX 또는 UNIX 호환 OS를 위한 FTP daemon
		● Apache web server의 설정 방식
		● Apache의 “.htaccess”와 비슷한 각 디렉토리의 “.ftpaccess” 설정
		● 쉽게 설정할 수 있는 다중 가상 FTP 서버와 anonymous FTP 서비스
		● 시스템 부하에 따라 stand-alone 또는 inetd 의 선택적 운영
		● shadow 암호 지원, 만료된 계정들 지원 포함
		● (proftpd 사이트) http://www.proftpd.org
```

# vsFTP(Very Secure FTP) 개요

```bash
vsftpd is a GPL licensed FTP server for UNIX systems, including Linux. It is secure and extremely fast. It is stable. Don't take my word for it, though. Below, we will see evidence supporting all three assertions. We will also see a list of a few important sites which are happily using vsftpd. This demonstrates vsftpd is a mature and trusted solution.
```

- 안정적이고 빠르며 보안이 강화된 FTP로 Redhat, Suse, Open-BSD등에서 기본으로 채택하는 FTP서버이다.
- 기본 프로그램인 vsFTP 프로그램은 Standalone 방식으로 동작하고 있다.

```bash
패키지: vsftpd 
	------ vsFTP Server -----

	vsftpd(20,21)
	/etc/vsftpd/vsftpd.conf
	- /home/<사용자>    => 인증된 사용자 접속(EX: user01,fedora)
	- /var/ftp          => 익명 사용자 접속  (EX: anonymous)
```

(1) vsftpd 프로그램 설치 및 설정 파일 확인

```bash
          FTP Client      	      FTP Server
	    (192.168.10.200)	      (192.168.10.210)
	
	----------------------		----------------------
[그림] 실습 구조(FTP Server)
```

> 설치 확인

**[SERVER1]# dnf -y install vsftpd**

```
마지막 메타 데이터 만료 확인 : 0:01:13 전에 2020년 07월 28일 (화) 오전 12시 30분 44초.
Dependencies resolved.
=========================================================================================================
 Package               Architecture          Version                      Repository                Size
=========================================================================================================
Installing:
 vsftpd                x86_64                3.0.3-31.el8                 AppStream                180 k

Transaction Summary
=========================================================================================================
설치  1 Package

Total download size: 180 k
Installed size: 343 k
패키지 다운로드중:
vsftpd-3.0.3-31.el8.x86_64.rpm                                           1.7 MB/s | 180 kB     00:00    
---------------------------------------------------------------------------------------------------------
합계                                                                     263 kB/s | 180 kB     00:00     
트랜잭션 점검 실행 중
트랜잭션 검사가 성공했습니다.
트랜잭션 테스트 실행 중
트랜잭션 테스트가 완료되었습니다.
거래 실행 중
  준비 중입니다  :                                                                                   1/1 
  Installing     : vsftpd-3.0.3-31.el8.x86_64                                                        1/1 
  스크립틀릿 실행: vsftpd-3.0.3-31.el8.x86_64                                                        1/1 
  확인 중        : vsftpd-3.0.3-31.el8.x86_64                                                        1/1 

설치됨:
  vsftpd-3.0.3-31.el8.x86_64                                                                             

완료되었습니다!
```

**[SERVER1]# rpm -qa | grep vsftpd**

**[SERVER1]# rpm -ql vsftpd | grep conf**

```
/etc/vsftpd/vsftpd.conf
```

> vsftp 설치 폴더 확인 및 환경 설정 파일 확인

**[SERVER1]# cd /etc/vsftpd**

**[SERVER1]# ls**

```
ftpusers  user_list  vsftpd.conf  vsftpd_conf_migrate.sh

ftpusers   설정에 따라 ftp를 사용할 수 없는 유저를 등록하는 파일
user_list  설정에 따라 ftp를 사용할 수 없는 유저를 등록하는 파일
vsftpd.conf vsftp 서비스를 설정하기 위한 파일
vsftpd_conf_migrate.sh 설정정보를 마이그레이션 하기 위한 스크립트
```

■ vsftpd 관련 파일들

```bash
파일종류                  설명
/etc/vsftpd/vsftpd.conf   
/etc/vsftpd/ftpusers      
/etc/vsftpd/user_list     
/var/ftp                  Anonymous FTP 사용자를 위한 디렉토리
```

**[SERVER1]# cat /etc/vsftpd/ftpusers**

**[SERVER1]# cat /etc/vsftpd/user_list**

위 파일에 정의된 사용자는 FTP 서버에 접속할수가 없다.

> /etc/vsftpd/vsftpd.conf 파일 분석

```bash
     1	# Example config file /etc/vsftpd/vsftpd.conf
     2	#
     3	# The default compiled in settings are fairly paranoid. This sample file
     4	# loosens things up a bit, to make the ftp daemon more usable.
     5	# Please see vsftpd.conf.5 for all compiled in defaults.
     6	#
     7	# READ THIS: This example file is NOT an exhaustive list of vsftpd options.
     8	# Please read the vsftpd.conf.5 manual page to get a full idea of vsftpd's
     9	# capabilities.
    10	#
    11	# Allow anonymous FTP? (Beware - allowed by default if you comment this out).
    12	anonymous_enable=YES		 /* 익명 사용자의 접속을 가능하게 설정한다. */
    13	#
    14	# Uncomment this to allow local users to log in.
    15	# When SELinux is enforcing check for SE bool ftp_home_dir
    16	local_enable=YES		/* 로컬 사용자의 접속을 가능하게 설정한다. */ 
    17	#
    18	# Uncomment this to enable any form of FTP write command.
    19	write_enable=YES		/* 로컬 사용자의 쓰기 기능을 가능하게 설정한다. */
    20	#
    21	# Default umask for local users is 077. You may wish to change this to 022,
    22	# if your users expect that (022 is used by most other ftpd's)
    23	local_umask=022			/* 로컬 사용자의 파일 생성시 적용될 umask 값을 설정한다. */
    24	#
    25	# Uncomment this to allow the anonymous FTP user to upload files. This only
    26	# has an effect if the above global write enable is activated. Also, you will
    27	# obviously need to create a directory writable by the FTP user.
    28	# When SELinux is enforcing check for SE bool allow_ftpd_anon_write, allow_ftpd_full_access
    29	#anon_upload_enable=YES		/* 익명 사용자의 파일 업로드를 가능하게 설정한다. */
    30	#
    31	# Uncomment this if you want the anonymous FTP user to be able to create
    32	# new directories.
    33	#anon_mkdir_write_enable=YES	/* 익명 사용자의 디렉토리 생성을 가능하게 설정한다. */
    34	#
    35	# Activate directory messages - messages given to remote users when they
    36	# go into a certain directory.
    37	dirmessage_enable=YES		/* 특정 폴더에 접속시 .message 파일의 메시지를 보여줄 것인지를 지정 하는 설정이다. */                             
    38	#
    39	# Activate logging of uploads/downloads.
    40	xferlog_enable=YES		/* 업로드/다운로드 로그를 xferlog에 기록하겠다는 설정이다. */
    41	#
    42	# Make sure PORT transfer connections originate from port 20 (ftp-data).
    43	connect_from_port_20=YES	/* ftp 데이터 전송시 20번 포트 사용을 설정한다. */
    44	#
    45	# If you want, you can arrange for uploaded anonymous files to be owned by
    46	# a different user. Note! Using "root" for uploaded files is not
    47	# recommended!
    48	#chown_uploads=YES		/* 익명 사용자가 업로드한 파일의 소유권을 변경할 때 설정한다. */
    49	#chown_username=whoever		/* chown_uploads=YES일 경우 지정한 사용자 이름으로 익명 사용자가 업로드한 파일의 소유자가 지정된다. */
    50	#
    51	# You may override where the log file goes if you like. The default is shown
    52	# below.
    53	#xferlog_file=/var/log/xferlog	/* 업로드/다운로드 로그파일을 지정한다. */
    54	#
    55	# If you want, you can have your log file in standard ftpd xferlog format.
    56	# Note that the default log file location is /var/log/xferlog in this case.
    57	xferlog_std_format=YES		 /* xferlog를 표준 로그포맷으로 기록한다. */
    58	#
    59	# You may change the default value for timing out an idle session.
    60	#idle_session_timeout=600	/* ftp접속의 타임아웃시간을 지정한다. (단위: 초) */
    61	#
    62	# You may change the default value for timing out a data connection.
    63	#data_connection_timeout=120	/* 데이터 전송의 타임아웃시간을 지정한다. (단위: 초) */
    64	#
    65	# It is recommended that you define on your system a unique user which the
    66	# ftp server can use as a totally isolated and unprivileged user.
    67	#nopriv_user=ftpsecure		/* vsftpd 데몬을 루트가 아닌 시스템에 존재하는 일반 사용자의 비특권 권한으로 동작시킨다. */
    68	#
    69	# Enable this and the server will recognise asynchronous ABOR requests. Not
    70	# recommended for security (the code is non-trivial). Not enabling it,
    71	# however, may confuse older FTP clients.
    72	#async_abor_enable=YES		/* async_abor_enables 기능을 사용하겠다는 설정이다. 파일전송을 취소하였을때에 취소되지 않는경우 해결할수 있는 옵션, 보안상 이유로 사용하지 않음
    73	#
    74	# By default the server will pretend to allow ASCII mode but in fact ignore
    75	# the request. Turn on the below options to have the server actually do ASCII
    76	# mangling on files when in ASCII mode. The vsftpd.conf(5) man page explains
    77	# the behaviour when these options are disabled.
    78	# Beware that on some FTP servers, ASCII support allows a denial of service
    79	# attack (DoS) via the command "SIZE /big/file" in ASCII mode. vsftpd
    80	# predicted this attack and has always been safe, reporting the size of the
    81	# raw file.
    82	# ASCII mangling is a horrible feature of the protocol.
    83	#ascii_upload_enable=YES	/* ASCII 모드로 업로드를 허락하겠다는 설정이다. */
    84	#ascii_download_enable=YES	/* ASCII 모드로 다운로드를 허락하겠다는 설정이다. */
    85	#
    86	# You may fully customise the login banner string:
    87	#ftpd_banner=Welcome to blah FTP service.	/* ftp 서버 접속시 안내메세지를 출력한다. */
    88	#
    89	# You may specify a file of disallowed anonymous e-mail addresses. Apparently
    90	# useful for combatting certain DoS attacks.
    91	#deny_email_enable=YES		/* 익명사용자 접속시 패스워드를 e-mail형식으로 받겠다는 설정이다. */
    92	# (default follows)
    93	#banned_email_file=/etc/vsftpd/banned_emails	/* 허용하지 않을 e-mail 주소를 파일에 넣어두면 접속이 안된다. (banned_emails파일 생성시) */
    94	#
    95	# You may specify an explicit list of local users to chroot() to their home
    96	# directory. If chroot_local_user is YES, then this list becomes a list of
    97	# users to NOT chroot().
    98	# (Warning! chroot'ing can be very dangerous. If using chroot, make sure that
    99	# the user does not have write access to the top level directory within the
   100	# chroot)
   101	#chroot_local_user=YES		 /* 전체 사용자가 chroot 기능을 사용하도록 설정한다. */
   102	#chroot_list_enable=YES		 /* chroot_list에 등록된 사용자만 chroot 기능을 사용하도록 설정한다. */
   103	# (default follows)
   104	#chroot_list_file=/etc/vsftpd/chroot_list	/* chroot 기능을 사용할 사용자 리스트 파일을 지정한다. */
   105	#
   106	# You may activate the "-R" option to the builtin ls. This is disabled by
   107	# default to avoid remote users being able to cause excessive I/O on large
   108	# sites. However, some broken FTP clients such as "ncftp" and "mirror" assume
   109	# the presence of the "-R" option, so there is a strong case for enabling it.
   110	#ls_recurse_enable=YES		/* ls -R(서브디렉토리 파일 목록 출력) 명령 사용여부를 설정한다. */
   111	#
   112	# When "listen" directive is enabled, vsftpd runs in standalone mode and
   113	# listens on IPv4 sockets. This directive cannot be used in conjunction
   114	# with the listen_ipv6 directive.
   115	listen=NO		/* 단독 데몬일 경우 listen 을 YES로 지정한다.  */
   116	#
   117	# This directive enables listening on IPv6 sockets. By default, listening
   118	# on the IPv6 "any" address (::) will accept connections from both IPv6
   119	# and IPv4 clients. It is not necessary to listen on *both* IPv4 and IPv6
   120	# sockets. If you want that (perhaps because you want to listen on specific
   121	# addresses) then you must run two copies of vsftpd with two configuration
   122	# files.
   123	# Make sure, that one of the listen options is commented !!
   124	listen_ipv6=YES
   125	
   126	pam_service_name=vsftpd		/* pam 사용자 인증 설정 */
   127	userlist_enable=YES		/* userlist 사용을 허가하겠다는 설정이다. */ /*  # userlist_deny=NO		/* userlist 에 등록된 사용자만 허가하겠다는 설정이다. */ */
   128	tcp_wrappers=YES		/* tcp_wrappers 기능을 사용하겠다는 설정이다. (host, ip 차단) /
```

### vsftpd 기본 설정 테스트

> FTP 서비스 확인

**[SERVER1]# ftp**

```
-bash: ftp: command not found
6.X 버전부터는 클라이언트 프로그램이 기본적으로 설치되어 있지 않다. sftp를 사용하여 보안성을 강화하라는 뜻이지만 현재 ftp가 많이 사용되고 있기때문에 실습을 위하여 설치후 진행한다.
```

**[SERVER1]# dnf -y install ftp**

**[SERVER1]# ftp**

```
ftp>
```

**[SERVER1]# ftp localhost**

```
Trying ::1...
ftp: connect to address ::1연결이 거부됨
Trying 127.0.0.1...
ftp: connect: 연결이 거부됨
ftp> **exit**
```

**[SERVER1]# systemctl status vsftpd**

```
● vsftpd.service - Vsftpd ftp daemon
   Loaded: loaded (/usr/lib/systemd/system/vsftpd.service; disabled; vendor preset: disabl>
   Active: inactive (dead)
```

**[SERVER1]# systemctl start vsftpd**

**[SERVER1]# systemctl enable vsftpd**

**[SERVER1]# systemctl status vsftpd**

**[SERVER1]# ftp localhost**

```
Trying ::1...
Connected to localhost (::1).
220 (vsFTPd 3.0.3)
Name (localhost:root): **root**
530 Permission denied.
Login failed.
ftp> **by**
221 Goodbye.
```

root 계정이 접속이 되지 않은 이유 : user_list 파일과 ftpusers 파일에 현재 등록이 되어 있기 때문이다. 이 라인을 삭제나 주석 처리 한다.

일반 사용자의 경우에는 기본적으로 등록이 되어 있지 않기 때문에 접속이 가능하다.

[SERVER1]# cd /etc/vsftpd

**[SERVER1]# cat ftpusers | grep '#root'**

```
#root
```

**[SERVER1]# cat user_list | grep '#root'**

```
#root
```

[SERVER1]# semanage boolean -l | grep ftp | grep access

```bash
ftpd_full_access               (off  ,  off)  Allow ftpd to full access
```

**[SERVER1]# semanage boolean -m ftpd_full_access --on**

SELINUX에서 FTP데몬에 대한 제어를 할수 있도록 기능을 활성화 한다.

**[SERVER1]#** semanage boolean -l | grep ftp | grep access

```bash
ftpd_full_access               (on   ,   on)  Allow ftpd to full access
```

**[SERVER1]# getenforce**

```bash
Enforcing
```

**[SERVER1]# ftp localhost**

```
Trying ::1...
Connected to localhost (::1).
220 (vsFTPd 3.0.3)
Name (localhost:root): **root**
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> **dir**
229 Entering Extended Passive Mode (|||45845|)
150 Here comes the directory listing.
**-rw-------    1 0        0            1603 Jul 14 12:38 anaconda-ks.cfg**
226 Directory send OK.
ftp>
```

vsftpd 서비스가 실행되면 

(일반사용자)는 /etc/vsftpd/ftpusers, /etc/vsftpd/user_list 파일에 등록이 되어 있지 않기 때문에 바로 FTP 로그인이 가능하다.

(root 사용자)는 /etc/vsftpd/ftpusers, /etc/vsftpd/user_list 파일에 등록에 등록 되어 있기 때문에 FTP 로그인이 가능하지 않다. 
                      이런 경우 두개의 파일에서 root 라인을 삭제하면 된다. 

                      하지만, 이 설정은 실무에서는 권장하지 않는다. root 사용자로 로그인 하는 것은 보안상 좋지 않다.

### /etc/vsftpd/ftpusers, /etc/vsftpd/user_list 파일 테스트

```bash
-----> /etc/vsftpd/ftpusers -> /etc/vsftpd/user_list -----> 
	       user01                  (X)                   -----> Login incorrect   (Login Fail)
	       (X)                     user01                -----> Permission denied (Login Fail)
	       (X)                     (X)                   -----> Login successful  (Login Success)
```

> /etc/vsftpd/ftpusers 파일에 user01 사용자 등록 및 점검

```
(전제 조건) user01, user02 사용자가 존재 해야 한다.
[SERVER1]# **cat /etc/passwd | grep user***
[SERVER1]# **useradd user01**
[SERVER1]# **useradd user02**
[SERVER1]# **passwd user01**
user01 사용자의 비밀 번호 변경 중
새  암호:
잘못된 암호: 암호는 8 개의 문자 보다 짧습니다
새  암호 재입력:
passwd: 모든 인증 토큰이 성공적으로 업데이트 되었습니다.
[SERVER1]# **passwd user02**
user02 사용자의 비밀 번호 변경 중
새  암호:
잘못된 암호: 암호는 8 개의 문자 보다 짧습니다
새  암호 재입력:
passwd: 모든 인증 토큰이 성공적으로 업데이트 되었습니다.
[SERVER1]# **cat /etc/passwd | grep user***

tss:x:59:59:Account used by the trousers package to sandbox the tcsd daemon:/dev/null:/sbin/nologin
**user01:x:1001:1001::/home/user01:/bin/bash
user02:x:1002:1002::/home/user02:/bin/bash**
```

> 사용자를 두개의 파일에 등록해 보면서 어디서 차단이 이루어 지는지 확인

**[SERVER1]# cd /etc/vsftpd/**

한개의 라인에 한명의 사용자를 정의한다. 한개의 라인에 여러명의 사용자 이름을 지정할 수 없다.

**[SERVER1]# vi ftpusers**

```
user01
```

**[SERVER1]# vi user_list**

```
user02
```

**[SERVER1]# ftp localhost**

```
Trying ::1...
Connected to localhost (::1).
220 (vsFTPd 3.0.3)
Name (localhost:root): **user01**   
331 Please specify the password.   < ID 확인은 가능 
Password:  
530 Login incorrect.  < 비밀번호 입력시 접속 차단
Login failed.
ftp> exit
221 Goodbye.

ftpusers에 등록되어 있는 계정
```

**[SERVER1]# ftp localhost**

```
Trying ::1...
Connected to localhost (::1).
220 (vsFTPd 3.0.3)
Name (localhost:root): **user02**
530 Permission denied.  < ID를 입력한 직후 바로 차단
Login failed.
ftp> by
221 Goodbye.

user_list에 등록되어 있는 계정
```

위의 내용을 확인하였다면 ftpusers, user_list에 등록되어 있는 user01, user02의 내용을 삭제 또는 주석처리 한 뒤 다시 접근 시도

### ftp 명령어 사용

> 명령어 사용법

```
ftp <hostnameIP> (EX: ftp 192.168.10.200)
ftp <IP> <PORT> (EX: ftp 192.168.10.200 21)
ftp 192.168.10.200
```

**사용자로 로그인**

(ㄱ) 업로드/다운로드 포인터 맞추기(cd/lcd)

(ㄴ) 편리한 기능 설정(bin/hash/prompt)

(ㄷ) 업로드/다운로드(mget/mput/get/put)

(ㄹ) 확인/해제(ls/dir/bye/quit)

```bash
**■ (Upload 실습)
        (server1)                     (server2)
	----- 192.168.10.200 -----		----- 192.168.10.210 -----

	# ftp 192.168.10.252

	/root/server1.txt(1M)  ----------> /tmp/server1.txt**
```

> 실습준비

**[SERVER1]# systemctl status vsftpd**

**[SERVER1]# pgrep -lf vsftpd**

**[SERVER1]# cd**

**[SERVER1]# dd if=/dev/zero of=server1.txt bs=1M count=1**

**[SERVER1]# ls -lh**

```
합계 1.1M
-rw-------. 1 root root 1.6K  7월 14 21:38 anaconda-ks.cfg
-rw-r--r--. 1 root root 1.0M  7월 28 01:37 server1.txt
```

> FTP 서버 접속

**[SERVER2]# ftp 192.168.10.200**

```
-bash: ftp: command not found
```

**[SERVER2]# dnf -y install ftp**

**[SERVER2]# ftp 192.168.10.200**

```
ftp: connect: 호스트로 갈 루트가 없음
ftp> by
```

**[SERVER1]# firewall-cmd --permanent --add-service=ftp**

**[SERVER1]# firewall-cmd --reload**

**[SERVER1]# firewall-cmd --list-services**

```
cockpit dhcpv6-client **ftp** ssh
```

**[SERVER2]# ftp 192.168.10.200 | # ftp server1**

```
Connected to 192.168.10.200 (192.168.10.200).
220 (vsFTPd 3.0.3)
Name (192.168.10.200:root): root
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp>
```

> 업로드/다운로드 포인터 맞추기

도움말 확인

```
ftp> help
Commands may be abbreviated.  Commands are:

!		debug		mdir		sendport	site
$		dir		mget		put		size
account		disconnect	mkdir		pwd		status
append		exit		mls		quit		struct
ascii		form		mode		quote		system
bell		get		modtime		recv		sunique
binary		glob		mput		reget		tenex
bye		hash		newer		rstatus		tick
case		help		nmap		rhelp		trace
cd		idle		nlist		rename		type
cdup		image		ntrans		reset		user
chmod		lcd		open		restart		umask
close		ls		prompt		rmdir		verbose
cr		macdef		passive		runique		?
delete		mdelete		proxy		send
```

원격지 디렉토리 변경

```
ftp> cd /tmp
250 Directory successfully changed.
ftp> ls
```

로컬 디렉토리 변경

```
ftp> lcd /root
Local directory now /root
ftp> !ls
```

> 편리한 기능 설정

```
ftp> **bin**
200 Switching to Binary mode. 전송모드: binary, ascii
■ 전송 모드(Transmission Mode)
File(ASCII) ----- ASCII ----->
File(BINARY)----- BINARY ---->

ftp> **hash**
Hash mark printing on (1024 bytes/hash mark). 파일전송: Hash(#) 표시
File(500M)  --------4K(#)---->

ftp> **prompt**
Interactive mode off. 대화형모드 ON/OFF 
File1, File2 ----------------> (y/n)? 
File3, File4
```

ASCII > 예전 방식의 ftp 프로그램들이 기본적으로 사용

Binary > 최근에는 ftp 프로그램들이 기본적으로 binary를 택하고있다.

local에서 파일을 가지고 있는 경우에는 아무런 문제가 생기지 않는다.

nfs iscsi mail http...

ftp: 이기종간의 전송 (서로 다른 운영체제)

server 100 byte  >>> client 112 byte 용량이 달라지는 문제가 ASCII 코드에서 나타난다.

windows 라인이 끝나는 문자열 2byte

linux, unix 라인이 끝나는 문자열 1byte

개행 문자에 대한 차이이다.

> 업로드/다운로드

원격지 서버 SERVER1에서 SERVER2로 파일을 다운로드

```
ftp> pwd
257 "/root" is the current directory
ftp> !pwd
/root
ftp> bin
200 Switching to Binary mode.
ftp> hash
Hash mark printing on (1024 bytes/hash mark).
ftp> prompt
Interactive mode off.
ftp> ls
227 Entering Passive Mode (192,168,10,200,66,113).
150 Here comes the directory listing.
drwxr-xr-x    2 0        0               6 Jan 04 04:30 Desktop
drwxr-xr-x    2 0        0               6 Jan 04 04:30 Documents
drwxr-xr-x    2 0        0               6 Jan 04 04:30 Downloads
drwxr-xr-x    2 0        0               6 Jan 04 04:30 Music
drwxr-xr-x    2 0        0               6 Jan 04 04:30 Pictures
drwxr-xr-x    2 0        0               6 Jan 04 04:30 Public
drwxr-xr-x    2 0        0               6 Jan 04 04:30 Templates
drwxr-xr-x    2 0        0               6 Jan 04 04:30 Videos
-rw-------    1 0        0            1755 Jan 04 04:29 anaconda-ks.cfg
-rw-r--r--    1 0        0            1865 Jan 04 04:30 initial-setup-ks.cfg
-rw-r--r--    1 0        0         1048576 Jan 19 05:56 server1.txt
226 Directory send OK.
ftp> get server1.txt
local: server1.txt remote: server1.txt
227 Entering Passive Mode (192,168,10,200,163,36).
150 Opening BINARY mode data connection for server1.txt (1048576 bytes).
################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
226 Transfer complete.
1048576 bytes received in 0.004 secs (262078.48 Kbytes/sec)
ftp> !ls
anaconda-ks.cfg  Desktop  Documents  Downloads	initial-setup-ks.cfg  Music  Pictures  Public  server1.txt  Templates  Videos
```

동일한 파일을 이름을 변경하여 다운로드

```
ftp> get server1.txt test1.txt
local: test1.txt remote: server1.txt
227 Entering Passive Mode (192,168,10,200,147,232).
150 Opening BINARY mode data connection for server1.txt (1048576 bytes).
################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
226 Transfer complete.
1048576 bytes received in 0.0063 secs (166493.49 Kbytes/sec)
```

원격지로 파일을 업로드

```
ftp> put test1.txt
local: test1.txt remote: test1.txt
227 Entering Passive Mode (192,168,10,200,129,146).
150 Ok to send data.
################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
226 Transfer complete.
1048576 bytes sent in 0.0156 secs (67160.44 Kbytes/sec)
ftp> ls
227 Entering Passive Mode (192,168,10,200,203,251).
150 Here comes the directory listing.
-rw-------    1 0        0            1603 Jul 14 12:38 anaconda-ks.cfg
-rw-r--r--    1 0        0         1048576 Jul 27 16:37 server1.txt
-rw-r--r--    1 0        0         1048576 Jul 27 16:55 test1.txt
226 Directory send OK.
```

대량의 파일 전송

[SERVER1]# touch file{1..30}

SERVER2에서 다운로드 테스트

```
ftp> **ls**
227 Entering Passive Mode (192,168,10,200,91,216).
150 Here comes the directory listing.
-rw-------    1 0        0            1603 Jul 14 12:38 anaconda-ks.cfg
-rw-r--r--    1 0        0               0 Jul 27 16:56 file1
-rw-r--r--    1 0        0               0 Jul 27 16:56 file10
-rw-r--r--    1 0        0               0 Jul 27 16:56 file11
-rw-r--r--    1 0        0               0 Jul 27 16:56 file12
-rw-r--r--    1 0        0               0 Jul 27 16:56 file13
-rw-r--r--    1 0        0               0 Jul 27 16:56 file14
-rw-r--r--    1 0        0               0 Jul 27 16:56 file15
-rw-r--r--    1 0        0               0 Jul 27 16:56 file16
-rw-r--r--    1 0        0               0 Jul 27 16:56 file17
-rw-r--r--    1 0        0               0 Jul 27 16:56 file18
-rw-r--r--    1 0        0               0 Jul 27 16:56 file19
-rw-r--r--    1 0        0               0 Jul 27 16:56 file2
-rw-r--r--    1 0        0               0 Jul 27 16:56 file20
-rw-r--r--    1 0        0               0 Jul 27 16:56 file21
-rw-r--r--    1 0        0               0 Jul 27 16:56 file22
-rw-r--r--    1 0        0               0 Jul 27 16:56 file23
-rw-r--r--    1 0        0               0 Jul 27 16:56 file24
-rw-r--r--    1 0        0               0 Jul 27 16:56 file25
-rw-r--r--    1 0        0               0 Jul 27 16:56 file26
-rw-r--r--    1 0        0               0 Jul 27 16:56 file27
-rw-r--r--    1 0        0               0 Jul 27 16:56 file28
-rw-r--r--    1 0        0               0 Jul 27 16:56 file29
-rw-r--r--    1 0        0               0 Jul 27 16:56 file3
-rw-r--r--    1 0        0               0 Jul 27 16:56 file30
-rw-r--r--    1 0        0               0 Jul 27 16:56 file4
-rw-r--r--    1 0        0               0 Jul 27 16:56 file5
-rw-r--r--    1 0        0               0 Jul 27 16:56 file6
-rw-r--r--    1 0        0               0 Jul 27 16:56 file7
-rw-r--r--    1 0        0               0 Jul 27 16:56 file8
-rw-r--r--    1 0        0               0 Jul 27 16:56 file9
-rw-r--r--    1 0        0         1048576 Jul 27 16:37 server1.txt
-rw-r--r--    1 0        0         1048576 Jul 27 16:55 test1.txt
226 Directory send OK.
ftp> **mget file***
local: file1 remote: file1
227 Entering Passive Mode (192,168,10,200,72,26).
150 Opening BINARY mode data connection for file1 (0 bytes).
226 Transfer complete.
local: file10 remote: file10
227 Entering Passive Mode (192,168,10,200,246,40).
150 Opening BINARY mode data connection for file10 (0 bytes).
226 Transfer complete.
local: file11 remote: file11
227 Entering Passive Mode (192,168,10,200,124,240).
150 Opening BINARY mode data connection for file11 (0 bytes).
226 Transfer complete.
local: file12 remote: file12
227 Entering Passive Mode (192,168,10,200,144,255).
150 Opening BINARY mode data connection for file12 (0 bytes).
226 Transfer complete.
local: file13 remote: file13
227 Entering Passive Mode (192,168,10,200,195,91).
150 Opening BINARY mode data connection for file13 (0 bytes).
226 Transfer complete.
local: file14 remote: file14
227 Entering Passive Mode (192,168,10,200,99,56).
150 Opening BINARY mode data connection for file14 (0 bytes).
226 Transfer complete.
local: file15 remote: file15
227 Entering Passive Mode (192,168,10,200,128,118).
150 Opening BINARY mode data connection for file15 (0 bytes).
226 Transfer complete.
local: file16 remote: file16
227 Entering Passive Mode (192,168,10,200,34,209).
150 Opening BINARY mode data connection for file16 (0 bytes).
226 Transfer complete.
local: file17 remote: file17
227 Entering Passive Mode (192,168,10,200,50,143).
150 Opening BINARY mode data connection for file17 (0 bytes).
226 Transfer complete.
local: file18 remote: file18
227 Entering Passive Mode (192,168,10,200,81,74).
150 Opening BINARY mode data connection for file18 (0 bytes).
226 Transfer complete.
local: file19 remote: file19
227 Entering Passive Mode (192,168,10,200,143,22).
150 Opening BINARY mode data connection for file19 (0 bytes).
226 Transfer complete.
local: file2 remote: file2
227 Entering Passive Mode (192,168,10,200,131,209).
150 Opening BINARY mode data connection for file2 (0 bytes).
226 Transfer complete.
local: file20 remote: file20
227 Entering Passive Mode (192,168,10,200,170,94).
150 Opening BINARY mode data connection for file20 (0 bytes).
226 Transfer complete.
local: file21 remote: file21
227 Entering Passive Mode (192,168,10,200,41,219).
150 Opening BINARY mode data connection for file21 (0 bytes).
226 Transfer complete.
local: file22 remote: file22
227 Entering Passive Mode (192,168,10,200,41,89).
150 Opening BINARY mode data connection for file22 (0 bytes).
226 Transfer complete.
local: file23 remote: file23
227 Entering Passive Mode (192,168,10,200,74,254).
150 Opening BINARY mode data connection for file23 (0 bytes).
226 Transfer complete.
local: file24 remote: file24
227 Entering Passive Mode (192,168,10,200,114,111).
150 Opening BINARY mode data connection for file24 (0 bytes).
226 Transfer complete.
local: file25 remote: file25
227 Entering Passive Mode (192,168,10,200,228,168).
150 Opening BINARY mode data connection for file25 (0 bytes).
226 Transfer complete.
local: file26 remote: file26
227 Entering Passive Mode (192,168,10,200,22,169).
150 Opening BINARY mode data connection for file26 (0 bytes).
226 Transfer complete.
local: file27 remote: file27
227 Entering Passive Mode (192,168,10,200,81,190).
150 Opening BINARY mode data connection for file27 (0 bytes).
226 Transfer complete.
local: file28 remote: file28
227 Entering Passive Mode (192,168,10,200,222,99).
150 Opening BINARY mode data connection for file28 (0 bytes).
226 Transfer complete.
local: file29 remote: file29
227 Entering Passive Mode (192,168,10,200,76,120).
150 Opening BINARY mode data connection for file29 (0 bytes).
226 Transfer complete.
local: file3 remote: file3
227 Entering Passive Mode (192,168,10,200,60,60).
150 Opening BINARY mode data connection for file3 (0 bytes).
226 Transfer complete.
local: file30 remote: file30
227 Entering Passive Mode (192,168,10,200,70,178).
150 Opening BINARY mode data connection for file30 (0 bytes).
226 Transfer complete.
local: file4 remote: file4
227 Entering Passive Mode (192,168,10,200,111,75).
150 Opening BINARY mode data connection for file4 (0 bytes).
226 Transfer complete.
local: file5 remote: file5
227 Entering Passive Mode (192,168,10,200,197,140).
150 Opening BINARY mode data connection for file5 (0 bytes).
226 Transfer complete.
local: file6 remote: file6
227 Entering Passive Mode (192,168,10,200,79,213).
150 Opening BINARY mode data connection for file6 (0 bytes).
226 Transfer complete.
local: file7 remote: file7
227 Entering Passive Mode (192,168,10,200,169,144).
150 Opening BINARY mode data connection for file7 (0 bytes).
226 Transfer complete.
local: file8 remote: file8
227 Entering Passive Mode (192,168,10,200,29,47).
150 Opening BINARY mode data connection for file8 (0 bytes).
226 Transfer complete.
local: file9 remote: file9
227 Entering Passive Mode (192,168,10,200,186,10).
150 Opening BINARY mode data connection for file9 (0 bytes).
226 Transfer complete.
ftp> **!ls -l**
합계 2048
-rw-r--r--. 1 root root       0  7월 28 02:01 file1
-rw-r--r--. 1 root root       0  7월 28 02:01 file10
-rw-r--r--. 1 root root       0  7월 28 02:01 file11
-rw-r--r--. 1 root root       0  7월 28 02:01 file12
-rw-r--r--. 1 root root       0  7월 28 02:01 file13
-rw-r--r--. 1 root root       0  7월 28 02:01 file14
-rw-r--r--. 1 root root       0  7월 28 02:01 file15
-rw-r--r--. 1 root root       0  7월 28 02:01 file16
-rw-r--r--. 1 root root       0  7월 28 02:01 file17
-rw-r--r--. 1 root root       0  7월 28 02:01 file18
-rw-r--r--. 1 root root       0  7월 28 02:01 file19
-rw-r--r--. 1 root root       0  7월 28 02:01 file2
-rw-r--r--. 1 root root       0  7월 28 02:01 file20
-rw-r--r--. 1 root root       0  7월 28 02:01 file21
-rw-r--r--. 1 root root       0  7월 28 02:01 file22
-rw-r--r--. 1 root root       0  7월 28 02:01 file23
-rw-r--r--. 1 root root       0  7월 28 02:01 file24
-rw-r--r--. 1 root root       0  7월 28 02:01 file25
-rw-r--r--. 1 root root       0  7월 28 02:01 file26
-rw-r--r--. 1 root root       0  7월 28 02:01 file27
-rw-r--r--. 1 root root       0  7월 28 02:01 file28
-rw-r--r--. 1 root root       0  7월 28 02:01 file29
-rw-r--r--. 1 root root       0  7월 28 02:01 file3
-rw-r--r--. 1 root root       0  7월 28 02:01 file30
-rw-r--r--. 1 root root       0  7월 28 02:01 file4
-rw-r--r--. 1 root root       0  7월 28 02:01 file5
-rw-r--r--. 1 root root       0  7월 28 02:01 file6
-rw-r--r--. 1 root root       0  7월 28 02:01 file7
-rw-r--r--. 1 root root       0  7월 28 02:01 file8
-rw-r--r--. 1 root root       0  7월 28 02:01 file9
-rw-r--r--. 1 root root 1048576  7월 28 01:56 server1.txt
-rw-r--r--. 1 root root 1048576  7월 28 01:56 test1.txt
drwx------. 2 root root       6  7월 28 00:34 vmware-root_743-4257135038
```

다수의 파일을 업로드

```
ftp> **cd /tmp**
250 Directory successfully changed.
ftp> **mput file***
local: file1 remote: file1
227 Entering Passive Mode (192,168,10,200,75,139).
150 Ok to send data.
226 Transfer complete.
local: file10 remote: file10
227 Entering Passive Mode (192,168,10,200,167,134).
150 Ok to send data.
226 Transfer complete.
local: file11 remote: file11
227 Entering Passive Mode (192,168,10,200,56,129).
150 Ok to send data.
226 Transfer complete.
local: file12 remote: file12
227 Entering Passive Mode (192,168,10,200,87,6).
150 Ok to send data.
226 Transfer complete.
local: file13 remote: file13
227 Entering Passive Mode (192,168,10,200,184,240).
150 Ok to send data.
226 Transfer complete.
local: file14 remote: file14
227 Entering Passive Mode (192,168,10,200,160,216).
150 Ok to send data.
226 Transfer complete.
local: file15 remote: file15
227 Entering Passive Mode (192,168,10,200,124,78).
150 Ok to send data.
226 Transfer complete.
local: file16 remote: file16
227 Entering Passive Mode (192,168,10,200,239,151).
150 Ok to send data.
226 Transfer complete.
local: file17 remote: file17
227 Entering Passive Mode (192,168,10,200,141,248).
150 Ok to send data.
226 Transfer complete.
local: file18 remote: file18
227 Entering Passive Mode (192,168,10,200,57,48).
150 Ok to send data.
226 Transfer complete.
local: file19 remote: file19
227 Entering Passive Mode (192,168,10,200,92,167).
150 Ok to send data.
226 Transfer complete.
local: file2 remote: file2
227 Entering Passive Mode (192,168,10,200,103,238).
150 Ok to send data.
226 Transfer complete.
local: file20 remote: file20
227 Entering Passive Mode (192,168,10,200,183,212).
150 Ok to send data.
226 Transfer complete.
local: file21 remote: file21
227 Entering Passive Mode (192,168,10,200,233,176).
150 Ok to send data.
226 Transfer complete.
local: file22 remote: file22
227 Entering Passive Mode (192,168,10,200,132,78).
150 Ok to send data.
226 Transfer complete.
local: file23 remote: file23
227 Entering Passive Mode (192,168,10,200,127,7).
150 Ok to send data.
226 Transfer complete.
local: file24 remote: file24
227 Entering Passive Mode (192,168,10,200,146,61).
150 Ok to send data.
226 Transfer complete.
local: file25 remote: file25
227 Entering Passive Mode (192,168,10,200,204,128).
150 Ok to send data.
226 Transfer complete.
local: file26 remote: file26
227 Entering Passive Mode (192,168,10,200,130,3).
150 Ok to send data.
226 Transfer complete.
local: file27 remote: file27
227 Entering Passive Mode (192,168,10,200,136,47).
150 Ok to send data.
226 Transfer complete.
local: file28 remote: file28
227 Entering Passive Mode (192,168,10,200,226,73).
150 Ok to send data.
226 Transfer complete.
local: file29 remote: file29
227 Entering Passive Mode (192,168,10,200,193,41).
150 Ok to send data.
226 Transfer complete.
local: file3 remote: file3
227 Entering Passive Mode (192,168,10,200,87,144).
150 Ok to send data.
226 Transfer complete.
local: file30 remote: file30
227 Entering Passive Mode (192,168,10,200,231,160).
150 Ok to send data.
226 Transfer complete.
local: file4 remote: file4
227 Entering Passive Mode (192,168,10,200,171,75).
150 Ok to send data.
226 Transfer complete.
local: file5 remote: file5
227 Entering Passive Mode (192,168,10,200,94,134).
150 Ok to send data.
226 Transfer complete.
local: file6 remote: file6
227 Entering Passive Mode (192,168,10,200,64,98).
150 Ok to send data.
226 Transfer complete.
local: file7 remote: file7
227 Entering Passive Mode (192,168,10,200,109,157).
150 Ok to send data.
226 Transfer complete.
local: file8 remote: file8
227 Entering Passive Mode (192,168,10,200,93,65).
150 Ok to send data.
226 Transfer complete.
local: file9 remote: file9
227 Entering Passive Mode (192,168,10,200,238,239).
150 Ok to send data.
226 Transfer complete.
ftp> **ls**
227 Entering Passive Mode (192,168,10,200,128,134).
150 Here comes the directory listing.
-rw-r--r--    1 0        0               0 Jul 27 16:58 file1
-rw-r--r--    1 0        0               0 Jul 27 16:58 file10
-rw-r--r--    1 0        0               0 Jul 27 16:58 file11
-rw-r--r--    1 0        0               0 Jul 27 16:58 file12
-rw-r--r--    1 0        0               0 Jul 27 16:58 file13
-rw-r--r--    1 0        0               0 Jul 27 16:58 file14
-rw-r--r--    1 0        0               0 Jul 27 16:58 file15
-rw-r--r--    1 0        0               0 Jul 27 16:58 file16
-rw-r--r--    1 0        0               0 Jul 27 16:58 file17
-rw-r--r--    1 0        0               0 Jul 27 16:58 file18
-rw-r--r--    1 0        0               0 Jul 27 16:58 file19
-rw-r--r--    1 0        0               0 Jul 27 16:58 file2
-rw-r--r--    1 0        0               0 Jul 27 16:58 file20
-rw-r--r--    1 0        0               0 Jul 27 16:58 file21
-rw-r--r--    1 0        0               0 Jul 27 16:58 file22
-rw-r--r--    1 0        0               0 Jul 27 16:58 file23
-rw-r--r--    1 0        0               0 Jul 27 16:58 file24
-rw-r--r--    1 0        0               0 Jul 27 16:58 file25
-rw-r--r--    1 0        0               0 Jul 27 16:58 file26
-rw-r--r--    1 0        0               0 Jul 27 16:58 file27
-rw-r--r--    1 0        0               0 Jul 27 16:58 file28
-rw-r--r--    1 0        0               0 Jul 27 16:58 file29
-rw-r--r--    1 0        0               0 Jul 27 16:58 file3
-rw-r--r--    1 0        0               0 Jul 27 16:58 file30
-rw-r--r--    1 0        0               0 Jul 27 16:58 file4
-rw-r--r--    1 0        0               0 Jul 27 16:58 file5
-rw-r--r--    1 0        0               0 Jul 27 16:58 file6
-rw-r--r--    1 0        0               0 Jul 27 16:58 file7
-rw-r--r--    1 0        0               0 Jul 27 16:58 file8
-rw-r--r--    1 0        0               0 Jul 27 16:58 file9
drwx------    2 0        0               6 Jul 27 15:30 vmware-root_717-4281712138
226 Directory send OK.
ftp> **by**
221 Goodbye.
```

# vsFTP(Very Secure FTP) 서버 실습

/etc/vsftpd/vsftpd.conf 파일 설정을 통해 vsftp 서버의 기능을 테스트한다. 좀더 자세한 내용은 vsftpd.conf 매뉴얼 참고한다.

■ **(관리 설정)** 배너 메세지 출력

■ **(보안 설정)** Greeting Message 출력

■ **(보안 설정)** chroot 구성

■ **(보안 설정)** 익명사용자의 홈디렉토리

■ **(보안 설정)** FTP 포트 변경

■ **(관리 설정)** MAX client 제한

■ **(보안 설정)** 한개 아이피에 대한 접속 제한

■ **(보안 설정)** 접속 사용자 제한

■ FTP 보안

```bash
vsFTP 서버를 좀 더 편리하게 사용하기 위해서 다음과 같은 Alias을 추가하여 사용해도 된다.
# vi ~/.bashrc 

..... (중략) .....
#
# FTP Server Alias
#
alias FTP='cd /etc/vsftpd'
alias vsftpd.conf='vi /etc/vsftpd/vsftpd.conf'
alias ftpusers='vi /etc/vsftpd/ftpusers'
alias user_list='vi /etc/vsftpd/user_list'
alias flog='tail -f /var/log/xferlog'

# . ~/.bashrc         (# source ~/.bashrc)
-> 현재 쉘에서 .bashrc 파일의 내용을 적용한다.
```

### [EX1] 배너 메세지 출력

```bash
banner_file  이 선택사항은 서버에 연결할 때 표시할 텍스트를 포함하는 파일의 이름이다. 설정된 경우 ftpd_banner 옵션에서 제공하는 배너 문자열을 재정의한다.
              Default: (none)
```

> /etc/vsftpd/vsftpd.conf 파일에 banner_file 키워드를 추가

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
banner_file 키워드가 vsftpd.conf 파일에 기본적으로 선언된것이 아니기 때문에 새로 추가시켜 줘야 한다.
최하단에 추가
#
# Sfecific Configuration
#
banner_file=/etc/vsftpd/banner.txt   
```

> 배너 파일 생성

[SERVER1]# vi /etc/vsftpd/banner.txt

```bash
배너파일 예시

==== Welcome to FTP.EXAMPLE.COM ====

       1. Site Goal
FTP(vsftpd) Program Test FTP

       2. Site Function
(1). FTP for Real User
(2). FTP for Anonymous User

       3. Warnning
- 이 사이트를 해킹하면 모종의 그룹에
  의해 보복 공격이 가해질것입니다.
- 이 사이트에서 얻은 지식을 악의적인
  목적으로 절대 사용하지 않을 것을 
  약속하여야 합니다.

+=======================================================+
|                                                       |
|        Welcome to server1.example.com                 | 
|                                                       |
|                                                       |
| This is the server1.example.com test server.          |
|                                                       |
| If you have not already done so, make sure            |
| you have read the Downloading/Installation,           |
| FAQ, and Disclaimer links on                          |
| http://www.example.com.                               |
|                                                       |
| This is a restricted access system. All               |
| tranfers are logged.  If you disagree                 |
| with this practice, log off now.                      |
|                                                       |
| Questions go to SeoungChan Baik at                    |
| the address given on server1.example.com              | 
|                                                       |
|                                                       |
+=======================================================+

-> 위의 내용을 복사하여 사용하면 된다.
-> 만약 한글에 대한 부분이 깨져서 나오는 부분이 있으면 UTF-8 언어를 변경하고 다시 수행한다.
   # export LANG=en_US.UTF-8     (# export LANG=ko_KR.UTF-8)
   # vi /etc/vsftpd/banner.txt

________________________
/                        \
|                        |
| 야 !! 공격하지마!!!    |
|                        |
\________________________/
  \
   \
     (__)
     (oo)______
     (__)      )\
        ||---||  *
        ||   ||

________________________
/                        \
|                        |
| 야 !! 공격하지마!!!    |  
|                        |
\________________________/
  \
   \ _____
    {~._.~}
     ( Y )
    ()~.~()
    (_)-(_)

,,)))))));,
              ))))))))))))));,
             (((((''''((((((((
            ((''  .     `)))))),
            | @    ;-.     (((((
            `|    /  )      )))/~~~~~~~~~~__\__---~~__--~~--_
             |   |   |       (/           /__-----~~  ,;::'  \
             o_);   ;        /           /           \,-~~~\  |
                   ;        (           /         `:::|      |;|
                  |   _      `----~~~~'      /      `:|       \;\
            ______/\/~                      /        /         \/
          /~;;.____/;;'  /          ___----(   `;;;/
         / //  _;______;'------~~~~~    |;;/\    /
        //  | |                        /  |  \;;,\
       (<_  | ;                      /',/-----'  _>
        \_| ||_                     //~;~~~~~~~~~
            `\_|                   (,~~

//|                              ,|
                           //,/                             -~ |
                         // / |                         _-~   /  ,
                       /'/ / /                       _-~   _/_-~ |
                      ( ( / /'                   _ -~     _-~ ,/'
                       \~\/'/|             __--~~__--\ _-~  _/,
               ,,)))))));, \/~-_     __--~~  --~~  __/~  _-~ /
            __))))))))))))));,>/\   /        __--~~  \-~~ _-~
           -\(((((''''(((((((( >~\/     --~~   __--~' _-~ ~|
  --==//////((''  .     `)))))), /     ___---~~  ~~\~~__--~
          ))| @    ;-.     (((((/           __--~~~'~~/
          ( `|    /  )      )))/      ~~~~~__\__---~~__--~~--_
             |   |   |       (/      ---~~~/__-----~~  ,;::'  \         ,
             o_);   ;        /      ----~~/           \,-~~~\  |       /|
                   ;        (      ---~~/         `:::|      |;|      < >
                  |   _      `----~~~~'      /      `:|       \;\_____//
            ______/\/~    |  SURPRISE!      /        /         ~------~
          /~;;.____/;;'  / PHSS_01111__----(   `;;;/
         / //  _;______;'------~~~~~    |;;/\    /
        //  | |                        /  |  \;;,\
       (<_  | ;                      /',/-----'  _>
        \_| ||_                     //~;~~~~~~~~~
            `\_|                   (,~~
```

> 변경 내용 적용 및 확인

**[SERVER1]# systemctl restart vsftpd**

vsftpd 데몬을 재 시작하여 변경된 서비스 내용을 적용시킨다.

[SERVER2]# ftp 192.168.10.200

```
Connected to 192.168.10.200 (192.168.10.200).
220-+=======================================================+
220-|                                                     	|
220-|        Welcome to server1.example.com                 |
220-|                                                 	|
220-|                                                 	|
220-| This is the server1.example.com test server.     	|
220-|                                                 	|
220-| If you have not already done so, make sure      	|
220-| you have read the Downloading/Installation,     	|
220-| FAQ, and Disclaimer links on                    	|
220-| http://www.example.com.                         	|
220-|                                                 	|
220-| This is a restricted access system. All         	|
220-| tranfers are logged.  If you disagree           	|
220-| with this practice, log off now.                	|
220-|                                                 	|
220-| Questions go to SeoungChan Baik at              	|
220-| the address given on server1.example.com          |
220-|                                                 	|
220-|                                               	  |
220-+=======================================================+
220 
Name (192.168.10.200:root):
```

[참고] 개정된 FTP 응답(FTP Response Code)

- 개정된 FTP 응답코드(Revised FTP Reply Codes)의 자세한 내용은 RFC_640 문서에서 찾아 볼 수 있다.
- RFC 사이트: **http://www.faqs.org/rfc/rfc640.txt** 참조

대표적인 FTP 응답코드는 다음과 같은 것이 있다.(RFC 문서 참조)

■ **220** Service ready for new user

■ **230**  User logged on, proceed

■ **331** User name okay, need password

■ **530** Not logged in

■ **221** Service closing TELNET connection (logged off if appropriate)

(복원) 테스트가 끝났다면 vsftpd.conf 파일의 설정을 복원한다.

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
#banner_file=/etc/vsftpd/banner.txt
```

**[SERVER1]# systemctl restart vsftpd**

### [EX2] Greeting 메세지 출력

```bash
ftpd_banner   이 문자열 옵션을 사용하면 연결이 처음 들어올 때 vsftpd가 표시하는 인사말 배너를 재정의할 수 있다.
              Default: (none - default vsftpd banner is displayed)
```

> /etc/vsftpd/vsftpd.conf 파일 수정

[SERVER1]# vi /etc/vsftpd/vsftpd.conf

```
1. 최하위행 모드에서 검색
/ftpd_banner 

# You may fully customise the login banner string:
#ftpd_banner=Welcome to blah FTP service.  <<< 해당 라인 확인
#

2. 주석 제거하고 확인이 가능하도록 문자열 추가
ftpd_banner=Welcome to blah FTP service. SOLDESK

```

**[SERVER1]# systemctl restart vsftpd**

> 서비스 변경 확인

**[SERVER2]# ftp 192.168.10.200**

```
Connected to 192.168.10.200 (192.168.10.200).
220 Welcome to blah FTP service. SOLDESK
```

(참고) Greeting or Banner 메세지 설정이 되지 않은 경우

```
변경전
[SERVER2]# ftp 192.168.10.200
Connected to 192.168.10.200 (192.168.10.200).
**220 (vsFTPd 3.0.3)**
Name (192.168.10.200:root): ^C

변경후
[SERVER2]# ftp 192.168.10.200
Connected to 192.168.10.200 (192.168.10.200).
**220 Welcome to blah FTP service. SOLDESK**
Name (192.168.10.200:root):
```

Banner 파일이나 메시지를 설정하지 않게 되면 vsftp의 `버전정보가 노출`이 된다. 

버전정보가 노출이 된다면 버전으로 검색된 취약점으로 공격이 가능하기에 버전정보를 숨기기 위해서라도 Banner설정을 필수다.

(복원) 테스트가 끝났다면 vsftpd.conf 파일의 설정을 복원한다. 

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
/ftpd_banner 최하위행 검색

#ftpd_banner=Welcome to blah FTP service. SOLDESK
```

**[SERVER1]# systemctl restart vsftpd**

(주의) ftpd_banner 설정과 banner_file 설정이 두개 다 설정 되어 있는 경우에는 banner_file에 지정된 내용이 출력된다.

### [EX3] FTP 사용자 chroot 구성

● FTP 사용자의 chroot 구성은 FTP 사용자가 서버에 로그인 한 경우에 자신의 홈디렉토리를 / (root) 디렉토리 인것 처럼 인식이 되어 자신의 홈 디렉토리 아래에 있는 디렉토리만 이동이 가능한 것이다.

```bash
chroot_local_user

              If set to YES, local users will be  (by  default)  placed  in  a
              chroot()  jail  in  their  home directory after login.  Warning:
              This option has security implications, especially if  the  users
              have upload permission, or shell access. Only enable if you know
              what you are doing.  Note that these security  implications  are
              not  vsftpd  specific. They apply to all FTP daemons which offer
              to put local users in chroot() jails.

              Default: NO
```

> 기본 사항에서는 일반계정이 상위 디렉토리로 접근이 가능한지 확인

**[SERVER2]# ftp 192.168.10.200**

```
Connected to 192.168.10.200 (192.168.10.200).
220 (vsFTPd 3.0.3)
Name (192.168.10.200:root): user02
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> **pwd**
257 "/home/user02" is the current directory
ftp> **cd /etc**
250 Directory successfully changed.
ftp> **pwd**
257 "/etc" is the current directory
ftp> **ls -l**
227 Entering Passive Mode (192,168,10,200,211,174).
150 Here comes the directory listing.
-rw-r--r--    1 0        0            4536 Jun 10 15:51 DIR_COLORS
-rw-r--r--    1 0        0            5214 Jun 10 15:51 DIR_COLORS.256color
-rw-r--r--    1 0        0            4618 Jun 10 15:51 DIR_COLORS.lightbgcolor
-rw-r--r--    1 0        0              94 May 11  2019 GREP_COLORS
drwxr-xr-x    7 0        0             134 Jul 14 16:16 NetworkManager
drwxr-xr-x    6 0        0              70 Jul 14 12:36 X11
-rw-r--r--    1 0        0              16 Jul 14 12:38 adjtime
-rw-r--r--    1 0        0            1529 Apr 06 23:31 aliases
...
ftp> **get passwd**
local: passwd remote: passwd
227 Entering Passive Mode (192,168,10,200,110,187).
150 Opening BINARY mode data connection for passwd (1305 bytes).
226 Transfer complete.
1305 bytes received in 0.000267 secs (4887.64 Kbytes/sec)
ftp> **!ls**
anaconda-ks.cfg  passwd
ftp> **by**
[SERVER2]# **ls**
anaconda-ks.cfg  **passwd**
```

기본적으로 인증된 사용자라면 권한(퍼미션)이 되는 범위안에서 다른 디렉토리로 이동이 가능하다. 하지만 디렉토리 이동이 가능하다면 디렉토리안의 내용을 살펴 볼수 있기 때문에 보안상 좋지 않다.

> vsftpd.conf 파일 설정 수정

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
하단에 추가
chroot_local_user=YES
allow_writeable_chroot=YES 
```

chroot_local_user 기능이 vsftpd.conf 파일에 기본적으로 선언된것이 아니기 때문에 새로 추가 시켜 줘야 한다.

**[SERVER1]# systemctl restart vsftpd**

**[SERVER2]# ftp 192.168.10.200**

```
Connected to 192.168.10.200 (192.168.10.200).
220 (vsFTPd 3.0.3)
Name (192.168.10.200:root): **root**
331 Please specify the password.
Password:
500 OOPS: vsftpd: refusing to run with writable root inside chroot()
Login failed.
421 Service not available, remote server has closed connection
ftp> exit
```

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
하단에 추가
allow_writeable_chroot=YES 
```

**[SERVER1]# systemctl restart vsftpd**

**[SERVER2]# ftp 192.168.10.200**

```
Connected to 192.168.10.200 (192.168.10.200).
220 (vsFTPd 3.0.3)
Name (192.168.10.200:root): **root**
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> pwd
**257 "/" is the current directory**
ftp>
```

인증을 통해 접속하는 모든 사용자들은 chroot 구성 적용을 받는다.
(주의) 이 설정은 root 사용자에게도 적용이 된다. 보안상 권장하는 설정이다.

(복원) 테스트가 끝났다면 vsftpd.conf 파일의 설정을 복원한다. 

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
하단에 주석처리
#chroot_local_user=YES
#allow_writeable_chroot=YES
```

### [EX4] FTP 서버에 접근 사용자 제한

```
userlist_deny 
userlist_enable이 활성화된 경우 이 옵션을 검사한다. 이 설정을 NO로 설정하면 userlist_file에서 지정한 파일에 명시적으로 나열되지 않는 한 로그인이 거부된다. 로그인이 거부되면 사용자에게 비밀번호를 요청하기 전에 거부가 발생한다.

**Default: NO**

userlist_enable
vsftpd가 활성화된 경우 userlist_file에서 지정한 파일 이름에서 사용자 이름 목록을 로드한다.  사용자가 이 파일의 이름을 사용하여 로그인을 시도하면 암호를 요청받기 전에 로그인이 거부된다. 이것은 클리어텍스트 암호가 전송되는 것을 방지하는 데 유용할 수 있다. userlist_deny를 참조하십시오.

**Default: YES**

(userlist_deny=YES) 두개의 파일 중 한개의 파일에라도 사용자가 정의되어 있으면 FTP 로그인 할 수 없다.
- /etc/vsftpd/ftpusers 
- /etc/vsftpd/user_list

(userlist_deny=NO) user_list 파일에 존재하는 사용자만 FTP 로그인을 할 수 있다.
- /etc/vsftpd/ftpusers
- /etc/vsftpd/user_list 
```

> /etc/vsftpd/user_list 파일 내용 수정

**[SERVER1]# cat /etc/vsftpd/user_list**

```
# vsftpd userlist
# If userlist_deny=NO, only allow users in this file
# If userlist_deny=YES (default), never allow users in this file, and
# do not even prompt for a password.
# Note that the default vsftpd pam config also checks /etc/vsftpd/ftpusers
# for users that are denied.
#root
bin
daemon
adm
lp
sync
shutdown
halt
mail
news
uucp
operator
games
nobody
```

> /etc/vsftpd/vsftpd.conf 파일에 userlist_deny 기능 추가

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
문서의 마지막 라인에 추가
userlist_deny=NO
```

**[SERVER1]# systemctl restart vsftpd**

> /etc/vsftpd/user_list 파일에 user01 사용자 추가 및 테스트

**[SERVER1]# vi /etc/vsftpd/user_list**

```
문서의 마지막 라인에 추가
user01
```

**[SERVER2]# ftp 192.168.10.200**

```
Connected to 192.168.10.200 (192.168.10.200).
220 (vsFTPd 3.0.3)
Name (192.168.10.200:root): user01
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp>
```

user01 사용자는 로그인이 가능하다.

**[SERVER2]# ftp 192.168.10.200**

```
Connected to 192.168.10.200 (192.168.10.200).
220 (vsFTPd 3.0.3)
Name (192.168.10.200:root): root
530 Permission denied.
Login failed.
ftp> by
221 Goodbye.
```

root 사용자라도 파일에 허용이 되어 있지 않다면 접속이 불가능 하다.

> FTP의 사용자 제한을 하는 경우

```
# cat /etc/vsftpd/user_list 
root
wasuser
oracle

# vi /etc/vsftpd/vsftpd.conf 
userlist_enable=YES 
userlist_deny=NO 
```

(복원) 테스트가 끝났다면 vsftpd.conf 파일의 설정을 복원한다. 

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
#userlist_deny=NO
```

**[SERVER1]# systemctl restart vsftpd**

**[SERVER1]# vi /etc/vsftpd/user_list**

```
user01 삭제
```

### [EX5] 익명사용자(Anonymous) FTP 구성

- vsFTP 프로그램이 설치 되어 있으면 기본적으로 익명사용자 FTP가 구성되어 있다.
- 익명 FTP 서버는 보통 다운로드는 가능하지만 업로드는 가능하지 않다.
- 익명 FTP 서버에서 익명 사용자가 파일을 업로드 할 수 있도록 설정하기 위해서는 conf 파일에 설정에 다음과 같은 설정이 필요하다. **# cat /etc/vsftpd/vsftpd.conf**  anon_upload_enable=YES ..... anon_mkdir_write_enable=YES
- 익명 사용자의 파일 업로드는 보안상 권장하지는 않는 설정이다.

> 익명사용자 FTP 디렉토리 확인

**[SERVER1]# cd /var/ftp/**

**[SERVER1]# ls -l**

```
drwxr-xr-x 2 root root 4.0K Dec 16 10:28 pub
```

**[SERVER1]# mkdir /var/ftp/pub/test**

**[SERVER1]# cp /etc/passwd /var/ftp/pub/test**

**[SERVER2]# ftp 192.168.10.200**

```
Connected to 192.168.10.200 (192.168.10.200).
220 (vsFTPd 3.0.3)
Name (192.168.10.200:root): anonymous
331 Please specify the password.
Password:
530 Login incorrect.
Login failed.
```

로그인 실패

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
anonymous_enable=YES
anon_mkdir_write_enable=YES
```

**[SERVER1]# systemctl restart vsftpd**

**[SERVER2]# ftp 192.168.10.200**

```
Connected to 192.168.10.200 (192.168.10.200).
220 (vsFTPd 3.0.3)
Name (192.168.10.200:root): **anonymous**
331 Please specify the password.
Password: [E-mail 형식으로 작성] 111@example.com
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> **cd pub**
250 Directory successfully changed.
ftp> **cd test**
250 Directory successfully changed.
ftp> **ls**
227 Entering Passive Mode (192,168,10,200,169,149).
150 Here comes the directory listing.
**-rw-r--r--    1 0        0            1305 Jul 28 01:16 passwd**
226 Directory send OK.
ftp> **get passwd**
local: passwd remote: passwd
227 Entering Passive Mode (192,168,10,200,181,219).
150 Opening BINARY mode data connection for passwd (1305 bytes).
**226 Transfer complete.**
1305 bytes received in 0.000137 secs (9525.55 Kbytes/sec)
ftp>
```

```
ftp> cd /
250 Directory successfully changed.
ftp> pwd
257 "/" is the current directory
ftp> ls
227 Entering Passive Mode (192,168,10,200,152,27).
150 Here comes the directory listing.
drwxr-xr-x    3 0        0              18 Jul 28 01:16 pub
226 Directory send OK.

익명사용자 계정도 chroot 구성이 되어 있다.
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1f89407e-4bae-45d9-90ec-af9b3681d0a8/_2020-04-09__4.07.18.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1f89407e-4bae-45d9-90ec-af9b3681d0a8/_2020-04-09__4.07.18.png)

웹브라우저에서도 FTP를 사용 가능 하다.

### [EX6] FTP 포트 변경

- vsFTP 서버에서 사용하는 FTP 서버용 포트는 기본값으로 21로 지정되어 있다.
- "listen_port" 키워드를 사용하여 FTP 서버용 포트를 다른 포트로 지정할 수 있다.
- 이 설정을 사용하는 경우는 기본적인 포트번호를 다른것으로 변경해서 사용해야 하는 환경에서 유용하다.

```bash
listen_port  
            vsftpd가 독립 실행형 모드인 경우, 이것은 수신 FTP 연결을 위해 수신 대기할 포트다.

              Default: 21
```

```bash
----- FTP Client -----		----- FTP Server -----

	# ftp <FTP Server>      -----------> vsftpd(21)
	# ftp <FTP Server> <Port>          /etc/vsftpd/vsftpd.conf

	PORT : /etc/services   (# grep ftp /etc/services)
```

> FTP 서버에서 포트 변경 및 적용

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
하단에 추가
listen_port=2121
```

**[SERVER1]# systemctl restart vsftpd**

**[SERVER1]# netstat -an | grep :21**

```
tcp6       0      0 :::2121                 :::*                    LISTEN
```

**[SERVER2]# ftp 192.168.10.200**

```
ftp: connect: 연결이 거부됨
ftp> exit
```

**[SERVER2]# ftp 192.168.10.200 2121**

```
ftp: connect: 호스트로 갈 루트가 없음
ftp>
```

**[SERVER1]# firewall-cmd --permanent --add-port=2121/tcp**

**[SERVER1]# firewall-cmd --permanent --remove-service=ftp**

**[SERVER1]# firewall-cmd --reload**

**[SERVER2]# ftp 192.168.10.200 2121**

```
Connected to 192.168.10.200 (192.168.10.200).
220 (vsFTPd 3.0.3)
Name (192.168.10.200:root):
```

(복원) 테스트가 끝났다면 vsftpd.conf 파일의 설정을 복원한다.

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
# listen_port=2121
```

**[SERVER1]# systemctl restart vsftpd**

### [EX7] vsFTP 서버에 접속할 수 있는 사용자 수 제한

- vsFTP 서버에서 FTP 서버에 접속할 수 있는 사용자 수는 기본값으로 unlimit 이다.
- vsFTP 서버에서 max_clients를 사용하여 최대로 접속할 수 있는 클라이언트의 개수를 제한할 수 있다.
- 이 설정은 서버에서 반드시 설정할 것을 권장한다.

```bash
max_clients   vsftpd가 독립 실행형 모드인 경우, 이것은 연결될 수 있는 최대 클라이언트 수입니다. 연결하는 추가 클라이언트는 오류 메시지를 받게 된다.

              Default: 0 (unlimited)
```

최대 클라이언트 수의 지정

현재 메모리 여유량 확인

다운로드 , 업로드시 메모리 사용량 체크

사용량에 대비하여 유저수 제한

> FTP 서버에 접속할 수 있는 최대 클라이언트 개수 지정

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
하단에 추가
max_clients=3  
```

**[SERVER1]# systemctl restart vsftpd**

접속 테스트를 하다보면 3번의 연결까지는 정상적으로 이루어 지는것을 확인 가능하다.

이후 4번째 접속부터는 접속이 불가능하다.

```
[SERVER2]# ftp 192.168.10.200
Connected to 192.168.10.200 (192.168.10.200).
**421 There are too many connected users, please try later.**
ftp>
```

root 사용자도 접속수 제한에 걸리게 되면, FTP 서버에 들어 올수 없다.

(복원) 테스트가 끝났다면 vsftpd.conf 파일의 설정을 복원한다. 

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
#max_clients=3 
```

**[SERVER1]# systemctl restart vsftpd**

### [EX8] 한개의 아이피에 대한 전송 제한

```bash
max_per_ip    vsftpd가 독립 실행형 모드인 경우, 이것은 동일한 소스 인터넷 주소에서 연결될 수 있는 최대 클라이언트 수입니다. 클라이언트가 이 제한을 초과하면 오류 메시지가 표시됨.

              Default: 0 (unlimited)
```

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
하단에 추가
max_per_ip=3  
```

**[SERVER1]# systemctl restart vsftpd**

이후 접속을 테스트 해보면 한 IP에서 3번의 접속까지는 정상적이지만 4번재 부터는 오류가 출력된다.

```
Connected to linuxXXX.example.com.
421 There are too many connections from your internet address.
ftp> quit
```

root 사용자도 접속수 제한에 걸리게 되면, FTP 서버에 들어 올수 없다.

> max_clients, max_per_ip 동시 적용

```
max_client 개수의 제한이 필요하며, 개수의 제한은 서버의 H/W 사양에 비례한다.
# cat /etc/vsftd/vsftpd.conf
	..... 
	max_clients=100
	max_per_ip=3

```

(복원) 테스트가 끝났다면 vsftpd.conf 파일의 설정을 복원한다. 

**[SERVER1]# vi /etc/vsftpd/vsftpd.conf**

```
#max_per_ip=3  
```

**[SERVER1]# systemctl restart vsftpd**

### [EX9] 익명사용자 FTP 서버에 파일 업로드 기능 설정 < 사실 거의 안씀

Anonymous FTP 서버에 파일 업로드 기능 설정

◾ 업로드 디렉토리(EX: /var/pub/incoming) 퍼미션 설정

◾ /etc/vsftpd/vsftpd.conf 파일 설정

◾ anon_upload_enable=YES

◾ chown_uploads=YES

◾ chown_username=ftpupload

```bash
① /var/pub/incoming 디렉토리 생성 및 퍼미션 설정
# cd /var/ftp/pub 
# mkdir incoming 
# chmod 603 incoming    (-rw-----wx root root)

② ftpupload 사용자 추가
# useradd -d /var/ftp/pub/incoming -r -s /sbin/nologin ftpupload 
#
       -d, --home HOME_DIR
          The new user will be created using HOME_DIR as the value for the
          user's login directory. The default is to append the LOGIN name
          to BASE_DIR and use that as the login directory name. The
          directory HOME_DIR does not have to exist but will not be
          created if it is missing.

       -r This flag is used to create a system account. That is, a user
          with a UID lower than the value of UID_MIN defined in
          /etc/login.defs and whose password does not expire. Note that
          useradd will not create a home directory for such an user,
          regardless of the default setting in /etc/login.defs. You have
          to specify -m option if you want a home directory for a system
          account to be created. This is an option added by Red Hat

       -s, --shell SHELL
          The name of the user's login shell. The default is to leave this
          field blank, which causes the system to select the default login
          shell.

③ 주 설정 파일 설정 및 변경 사항 적용
# vi /etc/vsftpd/vsftpd.conf 

[수정전]
#anon_upload_enable=YES
..... (중략) .....
#chown_uploads=YES
#chown_username=whoever
[수정후]
anon_upload_enable=YES
..... (중략) .....
chown_uploads=YES
chown_username=ftpupload

# service vsftpd restart 
-> 변경 사항 적용

④ 설정 확인
# ftp localhost 
	Connected to localhost.localdomain.
	220 (vsFTPd 2.0.5)
	530 Please login with USER and PASS.
	530 Please login with USER and PASS.
	KERBEROS_V4 rejected as an authentication type
	Name (localhost:root): ftp              (ftp   or   anonymous)
	331 Please specify the password.
	Password: (id@paran.com)
	230-All the good stuff is in /pub
	230 Login successful.
	Remote system type is UNIX.
	Using binary mode to transfer files.
	ftp> cd pub/incoming 
	250 Directory successfully changed.
	ftp> put 
	(local-file) /etc/passwd 
	(remote-file) passwd 
	local: /etc/passwd remote: passwd
	227 Entering Passive Mode (127,0,0,1,253,101)
	150 Ok to send data.
	226 File receive OK.
	2043 bytes sent in 6.2e-05 seconds (3.2e+04 Kbytes/s)
	ftp> ls
	227 Entering Passive Mode (127,0,0,1,255,171)
	150 Here comes the directory listing.
	226 Transfer done (but failed to open directory).
	ftp> quit
	221 Goodbye.

# ls –l /var/ftp/pub/incoming 
-rw------- 1 ftpupload ftp 2043 Oct 18 13:53 passwd

(복원) 테스트가 끝났다면 vsftpd.conf 파일의 설정을 복원한다. 
# vi /etc/vsftpd/vsftpd.conf 

#anon_upload_enable=YES
..... (중략) .....
#chown_uploads=YES
#chown_username=whoever
```

# FTP 보안

INDEX

**----------------------------**

■ FTP 보안 개요

■ FTP 호스트 제한

■ FTP 사용자 제한

■ FTP 프로그램 업데이트/패치

■ FTP 포트관리

**----------------------------**

(1) FTP 보안 개요

FTP 보안에 관한 기본적인 개념은 다음과 같은 것들에 관해 깉이 있게 살펴 보는 것이다.

**■ FTP 호스트 제한**

**■ FTP 사용자 제한**

**■ FTP 프로그램 업데이트 & 패치**

**■ 포트 관리**

위와 같은 것들에 관해 항상 관심을 가지고 모니터링을 해야 한다. 서비스에 접근할 수 있는 호스와 접근할 수 없는 호스트 설정, 서비스를 받을 수 있응 사용자와 받을 수 없는 사용자의 구별, 버그 패치를 위한 프로그램 업데이트와 보안 패치 적용, FTP 서비스 포트 변경 및 쓰지 않는 포트 차단등 보안에 관련한 사항이 FTP 서버관리자의 중요한 역할 중 한가지이다.

다음은 FTP 서버의 호스트 제한과 사용자에 대한 제한등에 대한 전체적인 그림이다.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/949ba2e2-910f-411a-b4a6-791d14bd61df/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/949ba2e2-910f-411a-b4a6-791d14bd61df/Untitled.png)

○ FTP 서버에서 호스트에 관한 제한을 두는 설정 : Firewall(EX: iptables), tcp_wrapper

○ FTP 서버에서 사용자에 관한 제한을 두는 설정 : /etc/vsftpd/ftpusers, /etc/vsftpd/user_list

■ FTP 서버에서 호스트에 관한 제한을 두는 설정

CentOS 5.4 버전에서 Firewall 기능을 하는 iptable 설정을 통해 들어 서버 방화벽이나 네트워크 방화벽을 구축할 수 있다. tcp_wrapper는 /etc/hosts.allow, /etc/hosts.deny 파일을 가지고 간단한 제어를 할 수 있다.

■ FTP 서버에서 사용자에 제한을 두는 설정

/etc/vsftpd/ftpusers, /etc/vsftpd/user_list 파일에 서비스를 받지 못할 사용자를 등록 한다.

(2) FTP 호스트 제한

외부에서 접근하는 많은 FTP 클라이언트를 제어 하는 것은 성능상, 보안상 서버 관리자에 역할 중 한가지이다. 특정 지역의 IP 대역에 존재하는 그룹은 서비스를 막고 또는 특정 지역의 IP 대역에 존재하는 그룹은 서비스로 열어 주는 설정은 일반적으로 tcp_wrapper을 통해 제어한다.

이 문서는 Firewall(iptables)에 대해 설명하고 있지 않다.

(2-1) tcp_wrapper을 통한 FTP 서버 제한

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/81fa1c53-531a-41ec-8552-be1d4e41b5cf/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/81fa1c53-531a-41ec-8552-be1d4e41b5cf/Untitled.png)

tcp_wrapper (**/usr/share/doc/tcp_wrappers-7.6**)

- tcp_wrapper는 finger, ftp, telnet, rlogin, rsh, exec, tftp, talk, comsat등의 네트워크 서비스를 필터링 할 수 있는 프로그램이다.
- /usr/sbin/tcpd 데몬에 의해서 TCP 서비스를 제어 하는 역할을 가지고 있다.
- TCP 제어를 위해서는 /etc/hosts.allow, /etc/hosts.deny 파일을 가지고 설정한다.  **(Rule 적용 순서)** - /etc/hosts.allow 파일에 정의된것은 허용이 되고,  - 만약 정의 되지 않은 내용이 있다면, /etc/hosts.deny 파일에 정의된것은 거부가 되고,  - 만약 정의 되지 않은 내용이 있다면, 허용된다.

     **------> tcpd ---+----> ① /etc/hosts.allow(Allow)**
                               **|**  
                              **+----------------------------> ②** **/etc/hosts.deny(Deny)**  
                               **|**  
                              **+--------------------------------------------------> ③** **(Allow)**  

- tcp_wrapper는 Firewall(iptable)과 비교하였을때 성능을 떨어트리지 않는 장점을 가지고 있다. 빠르게 tcp 방식의 서비스를 제어할 수 있는 장점을 가지고 있다.
- **(권장)** 이 파일에 설정할 때 시스템이름이나 도메인 이름을 사용하지 말고 IP주소를 사용할 것을 권장합니다.
- **(권장)** 또한, /etc/hosts.deny 파일에는 deny ALL로 설정한 후 접속을 허용할 주소만 /etc/hosts.allow 파일에 기록할것을 권장한다.
- **(주의)** 2개의 설정파일(EX: hosts.allow, hosts.deny)에 정의를 할 때 저장하는 즉시 유효하므로 작성시에 주의하여야 합니다. (서비스를 restart 하는 방법이 아니므로 주의해야 한다.)
- 2개의 설정 파일에 정의하는 방식은 다음과 같습니다. **# cat /etc/hosts.allow (# cat /etc/hosts.deny)** <데몬이름>: <Source IP주소 or 네트워크 or 이름>::[옵션]

다음은 tcp_wrapper을 통한 FTP 서버를 제한하는 예이다.

```bash
# cat /etc/vsftpd/vsftpd.conf | grep tcp_wrappers 
tcp_wrappers=YES

-> vsftpd 프로그램은 기본적으로 tcp_wrappers의 기능을 사용하고 있기 때문에 /etc/vsftpd/vsftpd.conf 파일을 살펴 보면 tcp_wrappers는 YES로 설정되어 있다.
```

```bash
# vi /etc/hosts.allow 
	#
	# hosts.allow   This file describes the names of the hosts which are
	#               allowed to use the local INET services, as decided
	#               by the '/usr/sbin/tcpd' server.
	#
	vsftpd: LOCAL, 172.16.9.1XX 
	
	-> vsftpd: 	vsftpd 데몬에 대해서
	-> LOCAL 	자신의 IP
	-> 192.168.0.240	허용할 IP
	
	# vi /etc/hosts.deny 
	
	#
	# hosts.deny    This file describes the names of the hosts which are
	#               *not* allowed to use the local INET services, as decided
	#               by the '/usr/sbin/tcpd' server.
	#
	# The portmap line is redundant, but it is left to remind you that
	# the new secure portmap uses hosts.deny and hosts.allow.  In particular
	# you should know that NFS uses portmap!
	vsftpd: ALL
-> vsftpd:	vsftpd 데몬에 대해서
-> ALL		모든 지역의 IP 차단

	■ (172.16.9.252) # ftp 172.16.9.2XX 
	■ (172.16.9.1XX) # ftp 172.16.9.2XX 

(tcp_wrappers을 사용하는 다른예) /etc/hosts.allow 파일에 정의한 예라고 생각한다.

ALL: localhost, .yahoo.com
● localhost와 yahoo.com 도메인 이름을 가진 모든 호스트에게 서비스를 허용한다.

vsftpd: 192.168.0.2, 192.168.0.3, 192.168.1., 172.16.
● 192.168.0.2, 192.168.0.3, 192.168.1.0, 172.16.0.0 호스트/네트워크에 대한 서비스를 허용한다.

ALL: .daum.net EXCEPT killer.daum.net
● daum.net 도메인 중 killer.daum.net 호스트를 제외한 모든 호스트에 대한 서비스를 허용한다. 

ALL EXCEPT in.ftpd: .paran.com EXCEPT cafe.paran.com
● inftpd 데몬을 제외한 모든 서비스들에 대해 cafe.paran.com 호스트를 제외한 모든 paran.com 호스트를 허용한다.

ALL: ALL: DENY
● 모든 서비스(데몬)에 대해 모든 호스트들의 서비스는 거부된다. 

ALL: 192.168.0.0/24, 192.168.1.0/255.255.255.0
● 모든 서비스를 192.168.0.0/24, 192.168.1.0/24 네트워크들에 대해서 서비스를 허용한다.

(복원) /etc/hosts.allow, /etc/hosts.deny 파일 복원
# vi /etc/hosts.allow
-> 주석처리
# vi /etc/hosts.deny
-> 주석처리
```

(2-2) 클라이언트의 접속 수 제한

■ max_clients 접속할 수 있는 클라이언트의 개수 지정

■ max_per_ip 한개의 IP에 대해서 몇번의 커넥션을 이룰수 있는 것인지를 지정

**(참고)** vsftpd 데몬은 아쉽게도 클라이언트가 접속시 IDLE TIME 제어 할 수 있는 설정이 없다.

```bash
# vi /etc/vsftpd/vsftpd.conf 
..... (중략) .....
max_clients=200
max_per_ip=2

[참고] max_clients 개수의 산정
● max_clients의 개수는 서버의 자원(CPU, MEM, DISK, Network)에 따라서 결정할 수 있다.

[TERM1] 테스트용 윈도우1
# pgrep –lf vsftpd 
8868 /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf

# ftp localhost 
user01 사용자로 로그인

[TERM2] 테스트용 윈도우2
# pgrep -lf vsftpd 
8868  /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf
10262 /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf
10265 /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf

# pmap 8868 
..... (중략) .....
00002b0480fab000   2048K -----  /lib64/libsepol.so.1
00002b04811ab000      4K rw---  /lib64/libsepol.so.1
00002b04811ac000     48K rw---    [ anon ]
00002b0499578000    132K rw---    [ anon ]
00007fff1d94a000     84K rw---    [ stack ]
00007fff1d9fd000     12K r-x--    [ anon ]
ffffffffff600000   8192K -----    [ anon ]
 total            52488K
-> 8868(vsftpd) 데몬 하나가 약 5M 정도의 메모리 공간을 사용한다.
-> 한명의 FTP 사용자가 접속할 때 마다 vsftpd 데몬이 2개(한개당 5M 정도씩) 뜨게 되는 것이다.

# pmap `pgrep vsftpd` | grep total 
 total            52488K
 total            54580K
 total            54604K

# top     (# top -n 1 | grep Mem:)
Tasks: 157 total,   1 running, 155 sleeping,   0 stopped,   1 zombie
Cpu(s):  1.6%us,  0.7%sy,  0.0%ni, 97.4%id,  0.0%wa,  0.2%hi,  0.1%si,  0.0%st
Mem:   1035032k total,   519328k used,   515704k free,    32448k buffers
Swap:  1052248k total,        0k used,  1052248k free,   365828k cached
..... (중략) .....

-> 전체 메모리 : 1035032KB
-> 사용중인 메모리 : 519328KB
-> 남은 메모리 공간: 515704KB

1035032KB * (80/100) * {(남은메모리) * (80/100)}
```

(3) FTP 사용자 제한

```bash
FTP 서버에 접속하는 사용자를 제한하기 위해서는 /etc/vsftpd/user_list, /etc/vsftpd/ftpusers 파일을 사용할 수 있다. 
특정한 사용자만 FTP 서버에 접속할수 있도록 하기 위해서는 다음과 같은 2가지 방법이 있다.

(첫번째 방법) 기본설정을 사용하는 경우
# cat /etc/vsftpd/vsftpd.conf 
..... (중략) .....
userlist_deny=YES
..... (중략) .....
-> userlist_deny의 기본값은 YES 입니다.(정의하지 않으면 YES 입니다.)
# awk -F: '{print $1}' /etc/passwd > /etc/vsftpd/ftpusers  (ftpusers or user_list)
# cat /etc/vsftpd/ftpusers 
..... (중략) .....
user01
user02
#ftpuser         # FTP Upload User

(두번째 방법) userlist_deny=NO 설정을 사용하는 경우
# cat /etc/vsftpd/vsftpd.conf 
..... (중략) .....
userlist_deny=NO
..... (중략) .....
# cat /etc/vsftpd/user_list 
ftpuser
```

```bash
FTP 서버에 접속하는 사용자를 제한하기 위해서는 /etc/vsftpd/user_list, /etc/vsftpd/ftpusers 파일을 사용할 수 있다. 
특정한 사용자만 FTP 서버에 접속할수 있도록 하기 위해서는 다음과 같은 2가지 방법이 있다.

(첫번째 방법) 기본설정을 사용하는 경우
# cat /etc/vsftpd/vsftpd.conf 
..... (중략) .....
userlist_deny=YES
..... (중략) .....
-> userlist_deny의 기본값은 YES 입니다.(정의하지 않으면 YES 입니다.)
# awk -F: '{print $1}' /etc/passwd > /etc/vsftpd/ftpusers  (ftpusers or user_list)
# cat /etc/vsftpd/ftpusers 
..... (중략) .....
user01
user02
#ftpuser         # FTP Upload User

(두번째 방법) userlist_deny=NO 설정을 사용하는 경우
# cat /etc/vsftpd/vsftpd.conf 
..... (중략) .....
userlist_deny=NO
..... (중략) .....
# cat /etc/vsftpd/user_list 
ftpuser
```

(4) FTP 프로그램 패치/업데이트

(4-1) vsftpd 프로그램 다운로드

vsftpd 프로그램에 대한 안전한(**신뢰할 수 있는**) 프로그램을 제공하는 사이트이다.

- **redhat.com**
- **suse.com**
- **debian.org**
- openbsd.org
- freebsd.org
- **gnu.org**
- gnome.org
- kde.org
- **kernel.org**
- **net**
- linux.org.uk
- gimp.org
- ftp-stud.fht-esslingen.de
- tuwien.ac.at
- sunet.se
- ximian.com
- engardelinux.org
- sunsite.org.uk
- isc.org

(4-2) vsftpd 프로그램 업데이트

```bash
(참고) 필요하면 /etc/resolv.conf 파일 변경

# yum list | grep vsftpd
# rpm -qa | grep vsftpd
# yum -y update vsftpd
```

(4-3) vsftpd 보안 권고

■ security blog: **http://scarybeastsecurity.blogspot.com/**

■ security advisories: **http://www.scary.beasts.org/security/**

■ ProFTPd suffers serious security hole(**http://www.iss.net/threats/ThreatList.php**) - Sep 2003

■ wu-ftpd suffers serious security hole

(**http://cve.mitre.org/cgi-bin/cvename.cgi?name=CAN-2003-0466**) - Jul 2003.

■ lukemftpd (as a random example from many), via trust of realpath(), suffers serious security hole

(**ftp://ftp.netbsd.org/pub/NetBSD/security/advisories/NetBSD-SA2003-011.txt.asc**)- Aug 2003.

(4-4) 보안 취약점

최신 정보는 아니지만 상당히 도움이 되는 정보이다.

http://www.scary.beasts.org/security/

(5) FTP 포트 관리

(5-1) FTP 서버/클라이언트 포트 연결 과정

FTP는 연결(Connection)을 이루는 포트와 데이터를 전송하는 포트가 있다. 2개의 포트를 사용하는 서비스이다. 포트를 서비스에 사용하는 방식은 2가지가 있는데 (ㄱ)패시브 모드(Passvie Mode)와 액티브 모드(Active Mode)로 구분한다. 기본은 액티브 모드 상태이다. 동작 모드를 변화 시키기위해서는 ftp 명령어의 -p 옵션이나 ftp 명령어의 서브 프롬프트에서 "passive" 명령어를 사용하면 된다. 동작은 다음과 같다.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/eeeb5db9-6c76-4cad-ad00-d6644545f400/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/eeeb5db9-6c76-4cad-ad00-d6644545f400/Untitled.png)

- **Active Mode(Default)**

① FTP Client opens command channel to server; tells server second port number to use

② FTP Server acknowledges

③ FTP Server opens data channel to clients second port as instructed

④ FTP Client acknowledges and data flows

- **Passive Mode**

① FTP Client opens command channel to FTP server and requests "passive" mode.

② FTP Server Allocates port for the data channel and transmits the port number to use for the data transmission

③ FTP Client opens the data channel on the specified port

④ FTP Server responds with okay to transmit and data begins to flow

패시브모드(Passive)는 파이어월(Firewall) 서버안쪽에 있는 FTP 클라이언트가 FTP 서버에 접속하여 데이터를 전송 할때 유용하게 사용될 수 있다. (man ftp 부분 중 passive 명령어 참조)

```bash
# man ftp 
/passive          <----- 최하위행 모드에서 passive 검색
       passive
              Toggle passive data transfer mode off.  In passive mode, the
              client initiates the data connection by  connecting  to  the
              data  port.   Passive  mode is often necessary for operation
              from behind firewalls which do not permit  incoming  connec-
              tions,  but may need to be disabled if you connect to an FTP
              server which does not support passive operation.
```

```bash
■ (Passive Mode FTP)
# ftp -d localhost    (-d: debug)
Connected to linuxXXX.example.com.
220 (vsFTPd 2.0.5)
ftp: setsockopt: Bad file descriptor
---> AUTH GSSAPI
530 Please login with USER and PASS.
---> AUTH KERBEROS_V4
530 Please login with USER and PASS.
KERBEROS_V4 rejected as an authentication type
Name (localhost:root): root
---> USER root
331 Please specify the password.
Password: (사용자 암호 입력)
---> PASS XXXX
230 Login successful.
cmds.c:276: verbose=1 debug=1 overbose=1
---> SYST
215 UNIX Type: L8
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
---> PASV
227 Entering Passive Mode (127,0,0,1,126,130)   /* 126 * 256 + 130 = 32386 */
---> LIST
150 Here comes the directory listing.
drwxr-xr-x    2 0        0            4096 Feb 28 17:11 Desktop
drwxr-xr-x    4 0        0            4096 Mar 03 16:23 ENV
drwxr-xr-x    6 0        0            4096 Mar 06 06:12 SERVER
drwxr-xr-x    2 0        0            4096 Feb 23 15:59 backup
drwxr-xr-x    2 0        0            4096 Mar 08 16:10 bin
drwxr-xr-x    3 0        0            4096 Mar 02 18:28 home
-rw-------    1 0        0            3705 Mar 02 15:50 mbox
drwxr-xr-x    2 0        0            4096 Mar 07 12:10 packet
drwxr-xr-x    2 0        0            4096 Feb 23 16:57 test
226 Directory send OK.
ftp> quit
---> QUIT
221 Goodbye.

■ (Active Mode FTP)
# ftp -d localhost 
Connected to linuxXXX.example.com.
220 (vsFTPd 2.0.5)
ftp: setsockopt: Bad file descriptor
---> AUTH GSSAPI
530 Please login with USER and PASS.
---> AUTH KERBEROS_V4
530 Please login with USER and PASS.
KERBEROS_V4 rejected as an authentication type
Name (localhost:root): root
---> USER root
331 Please specify the password.
Password: (사용자 암호 입력)
---> PASS XXXX
230 Login successful.
cmds.c:276: verbose=1 debug=1 overbose=1
---> SYST
215 UNIX Type: L8
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> passive 
Passive mode off.
ftp> ls
---> PORT 127,0,0,1,203,199         /* 203 * 256 + 199 = 52167 */
200 PORT command successful. Consider using PASV.
---> LIST
150 Here comes the directory listing.
drwxr-xr-x    2 0        0            4096 Feb 28 17:11 Desktop
drwxr-xr-x    4 0        0            4096 Mar 03 16:23 ENV
drwxr-xr-x    6 0        0            4096 Mar 06 06:12 SERVER
drwxr-xr-x    2 0        0            4096 Feb 23 15:59 backup
drwxr-xr-x    2 0        0            4096 Mar 08 16:10 bin
drwxr-xr-x    3 0        0            4096 Mar 02 18:28 home
-rw-------    1 0        0            3705 Mar 02 15:50 mbox
drwxr-xr-x    2 0        0            4096 Mar 07 12:10 packet
drwxr-xr-x    2 0        0            4096 Feb 23 16:57 test
226 Directory send OK.
ftp> quit
---> QUIT
221 Goodbye.
```

```bash
(실무 예) Active Mode/Passive Mode 사용에 대해서
                                  	|
<----------- Intranet -----------> 	| <----------- Internet -----------> 	
                                   	|
                                   	|
------ FTP Server ----	----- Firewall-----		------ FTP Client ------
	vsftpd(21,####)                 	|			# ftp Server
/etc/vsftpd/vsftpd.conf           	|
			                            	|
----------------------	-------------------		------------------------
(1) FTP 서버 구축                	  |
(2) 방화벽 서비스 오픈 요청      	  |
                                   	|
```

(5-2) FTP 서비스 포트 차단

만약 일반 서버에서 FTP 서비스를 사용하지 않는다면 포트를 사용할 수 없도록 막아 주는 것을 권장한다. Linux CentOS 5.4 시스템에서 기본적으로 vsftpd 프로그램이 설치 되어 있다.

```bash
만약 FTP 서비스 포트를 차단/허용하기 위해서는 다음과 같이 수행한다.
(현재) # service vsftpd stop    /* 현재 vsftpd 서비스를 disable     */
       # service vsftpd start   /* 현재 vsftpd 서비스를 enable      */
(부팅) # chkconfig vsftpd off   /* 부팅시에 vsftpd 서비스를 disable */
       # chkconfig vsftpd on    /* 부팅시에 vsftpd 서비스를 enable  */
```

(5-3) FTP 서비스 포트 변경

```bash
vsftpd 프로그램에서 FTP 서버 서비스용 포트를 변경하기 위해서는 listen_port 을 사용하면 된다.
만약 FTP 서버 서비스 포트를 2121 포트로 변경하기 위해서는 다음과 같이 수행한다.
# vi /etc/vsftpd/vsftpd.conf 
..... (중략) ......
listen_port=2121
 
# service vsftpd restart 
FTP 서버에서 서비스용 포트가 변경된 경우 FTP 클라이언트에서 접속할 때는 포트 번호를 변경하여 접속해야 한다.
(윈도우에서 알FTP 프로그램을 통해 리눅스 FTP 서버에 접속)
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9a38e97d-6bc7-40bf-bbce-1e57911e0a94/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9a38e97d-6bc7-40bf-bbce-1e57911e0a94/Untitled.png)

(5-4) 파일 업로드/다운로드 기록 확인

```bash
[TERM1] # tail -f /var/log/xferlog 
	Mon Apr 14 03:40:45 2014 1 127.0.0.1 2084 /test/file1 b _ o r root ftp 0 * c
	Mon Apr 14 03:41:54 2014 1 127.0.0.1 2084 /root/file1 b _ i r root ftp 0 * c
	
[TERM2]  # cp /etc/passwd /test/file1
	# ftp localhost 
	root 사용자로 로그인
	ftp> cd /test
	ftp> lcd /tmp

	ftp> bin
	ftp> hash
	ftp> prompt
	ftp> mget file1     /* /test/file1 --> /tmp/file1 */

	ftp> cd /root
	ftp> lcd /tmp
	ftp> mput file1     /* /tmp/file1 --> /root/file1 */
	ftp> quit
```
