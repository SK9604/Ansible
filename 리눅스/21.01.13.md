# DNS

```bash
# named-checkconf /etc/named.conf 
# named-checkconf /etc/named.rfc1912.zones 
#
-> namedcheckconf 명령어는 주설정 파일(/etc/named.rfc1912.zones)의 문법 점검 하는 명령어이다.
-> "# named-checkconf <주설정파일의이름>"
-> 아무런 메세지가 없으면 정상적으로 설정된것이다.
```

```bash
③ 힌트(Hint) 파일 생성
# cd /var/named 
# mv named.ca named.ca.old 
# vi named.ca
.                       86400   IN      NS      ns1.example.com.
ns1.example.com.        86400   IN      A       192.168.10.200
-> 기존의 힌트파일(EX: named.ca)은 백업을 받고 새로운 파일를 만든다. 
-> DNS을 chroot로 구성하여 동작시키는 경우에는 힌트파일의 소유자는 named로 되어 있어야 한다.

# ls -l named.ca
-rw-r--r--. 1 root root 128  4월  7 22:09 named.ca

실습을 위해 그냥 두고 진행한다.
```

```bash
④ 포워드 존(Forward-Zone) 파일 생성
# cd /var/named
# cp named.empty server.zone
# vi server.zone
[수정전]
$TTL 3H
@       IN SOA  @ rname.invalid. (
                                        0       ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      @
        A       127.0.0.1
        AAAA    ::1
[수정후]
$TTL **4**
@       IN SOA  **ns1.example.com. root.example.com.** (
                                        0       ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      @
        A       127.0.0.1
        AAAA    ::1
        **IN      NS      ns1
ns1     IN      A       192.168.10.200**
```

```bash
# named-checkzone example.com server.zone 
zone example.com/IN: loaded serial 0
OK
```

```bash
-> 'OK' 라고 나오면 정상적으로 설정된것이다.
-> "named-checkzone <Domain Name> <Zone File>"

--------------------------------------------------
Zone 파일에 정의 하는 라인 형식
[Domain]  [TTL]  CLASS  RecordType  Data

(a) [Domain]     example.com.    = @    = 
(b) [TTL] 우선순위 - 
직접 지정된 경우(EX: ns1   5  IN A 172.16.9.XXX) -> 네임서버가 하나가 아닌 여러개로 분산되어 잇는 경우에는 A 레코드에 우선순위를 부여하여 먼저 질의를 해줄 서버를 설정한다.
- $TTL 지정된 경우(EX: $TTL 4)
- SOA Record Type 부분의 TTL 필드로 지정된 경우
(c) CLASS    IN (Internet)
(d) RecordType    "[EX3] 도메인 등록" 실습 부분 참조
(e) Data    "[EX3] 도메인 등록" 실습 부분 참조
--------------------------------------------------

ZONE 파일 레코드
- Serial
2차 네임서버가 Zone 파일의 수정여부를 알 수 있도록 하기 위한 옵션입니다.
1차 네임서버와 2차 네임서버를 운영중 일때 1차 네임서버의 Zone 파일의 내용이 변경 되면 반드시 Serial 를 증가 시켜줘야 2차 네임서버가 자신의 현재 Serial 를 비교하여 값이 작다면 Zone 파일의 정보를 갱신을 하게 됩니다. 2차 네임서버를 사용하지 않는다면 Serial 은 의미가 없습니다.

- Refresh
1차 네임서버의 Zone 파일 수정 여부를 2차 네임서버가 검사를 하기위한 옵션입니다.
Zone 파일의 정보 변경이 잦을 경우 이 주기를 10800(3H)이하로 맞추어주는 것이 효과적이며 일반적으로는 43200(12H)정도가 적당합니다.

- Retry
2차 네임서버에서 1차 네임서버로 연결이 되지 않을 경우 재접속을 요구하는 옵션입니다.
Refresh 보다 적어야만 의미가 있기 때문에 주의를 요합니다.

- Expire
Secondary가 Expire에서 지정한 시간동안 primay에 연결하지 못 할 경우, 해당 도메인이 유효하지 않다고 보고, 해당 도메인에 대한 정보를 전송하지 않는 것 입니다.
이 값은 너무 낮게 설정하지 않는 것이 좋습니다.

- Minimum
제 3의 네임서버.. 즉, 다른 네임서버가 본 서버의 Zone 파일의 정보를 가지고 갔을 경우 그 정보에 대해 캐쉬에 살아있는 시간을 설정하는 것입니다. TTL(Time To Live )값이 명시되지 않은 레코드는 본 값을 기본으로 갖게되며 특정 레코드가 변경이 되었을 때, 이것이 다른 네임서버로 정보가 전달되어 업데이트가 되는 주기는 Minimum의 값을 기본으로 합니다. 일반적으로 10800(3H)가 적당합니다.
```

```bash
root.example.com.example.com
TTL -> Time to Live
	검색한 결과를 캐시에 저장하는데 있어서 어느정도의 시간동안 정보를 갱신하지 않고 그대로 사용할 것인지에 대한 시간
	TTL 시간이 길다면
	장점: 재요청이 적다.
	단점: 클라이언트가 변경을 하고 싶어도 TTL이 너무 길어지면 변경할 수 없는 상태가 된다.

SOA (Start Of Authority)
	시작 레코드
	DNS의 시작은 항상 SOA 레코드로부터 시작한다.
	SOA 레코드는 이 도메인이 네임서버에 인증된 데이터를 가지고 있다라는 것을 의미한다.(보안성을 가지고 있다는 의미가 아니다)
	해당 네임서버가 최적의 상태를 유지할 수 있도록 하는 것이 목적이다.
@ = domainname자체를 뜻한다.
	@ = example.com
	@ = /etc/named.rfc1912.zone파일 내부에서 설정한 zone 설정의 도메인 네임과 같은 문자열이라는 것을 알 수 있다.
SOA - 이 레코드가 SOA라는 것을 표시하고 해당 라인이 제일 중요하다.
ns1.example.com. - 현재 네임서버의 FQDN을 작성한다.
root.example.com. - 메일주소를 나타낸다
	원래 ID와 도메인 사이에는 @를 사용하는 형식이지만 현재 파일에서는 @는 도메인을 뜻하기 때문에 .으로 표기한다.
ns1 IN A 192.168.10.200
ns1 - hostname 컴퓨터 주소
	일반적으로 실제 컴퓨터 이름과 동일하게 구성하는것이 보통이지만 아닌 경우도 간간히 존재한다.
IN - 인터넷에서 사용되는 레코드
A - 레코드 타입 | 주소
192.168.10.200 - ns1이 가지는 실제 IP 주소를 표기 (없으면 에러난다.)
```

```bash
⑤ 리버스 존(Reverse-Zone) 파일 생성
# cp named.empty server.rev
# vi server.rev
[수정전]
$TTL    86400
@       IN      SOA     localhost. root.localhost.  (
                                      1997022700 ; Serial
                                      28800      ; Refresh
                                      14400      ; Retry
                                      3600000    ; Expire
                                      86400 )    ; Minimum
        IN      NS      localhost.
1       IN      PTR     localhost.
[수정후]
$TTL 4
@       IN SOA  **ns1.example.com. root.example.com.**  (
                                        0       ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      @
        A       127.0.0.1
        AAAA    ::1
        **IN      NS      ns1.example.com.
200     IN      PTR     ns1.example.com.**
```

```bash
# named-checkzone 10.168.192.in-addr.arpa server.rev
zone 10.168.192.in-addr.arpa/IN: loaded serial 0
OK
-> "# named-checkzone <Domain> <Zone File>"
-> 'OK' 라고 나오면 정상적으로 설정된것이다.
```

```bash
⑥ bind 실행 및 확인하기
# systemctl restart named
# systemctl status named
● named.service - Berkeley Internet Name Domain (DNS)
   Loaded: loaded (/usr/lib/systemd/system/named.service; enabled; vendor preset: disabled)
   Active: active (running) since 화 2020-04-07 22:38:11 KST; 7s ago
  Process: 54078 ExecStop=/bin/sh -c /usr/sbin/rndc stop > /dev/null 2>&1 || /bin/kill -TERM $MAINPID (code=exited, status=0/SUCCESS)
  Process: 54095 ExecStart=/usr/sbin/named -u named -c ${NAMEDCONF} $OPTIONS (code=exited, status=0/SUCCESS)
  Process: 54091 ExecStartPre=/bin/bash -c if [ ! "$DISABLE_ZONE_CHECKING" == "yes" ]; then /usr/sbin/named-checkconf -z "$NAMEDCONF"; else echo "Checking of zone files is disabled"; fi (code=exited, status=0/SUCCESS)
 Main PID: 54096 (named)
    Tasks: 5
   CGroup: /system.slice/named.service
           └─54096 /usr/sbin/named -u named -c /etc/named.conf

 4월 07 22:38:10 server1.example.com named[54096]: **zone example.com/IN: loading from master file server.zone failed: permission denied**
 4월 07 22:38:10 server1.example.com named[54096]: **zone example.com/IN: not loaded due to errors.**
 4월 07 22:38:10 server1.example.com named[54096]: zone 1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa/IN: loaded serial 0
 4월 07 22:38:10 server1.example.com named[54096]: **zone 10.168.192.in-addr.arpa/IN: loading from master file server.rev failed: permission denied**
 4월 07 22:38:10 server1.example.com named[54096]: **zone 10.168.192.in-addr.arpa/IN: not loaded due to errors.**
 4월 07 22:38:10 server1.example.com named[54096]: all zones loaded
 4월 07 22:38:10 server1.example.com named[54096]: running
 4월 07 22:38:11 server1.example.com named[54096]: managed-keys-zone: Unable to fetch DNSKEY set '.': failure
 4월 07 22:38:11 server1.example.com systemd[1]: Started Berkeley Internet Name Domain (DNS).
 4월 07 22:38:11 server1.example.com named[54096]: resolver priming query complet

# ls -l
합계 28K
drwxr-x---. 7 root  named   61  4월  7 21:31 chroot
drwxrwx---. 2 named named   23  4월  7 21:44 data
drwxrwx---. 2 named named   60  4월  7 22:38 dynamic
-rw-r--r--. 1 root  root   128  4월  7 22:09 named.ca
-rw-r-----. 1 root  named 2.3K  4월  5  2018 named.ca.old
-rw-r-----. 1 root  named  152 12월 15  2009 named.empty
-rw-r-----. 1 root  named  152  6월 21  2007 named.localhost
-rw-r-----. 1 root  named  168 12월 15  2009 named.loopback
**-rw-r-----. 1 root  root   222  4월  7 22:37 server.rev
-rw-r-----. 1 root  root   204  4월  7 22:20 server.zone**
drwxrwx---. 2 named named    6  8월  8  2019 slaves

# chown root:named server.zone 
# chown root:named server.rev 
# ls -l
합계 28K
drwxr-x---. 7 root  named   61  4월  7 21:31 chroot
drwxrwx---. 2 named named   23  4월  7 21:44 data
drwxrwx---. 2 named named   60  4월  7 22:38 dynamic
-rw-r--r--. 1 root  root   128  4월  7 22:09 named.ca
-rw-r-----. 1 root  named 2.3K  4월  5  2018 named.ca.old
-rw-r-----. 1 root  named  152 12월 15  2009 named.empty
-rw-r-----. 1 root  named  152  6월 21  2007 named.localhost
-rw-r-----. 1 root  named  168 12월 15  2009 named.loopback
**-rw-r-----. 1 root  named  222  4월  7 22:37 server.rev
-rw-r-----. 1 root  named  204  4월  7 22:20 server.zone**
drwxrwx---. 2 named named    6  8월  8  2019 slaves

# systemctl restart named
# systemctl status named
● named.service - Berkeley Internet Name Domain (DNS)
   Loaded: loaded (/usr/lib/systemd/system/named.service; enabled; vendor preset: disabled)
   Active: active (running) since 화 2020-04-07 22:40:39 KST; 4s ago
  Process: 54157 ExecStop=/bin/sh -c /usr/sbin/rndc stop > /dev/null 2>&1 || /bin/kill -TERM $MAINPID (code=exited, status=0/SUCCESS)
  Process: 54170 ExecStart=/usr/sbin/named -u named -c ${NAMEDCONF} $OPTIONS (code=exited, status=0/SUCCESS)
  Process: 54168 ExecStartPre=/bin/bash -c if [ ! "$DISABLE_ZONE_CHECKING" == "yes" ]; then /usr/sbin/named-checkconf -z "$NAMEDCONF"; else echo "Checking of zone files is disabled"; fi (code=exited, status=0/SUCCESS)
 Main PID: 54172 (named)
    Tasks: 5
   CGroup: /system.slice/named.service
           └─54172 /usr/sbin/named -u named -c /etc/named.conf

 4월 07 22:40:39 server1.example.com named[54172]: zone 10.168.192.in-addr.arpa/IN: loaded serial 0
 4월 07 22:40:39 server1.example.com named[54172]: zone 1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa/IN: loaded serial 0
 4월 07 22:40:39 server1.example.com named[54172]: zone localhost/IN: loaded serial 0
 4월 07 22:40:39 server1.example.com named[54172]: zone example.com/IN: loaded serial 0
 4월 07 22:40:39 server1.example.com named[54172]: all zones loaded
 4월 07 22:40:39 server1.example.com named[54172]: running
 4월 07 22:40:39 server1.example.com named[54172]: zone 10.168.192.in-addr.arpa/IN: sending notifies (serial 0)
 4월 07 22:40:39 server1.example.com systemd[1]: Started Berkeley Internet Name Domain (DNS).
 4월 07 22:40:39 server1.example.com named[54172]: zone example.com/IN: sending notifies (serial 0)
 4월 07 22:40:39 server1.example.com named[54172]: managed-keys-zone: Unable to fetch DNSKEY set '.': failure

# chown root:named named.ca
# ls -l 
합계 28K
drwxr-x---. 7 root  named   61  4월  7 21:31 chroot
drwxrwx---. 2 named named   23  4월  7 21:44 data
drwxrwx---. 2 named named   60  4월  7 22:41 dynamic
**-rw-r--r--. 1 root  named  128  4월  7 22:09 named.ca**
-rw-r-----. 1 root  named 2.3K  4월  5  2018 named.ca.old
-rw-r-----. 1 root  named  152 12월 15  2009 named.empty
-rw-r-----. 1 root  named  152  6월 21  2007 named.localhost
-rw-r-----. 1 root  named  168 12월 15  2009 named.loopback
-rw-r-----. 1 root  named  222  4월  7 22:37 server.rev
-rw-r-----. 1 root  named  204  4월  7 22:20 server.zone
drwxrwx---. 2 named named    6  8월  8  2019 slaves
# chmod 640 named.ca
```

(주의) DNS Zone이 chroot 구성으로 된 경우

```bash
/var/named  디렉토리에 존재하는 존(ZONE) 파일들은 그룹이 모두 named로 되어 있어야 한다. 만약 존 파일들의 속성정보중 그룹권(Groupship) 부분이 named로 되어 있지 않으면, named 서비스는 Start 되어도 정상적으로 서비스 되지는 않는다. 이런 경우 /var/log/messages 파일안에 이런 존 파일들을 읽을시에 'Permission denied' 라고 표시가 난다. 

# service named restart 
-> 서비스를 restart 했을때 출력되는 메세지(/var/log/messages) 확인

# tail –20 /var/log/messages
..... (중략) .....
4월 07 22:38:10 server1.example.com named[54096]: zone example.com/IN: loading from master file server.zone failed: **permission denied**
 4월 07 22:38:10 server1.example.com named[54096]: zone example.com/IN: not loaded due to errors.
 4월 07 22:38:10 server1.example.com named[54096]: zone 1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa/IN: loaded serial 0
 4월 07 22:38:10 server1.example.com named[54096]: zone 10.168.192.in-addr.arpa/IN: loading from master file server.rev failed: **permission denied**
 4월 07 22:38:10 server1.example.com named[54096]: zone 10.168.192.in-addr.arpa/IN: not loaded due to errors.
..... (중략) .....
# cd /var/named ; ls -l 
# chown root:named server.*    (# chgrp named example*)
# chown root:named named.ca        (# chgrp named named.ca)

# systemctl restart named
-> 에러메세지가 보이지 않을 것이다.
```

```bash
⑦ 네임서버 테스트
DNS 클라이언트 설정 변경 (네임서버 시작)
# vi /etc/resolv.conf /* 네임 서버를 여러개 적어도 총 3개까지만 인식 */
[수정전]
search example.com
nameserver 168.126.63.1
[수정후]
search example.com 
nameserver 192.168.10.200
```

```bash
# netstat -an | grep :53 /* 네임서버는 53번 포트를 사용함 */
# netstat -an | grep :53
tcp        0      0 192.168.10.200**:53**       0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:53            0.0.0.0:*               LISTEN     
tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN     
udp        0      0 0.0.0.0:5353            0.0.0.0:*                          
udp        0      0 192.168.122.1:53        0.0.0.0:*                          
udp        0      0 192.168.10.200:53       0.0.0.0:*                          
udp        0      0 127.0.0.1:53            0.0.0.0:*                          
udp        0      0 192.168.122.1:53        0.0.0.0:*
-> 현재 53 포트가 서비스 중임을 알수 있다.

# pgrep -lf named (# ps -ef | grep named, # ps aux | grep named)
54172 named
```

```bash
⑧ nslookup 명령어로 DNS 서버 등록 내용 확인
		■ DNS 서버에게 질의(Query) 할수 있는 명령어
		   - nslookup CMD (# nslookup www.daum.net)
		   - dig CMD      (# dig www.daum.net)
		   - host CMD     (# host www.daum.net)
		
		■ nslookup 명령어 사용하는 방식
		   - 대화형 모드(Interractive Mode) 형태로 실행
		     # nslookup 
		     > ns1.example.com
		     > exit
		   - 비대화형 모드(Non-Interractive Mode) 형태로 실행
		     # nslookup ns1.example.com
```

```bash
# nslookup
> ns1.example.com       <----- 'ns1.example.com' 입력
Server:		192.168.10.200
Address:	192.168.10.200#53

Name:	ns1.example.com
Address: 192.168.10.200
> exit                           <----- 'exit' 입력
# nslookup ns1.example.com
Server:		192.168.10.200
Address:	192.168.10.200#53

Name:	ns1.example.com
Address: 192.168.10.200
# nslookup 192.168.10.200
200.10.168.192.in-addr.arpa	name = ns1.example.com.

# dig ns1.example.com

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-9.P2.el7 <<>> ns1.example.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 53733
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;ns1.example.com.		IN	A

;; ANSWER SECTION:
ns1.example.com.	4	IN	A	192.168.10.200

;; AUTHORITY SECTION:
example.com.		4	IN	NS	example.com.
example.com.		4	IN	NS	ns1.example.com.

;; ADDITIONAL SECTION:
example.com.		4	IN	A	127.0.0.1
example.com.		4	IN	AAAA	::1

;; Query time: 0 msec
;; SERVER: 192.168.10.200#53(192.168.10.200)
;; WHEN: 화  4월 07 22:59:19 KST 2020
;; MSG SIZE  rcvd: 132

```

```bash
⑨ 부팅시에 named 데몬 띄우는 설정
	 # systemctl enable named	
```

```bash
SERVER2에서 SERVER1의 DNS를 사용하기
[SERVER2]# cat /etc/resolv.conf
# Generated by NetworkManager
search example.com
#nameserver 8.8.8.8
nameserver 192.168.10.200

[SERVER2]# nslookup ns1.example.com
           DNS 질의가 정상적으로 되지 않는다.

외부 및 내부(server pool)에서 DNS 서비스가 정상적으로 동작하도록 구성해준다.

# firewall-cmd --permanent --add-service=dns 
success
# firewall-cmd --reload 
success

DNS 캐시 삭제
# systemctl is-active systemd-resolved.service
# systemd-resolve --flush-caches
```

chroot 구성

root[최상위] 디렉토리 변경하기
리눅스, 유닉스 운영체제에서 chroot가 사용되는 것은 
실행중인 프로세스 그리고 하위 프로세스 그룹에서 인지하는 최상위 디렉토리의 변경이다.
수정된 환경이 필요한 경우들이 있는데 보통 서비스, 또는 민감한 디렉토리에서 작업되는 환경은 chroot를 필수로 지원하고 있다.
이렇게 구성되면 [chroot구성] named는 chroot가 지정한 디렉토리를 최상위 디렉토리로 인지하고 더 이상 접근 하지 못한다.

named의 보안을 위하여 사용한다.

DNS 관련한 취약점 중에 만약 root 권한 탈취가 가능한 취약점이 발견

서비스레벨에서 시스템을 격리화 시키는 이중 구조

```bash
# rpm -qa | grep chroot
bind-chroot-9.11.4-9.P2.el7.x86_64

# rpm -ql bind-chroot
/etc/named-chroot.files
/usr/lib/systemd/system/named-chroot-setup.service
/usr/lib/systemd/system/named-chroot.service
**/usr/libexec/setup-named-chroot.sh**
/var/named/chroot
/var/named/chroot/dev
/var/named/chroot/dev/null
/var/named/chroot/dev/random
/var/named/chroot/dev/zero
/var/named/chroot/etc
/var/named/chroot/etc/named
/var/named/chroot/etc/named.conf
/var/named/chroot/etc/pki
/var/named/chroot/etc/pki/dnssec-keys
/var/named/chroot/run
/var/named/chroot/run/named
/var/named/chroot/usr
/var/named/chroot/usr/lib64
/var/named/chroot/usr/lib64/bind
/var/named/chroot/var
/var/named/chroot/var/log
/var/named/chroot/var/named
/var/named/chroot/var/run
/var/named/chroot/var/tmp

chroot 환경으로 초기화

bind chroot패키지를 설치 한 경우 BIND 서비스는 chroot 환경에서 실행됩니다. 이 경우 초기화 스크립트는 mount --bind명령을 사용하여 모든 BIND 구성 파일을 chroot 위치에 마운트하므로이 환경 외부에서 구성을 관리 할 수 있습니다. 디렉토리가 자동으로 마운트되므로 디렉토리에 아무것도 복사 할 필요 가 없습니다

# /usr/libexec/setup-named-chroot.sh /var/named/chroot on
# mount | grep /var/named/chroot
/dev/sda8 on /var/named/chroot/etc/localtime type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/sda8 on /var/named/chroot/etc/named.root.key type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/sda8 on /var/named/chroot/etc/named.conf type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/sda8 on /var/named/chroot/etc/named.rfc1912.zones type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/sda8 on /var/named/chroot/etc/rndc.key type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/sda8 on /var/named/chroot/etc/named.iscdlv.key type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/sda8 on /var/named/chroot/etc/protocols type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/sda8 on /var/named/chroot/etc/services type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/sda8 on /var/named/chroot/etc/named type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/sda8 on /var/named/chroot/usr/lib64/bind type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
tmpfs on /var/named/chroot/run/named type tmpfs (rw,nosuid,nodev,seclabel,mode=755)
/dev/sda8 on /var/named/chroot/var/named type xfs (rw,relatime,seclabel,attr2,inode64,noquota)

53번 포트를 named가 사용하고 있기 때문에 named를 내려놓고 실행해야 에러가 안난다.
# systemctl stop named
# systemctl disable named
Removed symlink /etc/systemd/system/multi-user.target.wants/named.service.
# systemctl start named-chroot
# systemctl enable named-chroot
Created symlink from /etc/systemd/system/multi-user.target.wants/named-chroot.service to /usr/lib/systemd/system/named-chroot.service.
# systemctl status named-chroot
● named-chroot.service - Berkeley Internet Name Domain (DNS)
   Loaded: loaded (/usr/lib/systemd/system/named-chroot.service; enabled; vendor preset: disabled)
   Active: active (running) since 화 2020-04-07 23:06:56 KST; 11s ago
 Main PID: 54824 (named)
   CGroup: /system.slice/named-chroot.service
           └─54824 /usr/sbin/named -u named -c /etc/named.conf -t /var/named/chroot

 4월 07 23:06:56 server1.example.com named[54824]: zone 1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa/IN: loaded serial 0
 4월 07 23:06:56 server1.example.com named[54824]: zone 10.168.192.in-addr.arpa/IN: loaded serial 0
 4월 07 23:06:56 server1.example.com named[54824]: zone localhost.localdomain/IN: loaded serial 0
 4월 07 23:06:56 server1.example.com named[54824]: zone localhost/IN: loaded serial 0
 4월 07 23:06:56 server1.example.com named[54824]: all zones loaded
 4월 07 23:06:56 server1.example.com named[54824]: running
 4월 07 23:06:56 server1.example.com named[54824]: zone example.com/IN: sending notifies (serial 0)
 4월 07 23:06:56 server1.example.com named[54824]: zone 10.168.192.in-addr.arpa/IN: sending notifies (serial 0)
 4월 07 23:06:56 server1.example.com systemd[1]: Started Berkeley Internet Name Domain (DNS).
 4월 07 23:06:56 server1.example.com named[54824]: managed-keys-zone: Unable to fetch DNSKEY set '.': failure

# systemctl stop named
# systemctl disable named
# systemctl start named-chroot
# systemctl enable named-chroot
# systemctl status named-chroot

# cd /var/
# ll /var/named/chroot/etc
합계 688K
-rw-r--r--. 2 root root   645  9월 26  2019 localtime
drwxr-x---. 2 root named    6  8월  8  2019 named
-rw-r-----. 1 root named 1.8K  4월  7 21:56 named.conf
-rw-r--r--. 1 root named 3.9K  8월  8  2019 named.iscdlv.key
-rw-r-----. 1 root named 1.1K  4월  7 22:04 named.rfc1912.zones
-rw-r--r--. 1 root named 1.9K  4월 13  2017 named.root.key
drwxr-x---. 3 root named   25  4월  7 21:31 pki
-rw-r--r--. 1 root root  6.4K 10월 31  2018 protocols
-rw-r-----. 1 root named  100  4월  7 21:44 rndc.key
-rw-r--r--. 1 root root  655K  6월  7  2013 services

# ls -l /var/named/chroot/var/named/
합계 28K
drwxr-x---. 7 root  named   61  4월  7 21:31 chroot
drwxrwx---. 2 named named   23  4월  7 21:44 data
drwxrwx---. 2 named named   60  4월  7 23:07 dynamic
-rw-r--r--. 1 root  named  128  4월  7 22:09 named.ca
-rw-r-----. 1 root  named 2.3K  4월  5  2018 named.ca.old
-rw-r-----. 1 root  named  152 12월 15  2009 named.empty
-rw-r-----. 1 root  named  152  6월 21  2007 named.localhost
-rw-r-----. 1 root  named  168 12월 15  2009 named.loopback
-rw-r-----. 1 root  named  222  4월  7 22:37 server.rev
-rw-r-----. 1 root  named  204  4월  7 22:20 server.zone
drwxrwx---. 2 named named    6  8월  8  2019 slaves
```

[EX3] 도메인 등록

```bash
■ RR(Record Type, Resource Record) 종류에 따른 등록 방법
------------------------------------------------------------------------------------
(ㄱ) NS Record Type (Name Server)
example.com. IN NS ns1.example.com.
ns1.example.com. IN A 192.168.10.200

(ㄴ) A Record Type (Address)
www.example.com. IN A 192.168.10.200
www IN A 192.168.10.200

ftp.example.com. IN A 192.168.10.200
cafe.example.com. IN A 192.168.10.200

(ㄷ) MX Record Type (Mail Exchange)
example.com. IN MX 10 mail.example.com.
mail.example.com. IN A 192.168.10.200

example.com. IN MX 20 mail2.linux2XX.example.com.
mail2.example.com. IN A 192.168.10.200

(ㄹ) CNAME Record Type (Canonical Name)
www                IN A 192.168.10.200
ftp                IN A 192.168.10.200
or
www IN A 192.168.10.200
ftp IN CNAME www

(ㅁ) PTR Record Type (Pointer Address)
2XX IN PTR ns1.example.com.
2XX IN PTR www.example.com.
------------------------------------------------------------------------------------

A 레코드 (서브 도메인 생성)
A 레코드를 추가하면 서브 도메인을 생성하여 IP로 사이트를 연결하실 수 있습니다.
예) test.gabia.com 생성을 원하시면, 호스트명에 test를 입력하시고 연결하시려는 사이트의 ip주소를 입력해 주세요.

MX 레코드(메일 설정)
MX 레코드는 메일 연결에 사용됩니다. 입력된 정보를 변경/삭제할 경우 해당 서비스 사용이 변경/중단될 수 있으니, 설정한 메일 정보를 반드시 확인하세요.
MX 설정 시 메일 호스트 주소 입력 내용 끝에 ".(마침표)"를 입력하셔야 정상 세팅 됩니다.
예) kr1-aspmx1.worksmobile.com.

CNAME 레코드 (alias 같은거)
CNAME 정보는 메일, 블로그 연결 등에 사용됩니다. 입력된 정보를 변경/삭제할 경우 해당 서비스 사용이 변경/중단될 수 있으니, 설정한 메일 정보를 반드시 확인하세요.
한글 도메인은 사용 업체에 따라 CNAME을 설정하더라도 메일을 지원하지 않을 수 있습니다.

TXT 레코드
• SPF 레코드를 입력하고자 하는 경우 위 TXT 레코드란에 입력해 주세요.
• 사용하는 도메인이 스팸으로 차단되는 것을 방지하기 위하여 SPF 레코드 등록을 권장합니다.
• 올바른 SPF를 적용하기 위해 SPF Record 작성 도우미를 이용하여 SPF 레코드 등록을 권장합니다. [SPF Record 작성 도우미]
• SPF 레코드값의 올바른 입력 예 : 아래 2가지 예제와 같은 형식으로 입력하시기 바랍니다.
v=spf1 include:_spf.hiworks.co.kr ~all / v=spf1 ip4:211.243.118.50 ~all
• ※ TXT레코드에는 @, ^, <, >, ?, `(어퍼스트로피)를 입력할 수 없습니다.

SRV 레코드
※ SRV 레코드 설정 시, 대상 값 입력 내용 끝에 "."을 입력하셔야 정상 세팅됩니다.
예) sipdir.online.lync.com.
```

(시나리오) 도메인 등록 요청이 들어 왔다. 요청이 들어온 내용을 확인해 보면 다음과 같다.

```bash
▪ WEB  서버 등록 요청:  www.example.com  -> 192.168.10.200
▪ FTP  서버 등록 요청:  ftp.example.com  -> 192.168.10.200
▪ MAIL 서버 등록 요청:  mail.example.com -> 192.168.10.200
▪ CAFE 서버 등록 요청:  cafe.example.com -> 192.168.10.200
```

```bash
(도메인 등록 방법)
(ㄱ) Forward Zone 파일에 등록
# vi /var/named/chroot/var/named/server.zone (Domain -> IP)
-> 반드시 등록 해야 함.                          (www     IN    A    192.168.10.200)
(ㄴ) Reverse Zone 파일에 등록
# vi /var/named/chroot/var/named/server.rev  (IP -> Domain)
-> 반드시 등록할 필요 없음.                      (200     IN    PTR  www)
```

```bash
① Forward Zone 파일에 등록
# cd /var/named/chroot/var/named 
# vi server.zone
$TTL 4
@       IN SOA  ns1.example.com. root.example.com. (
                                        0       ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      @
        A       127.0.0.1
        AAAA    ::1
        IN      NS      ns1
ns1     IN      A       192.168.10.200

;; (1) WEB Server 
**www     IN      A       192.168.10.200**

;; (2) FTP Server
**ftp     IN      A       192.168.10.200**

;; (3) MAIL Server
**example.com.    IN      MX 10   mail.example.com.
mail    IN      A       192.168.10.200**

;; (4) etc
**cafe    IN      A       192.168.10.200**

-> 실습할 때는 Reverse Zone 파일에 등록하지는 않는다.
-> Reverse Zone 파일에는 반드시 등록할 필요가 없기 때문이다.
-> 이 파일에 Zone Entry를 등록할 때 필드와 필드 구분은 탭/스페이스로 한다.(권장: 탭)
```

```bash
# systemctl restart named-chroot
-> Zone 파일이 수정되면 변경된 사항을 적용시키기 위해서 데몬(named) restsart가 필요하다.
-> 서비스를 restart 할때는 반드시 /var/log/messages 파일을 같이 모니터링 한다.
		# nslookup www.linux2XX.example.com   (# nslookup www)
		# nslookup ftp.linux2XX.example.com   (# nslookup ftp) 
		# nslookup cafe.linux2XX.example.com  (# nslookup cafe) 
		# nslookup -q=MX linux2XX.example.com
# systemctl reload named-chroot 해도 된다.
```

```bash
② DNS와 웹서버 연동
----- DNS Client ----            ----- DNS Server -----                ---- WEB Server -----
http://www.example.com ------> named(53)
                                <------ # cat exampleXXX.com
                      www..example.com. IN A 192.168.10.210

								        ---------------------------------------------------->httpd(80)  
								        <---------------------------------------------------- httpd.conf
```

```bash

# rpm -qa | grep httpd
/etc/resolv.conf 파일의 내용 수정

# yum -y install httpd
>만약 에러가 난다면 /etc/resolv.conf에서 nameserver가 8.8.8.8로 되어있는지 확인
# ls /etc/httpd/conf       --> httpd.conf 파일 존재 확인
httpd.conf  magic

# ls /var/www/html         --> index.html 파일 존재 확인
#
-> index.html 파일 존재하지 않는다.
# cp /etc/passwd /var/www/html/index.html 

# systemctl restart httpd
# firewall-cmd --permanent --add-service=http
success
# firewall-cmd --reload
success

[SERVER2]# dnf --enablerepo=PowerTools install lynx
				 # curl http://www.example.com
				 server1 web
```
