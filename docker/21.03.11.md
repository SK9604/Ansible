# Volume

- bind mount
- volume

### Docker Volume의 일반적인 활용 : DB의 중요 데이터 보호 및 영속성 유지

실제 서버에서는 상상할 수 없는 일

해당 폴더에 컨테이너를 생성하고 db 생성 후 컨테이너를 삭제한 뒤 해당 폴더로 새로운 컨테이너를 만들면 데이터가 살아있는것을 확인 할 수 있다.

```bash
// mysql 컨테이너1 생성
jeff@docker-host01:~$ docker run -it --name=mysql-vtest -e MYSQL_ROOT_PASSWORD=mjeff \
> -e MYSQL_DATABASE=dockertest -v /home/jeff/volume_test:/var/lib/mysql -d mysql:5.7
4bafebde88a5db4bbb4480085f1c58c941343c9b708e287baed6d66e1422a1e8
jeff@docker-host01:~$ docker exec -it mysql-vtest bash

//mysql 시작
root@4bafebde88a5:/# /etc/init.d/mysql start
[info] A MySQL Server is already started.
root@4bafebde88a5:/# mysql -uroot -p
Enter password: (mjeff)
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| dockertest         |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.00 sec)
mysql> use dockertest;
Database changed
mysql> create table mytab(c1 int, c2 char);
Query OK, 0 rows affected (0.01 sec)
mysql> insert into mytab values (1, 'a');
Query OK, 1 row affected (0.02 sec)
mysql> commit;
Query OK, 0 rows affected (0.00 sec)
mysql> exit
Bye
root@4bafebde88a5:/# exit
exit
jeff@docker-host01:~$ cd volume_test/
jeff@docker-host01:~/volume_test$ ls
auto.cnf    client-cert.pem  ib_buffer_pool  ib_logfile1  performance_schema  server-cert.pem
ca-key.pem  client-key.pem   ibdata1         ibtmp1       private_key.pem     server-key.pem
ca.pem      dockertest       ib_logfile0     mysql        public_key.pem      sys

// mysql 컨테이너1 삭제
jeff@docker-host01:~/volume_test$ docker stop mysql-vtest
jeff@docker-host01:~/volume_test$ docker rm mysql-vtest

// 새 컨테이너 생성
jeff@docker-host01:~$ docker run -it --name=mysql-vtest -e MYSQL_ROOT_PASSWORD=mjeff -e MYSQL_DATABASE=dockertest -v /home/jeff/volume_test:/var/lib/mysql mysql:5.7 bash
root@1d0c0a928f8c:/#mysql -uroot -p
Enter password: (mjeff)

// mysql 확인
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| dockertest         |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.00 sec)

mysql> use dockertest;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+----------------------+
| Tables_in_dockertest |
+----------------------+
| mytab                |
+----------------------+
1 row in set (0.00 sec)

mysql> select * from mytab;
+------+------+
| c1   | c2   |
+------+------+
|    1 | a    |
+------+------+
1 row in set (0.00 sec)
```

### docker-compose

yaml code 작성 주의점

줄 맞추기 (반드시 tab이 아닌 띄어쓰기로!) [yaml 검증](http://yamllint.com) → 초록색 OK

```bash
//docker-compose 설치
jeff@docker-host01:~$ sudo curl -L https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
[sudo] password for jeff: (jeff)
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   633  100   633    0     0  14386      0 --:--:-- --:--:-- --:--:-- 14386
100 11.6M  100 11.6M    0     0  10.3M      0  0:00:01  0:00:01 --:--:-- 20.9M
jeff@docker-host01:~$ sudo chmod +x /usr/local/bin/docker-compose
jeff@docker-host01:~$ sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
jeff@docker-host01:~$ sudo chown jeff /usr/local/bin/docker-compose
jeff@docker-host01:~$ docker-compose -v
docker-compose version 1.27.4, build 40524192
jeff@docker-host01:~$ docker-compose version
docker-compose version 1.27.4, build 40524192
docker-py version: 4.3.1
CPython version: 3.7.7
OpenSSL version: OpenSSL 1.1.0l  10 Sep 2019

//yaml code 작성
jeff@docker-host01:~$ mkdir mariadb
jeff@docker-host01:~$ cd mariadb/
jeff@docker-host01:~/mariadb$ mkdir db_vol
jeff@docker-host01:~/mariadb$ vi docker-compose.yml
version: '3.3'
services:
        mariadb:
                image: mariadb:10.4.6
                restart: always
                environment:
                        - MYSQL_ROOT_PASSWORD=test
                        - MYSQL_DATABASE=dockerdb
                volumes:
                        - ./db_vol:/var/lib/mysql
                ports:
                        - '3306:3306'

//docker-compose 활성화
jeff@docker-host01:~/mariadb$ docker-compose up -d
Creating mariadb_mariadb_1 ... done
jeff@docker-host01:~/mariadb$ docker-compose ps
      Name                    Command             State           Ports
--------------------------------------------------------------------------------
mariadb_mariadb_1   docker-entrypoint.sh mysqld   Up      0.0.0.0:3306->3306/tcp
jeff@docker-host01:~/mariadb$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                    NAMES
fb3f9336d0f4   mariadb:10.4.6           "docker-entrypoint.s…"   20 seconds ago   Up 13 seconds   0.0.0.0:3306->3306/tcp   mariadb_mariadb_1
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   22 hours ago     Up 18 hours     0.0.0.0:9559->8080/tcp   cadvisor
jeff@docker-host01:~/mariadb$ docker exec -it fb3f9336d0f4 bash

//mysql database 작성
root@fb3f9336d0f4:/# mysql -uroot -p
Enter password: (test)
MariaDB [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| dockerdb           |
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
4 rows in set (0.000 sec)

MariaDB [(none)]> create database dshub;
Query OK, 1 row affected (0.000 sec)
MariaDB [(none)]> use dshub;
Database changed
MariaDB [dshub]> create table item (item_id int, item_name varchar(10));
Query OK, 0 rows affected (0.013 sec)
MariaDB [dshub]> insert into item values (19, 'docker');
Query OK, 1 row affected (0.033 sec)
MariaDB [dshub]> select * from item;
+---------+-----------+
| item_id | item_name |
+---------+-----------+
|      19 | docker    |
+---------+-----------+
1 row in set (0.000 sec)

MariaDB [dshub]> commit;
Query OK, 0 rows affected (0.000 sec)

//docker-compose down
MariaDB [dshub]> exit;
Bye
root@fb3f9336d0f4:/# exit
exit
jeff@docker-host01:~/mariadb$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED         STATUS         PORTS                    NAMES
fb3f9336d0f4   mariadb:10.4.6           "docker-entrypoint.s…"   4 minutes ago   Up 4 minutes   0.0.0.0:3306->3306/tcp   mariadb_mariadb_1
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   22 hours ago    Up 18 hours    0.0.0.0:9559->8080/tcp   cadvisor
jeff@docker-host01:~/mariadb$ docker-compose down
Stopping mariadb_mariadb_1 ... done
Removing mariadb_mariadb_1 ... done
Removing network mariadb_default
jeff@docker-host01:~/mariadb$ cd db_vol/
jeff@docker-host01:~/mariadb/db_vol$ ls
aria_log.00000001  dockerdb  ib_buffer_pool  ib_logfile0  multi-master.info  performance_schema
aria_log_control   dshub     ibdata1         ib_logfile1  mysql
jeff@docker-host01:~/mariadb/db_vol$ cd ..

//docker-compose 다시 up
jeff@docker-host01:~/mariadb$ docker-compose up -d
Creating network "mariadb_default" with the default driver
Creating mariadb_mariadb_1 ... done
jeff@docker-host01:~/mariadb$ docker-compose ps
      Name                    Command             State           Ports
--------------------------------------------------------------------------------
mariadb_mariadb_1   docker-entrypoint.sh mysqld   Up      0.0.0.0:3306->3306/tcp
jeff@docker-host01:~/mariadb$ docker exec -it mariadb_mariadb_1 bash

//그대로 유지중인 데이터 확인 (dshub)
root@29f127f1e47e:/# mysql -uroot -p
Enter password: (test)
MariaDB [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| dockerdb           |
| dshub              |
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
5 rows in set (0.001 sec)

exit!

// docker-compose down시 컨테이너 함께 삭제됨
jeff@docker-host01:~/mariadb$ docker-compose down
Stopping mariadb_mariadb_1 ... done
Removing mariadb_mariadb_1 ... done
Removing network mariadb_default
jeff@docker-host01:~/mariadb$ cd
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED        STATUS        PORTS                    NAMES
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   22 hours ago   Up 18 hours   0.0.0.0:9559->8080/tcp   cadvisor
jeff@docker-host01:~$ docker ps -a
CONTAINER ID   IMAGE                    COMMAND                  CREATED        STATUS        PORTS                    NAMES
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   22 hours ago   Up 18 hours   0.0.0.0:9559->8080/tcp   cadvisor
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8d1ba106-2144-426c-b0c6-ee8ae743100b/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8d1ba106-2144-426c-b0c6-ee8ae743100b/Untitled.png)

### 로그를 남겨 분석하기

```bash
jeff@docker-host01:~$ mkdir -p /home/jeff/nginx-log
jeff@docker-host01:~$ docker run -d -v /home/jeff/nginx-log:/var/log/nginx -p 8011:80 nginx:1.19
0d5e19aa941d8bf369f88874039fc5c803c4a06971d5c7e21f48108802994177
jeff@docker-host01:~$ cd nginx-log/
jeff@docker-host01:~/nginx-log$ ls
access.log  error.log
jeff@docker-host01:~/nginx-log$ tail -f access.log
> 웹 브라우저에서 접속하기
> host2의 내부 firefox에서 접속하기
> 새로고침 할 때마다 남겨지는 로그 확인
192.168.56.1 - - [11/Mar/2021:01:40:23 +0000] "GET / HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...
...
192.168.56.103 - - [11/Mar/2021:01:43:25 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:86.0) Gecko/20100101 Firefox/86.0" "-"
192.168.56.103 - - [11/Mar/2021:01:43:26 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:86.0) Gecko/20100101 Firefox/86.0" "-"
^C
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/18b18277-a086-4eb8-b7bf-12b4f5811f18/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/18b18277-a086-4eb8-b7bf-12b4f5811f18/Untitled.png)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d568eba7-1082-42e8-af5b-a6919a374afd/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d568eba7-1082-42e8-af5b-a6919a374afd/Untitled.png)

```bash
jeff@docker-host01:~/nginx-log$ awk '$4>"[11/Mar/2021:01:40:23]" && $4<"[11/Mar/2021:01:43:26]"' access.log | awk '{ print $1 }' | sort | uniq -c | sort -r | more
      9 192.168.56.103    > 192.168.56.103에서 9번 접속하였다
      6 192.168.56.1      > 192.168.56.1에서 6번 접속하였다
```

### history 로그

```bash
======
터미널1
======
jeff@docker-host01:~$ docker run -it --rm \
> -v ~/.bash_history:/root/.bash_history \
> centos:8 bash
======
터미널2
======
jeff@docker-host01:~$ tail -f .bash_history
...
docker inspect mem-test | grep \"MemorySwap\"
htop
======
터미널1
======
[root@1c0fd52f5f49 /]# echo 'docker volume test' > volume.text
[root@1c0fd52f5f49 /]# exit
exit
======
터미널2
======
jeff@docker-host01:~$ tail -f .bash_history
....
docker inspect mem-test | grep \"MemorySwap\"
htop
echo 'docker volume test' > volume.text
exit
```

### docker volume quota(할당량) 제한

```bash
//아무 제한 없이 만들어보기
jeff@docker-host01:~$ docker run -v /home/jeff/myvolume:/webapp -it --name=vquota ubuntu:14.04 bash
root@86018373cc2e:/# df -h
Filesystem      Size  Used Avail Use% Mounted on
...
/dev/sda1        98G  9.9G   84G  11% /webapp  < 용량 확인

//삭제
root@86018373cc2e:/# exit
exit
jeff@docker-host01:~$ docker stop vquota
jeff@docker-host01:~$ docker rm vquota

//용량 확인
jeff@docker-host01:~$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        98G  9.9G   84G  11% /          < 용량의 전부를 사용했었음을 확인

//새로운 볼륨 생성 후 마운트
jeff@docker-host01:~$ dd if=/dev/zero of=temphdd.img count=512 bs=1M
512+0 records in
512+0 records out
536870912 bytes (537 MB, 512 MiB) copied, 1.02466 s, 524 MB/s
jeff@docker-host01:~$ mkfs.ext4 temphdd.img
mke2fs 1.44.1 (24-Mar-2018)
Discarding device blocks: done
Creating filesystem with 131072 4k blocks and 32768 inodes
Filesystem UUID: 3ed771ab-6471-450c-9e1b-84567cb27678
Superblock backups stored on blocks:
        32768, 98304

Allocating group tables: done
Writing inode tables: done
Creating journal (4096 blocks): done
Writing superblocks and filesystem accounting information: done

jeff@docker-host01:~$ fdisk -l temphdd.img
Disk temphdd.img: 512 MiB, 536870912 bytes, 1048576 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
jeff@docker-host01:~$ mkdir -p /home/jeff/myvolume
jeff@docker-host01:~$ mount -o loop temphdd.img /home/jeff/myvolume
mount: only root can use "--options" option
jeff@docker-host01:~$ sudo mount -o loop temphdd.img /home/jeff/myvolume
[sudo] password for jeff:

//
jeff@docker-host01:~$ df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            1.9G     0  1.9G   0% /dev
tmpfs           394M  1.4M  393M   1% /run
/dev/sda1        98G  9.9G   84G  11% /
tmpfs           2.0G     0  2.0G   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           2.0G     0  2.0G   0% /sys/fs/cgroup
/dev/loop0       43M   43M     0 100% /snap/gtk-common-themes/1313
/dev/loop1      3.8M  3.8M     0 100% /snap/gnome-system-monitor/100
/dev/loop3      640K  640K     0 100% /snap/gnome-logs/103
/dev/loop2       56M   56M     0 100% /snap/core18/1988
/dev/loop4      384K  384K     0 100% /snap/gnome-characters/570
/dev/loop6      2.5M  2.5M     0 100% /snap/gnome-calculator/884
/dev/loop5      4.2M  4.2M     0 100% /snap/gnome-calculator/406
/dev/loop7       89M   89M     0 100% /snap/core/7270
/dev/loop10     100M  100M     0 100% /snap/core/10859
/dev/loop9       55M   55M     0 100% /snap/core18/1066
/dev/loop8      219M  219M     0 100% /snap/gnome-3-34-1804/66
/dev/loop11     2.3M  2.3M     0 100% /snap/gnome-system-monitor/157
/dev/loop13     163M  163M     0 100% /snap/gnome-3-28-1804/145
/dev/loop12     150M  150M     0 100% /snap/gnome-3-28-1804/67
/dev/loop15     1.0M  1.0M     0 100% /snap/gnome-logs/61
/dev/loop16      65M   65M     0 100% /snap/gtk-common-themes/1514
/dev/loop14      15M   15M     0 100% /snap/gnome-characters/296
tmpfs           394M   28K  394M   1% /run/user/121
overlay          98G  9.9G   84G  11% /var/lib/docker/overlay2/2f151aaf6b262c5444b80723cabfdc2ad5b489b8a7088802bfda03291a4cc435/merged
tmpfs           394M     0  394M   0% /run/user/1000
overlay          98G  9.9G   84G  11% /var/lib/docker/overlay2/2c60784f1459433b7d7ed920477e0b2011a6158fd2bcb6c7e6afdacb078d4f1a/merged
jeff@docker-host01:~$ sudo chown -R jeff.jeff /home/jeff/myvolume/
jeff@docker-host01:~$ docker run -v /home/jeff/myvolume:/webapp -it --name=vquota ubuntu:14.04 bash
root@f306182d428d:/# df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/loop17     488M  780K  452M   1% /webapp
```

### 볼륨 생성

```bash
jeff@docker-host01:~$ docker run -d --name wp-db2 \
> -e MYSQL_ROOT_PASSWORD=password1 \
> -e MYSQL_DATABASE=wp \
> -v wp-db-volume:/var/lib/mysql \
> mysql:5.7
c47dd75c9850f8ec5d2f85901c8857b1fdfb9c25dd00553924fff2dff9c591af

//볼륨 조회
jeff@docker-host01:~$ docker inspect --type volume wp-db-volume
[
    {
        "CreatedAt": "2021-03-11T11:09:18+09:00",
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/wp-db-volume/_data",
        "Name": "wp-db-volume",
        "Options": {},
        "Scope": "local"
    }
]
jeff@docker-host01:~$ sudo ls /var/lib/docker/volumes/wp-db-volume/_data
auto.cnf    client-cert.pem  ibdata1      ibtmp1              private_key.pem  server-key.pem
ca-key.pem  client-key.pem   ib_logfile0  mysql               public_key.pem   sys
ca.pem      ib_buffer_pool   ib_logfile1  performance_schema  server-cert.pem  wp

//볼륨 삭제
jeff@docker-host01:~$ docker volume rm wp-db-volume
Error response from daemon: remove wp-db-volume: volume is in use - [c47dd75c9850f8ec5d2f85901c8857b1fdfb9c25dd00553924fff2dff9c591af]
jeff@docker-host01:~$ docker volume --help

Usage:  docker volume COMMAND

Manage volumes

Commands:
  create      Create a volume
  inspect     Display detailed information on one or more volumes
  ls          List volumes
  prune       Remove all unused local volumes
  rm          Remove one or more volumes

Run 'docker volume COMMAND --help' for more information on a command.
```

### 데이터 전용 컨테이너

date container를 image로 commit시 호스트와 공유된 파일들은 commit 안됨.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/594adf6f-48e3-4da6-bb17-fa84104a7cf2/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/594adf6f-48e3-4da6-bb17-fa84104a7cf2/Untitled.png)

```bash
jeff@docker-host01:~$ docker create -v /data-volume --name=datavol ubuntu:14.04
0cea9f38205d0c654740effa8346e29d6863dd4cf0c371533a9f7a94727970e1
jeff@docker-host01:~$ docker run -it --volumes-from datavol ubuntu:14.04
root@f0d74e95a5aa:/# echo 'testing data container' > /data-volume/test-volume.txt
root@f0d74e95a5aa:/# cat /data-volume/test-volume.txt
testing data container
root@f0d74e95a5aa:/# exit
jeff@docker-host01:~$ docker run -it --volumes-from datavol ubuntu:14.04
root@f08416b99f88:/# cat /data-volume/test-volume.txt
testing data container
root@f08416b99f88:/# echo 'testing data container' > /data-volume/test-volume2.txt
root@f08416b99f88:/# ls /data-volume/
test-volume.txt  test-volume2.txt
root@f08416b99f88:/# exit

//확인
jeff@docker-host01:~$ sudo su -
root@docker-host01:~# cd /var/lib/docker/volumes/
root@docker-host01:/var/lib/docker/volumes# ls -lt
total 40
-rw------- 1 root root 32768  3월 11 11:15 metadata.db
drwx-----x 3 root root  4096  3월 11 11:15 af227dc2b6be8736a14249bbf5d347493b6517cef01283fa82caa1dd8941856f
drwx-----x 3 root root  4096  3월 11 11:08 wp-db-volume
drwx-----x 3 root root  4096  3월 10 18:03 my-appvol-1
brw------- 1 root root  8, 1  3월 10 16:08 backingFsBlockDev
drwx-----x 3 root root  4096  3월 10 11:43 31505bec9bbaff51e8252231d92be8cede489062a67eb832c4d04488624e14e2
root@docker-host01:/var/lib/docker/volumes# cd af227dc2b6be8736a14249bbf5d347493b6517cef01283fa82caa1dd8941856f
root@docker-host01:/var/lib/docker/volumes/af227dc2b6be8736a14249bbf5d347493b6517cef01283fa82caa1dd8941856f# ls
_data
root@docker-host01:/var/lib/docker/volumes/af227dc2b6be8736a14249bbf5d347493b6517cef01283fa82caa1dd8941856f# cd _data/
root@docker-host01:/var/lib/docker/volumes/af227dc2b6be8736a14249bbf5d347493b6517cef01283fa82caa1dd8941856f/_data# ls
test-volume2.txt  test-volume.txt
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0332e4d4-81c3-40c4-8def-bd4cf320f542/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0332e4d4-81c3-40c4-8def-bd4cf320f542/Untitled.png)

### Network

```bash
=============
터미널 1
=============
jeff@docker-host01:~$ docker run -it --name=add-net ubuntu:14.04
root@2e42ba315a81:/# ifconfig
eth0      Link encap:Ethernet  HWaddr 02:42:ac:11:00:04
          inet addr:172.17.0.4  Bcast:172.17.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:11 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:1390 (1.3 KB)  TX bytes:0 (0.0 B)
=============
터미널 2 
=============
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                    NAMES
2e42ba315a81   ubuntu:14.04             "/bin/bash"              9 seconds ago    Up 8 seconds                             add-net

jeff@docker-host01:~$ docker network create --driver=bridge web-network
d047135e8a70ec8126e88f72276c444b41d3c470cdd7781f722d6c4f232a9f2c
jeff@docker-host01:~$ docker network ls
NETWORK ID     NAME          DRIVER    SCOPE
d047135e8a70   web-network   bridge    local

jeff@docker-host01:~$ ifconfig
br-d047135e8a70: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
        inet 172.23.0.1  netmask 255.255.0.0  broadcast 172.23.255.255
        ether 02:42:d4:da:8a:8f  txqueuelen 0  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

jeff@docker-host01:~$ docker network connect web-network add-net
jeff@docker-host01:~$ docker exec add-net route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         172.17.0.1      0.0.0.0         UG    0      0        0 eth0
172.17.0.0      *               255.255.0.0     U     0      0        0 eth0
172.23.0.0      *               255.255.0.0     U     0      0        0 eth1
=============
터미널 1
=============
root@2e42ba315a81:/# ifconfig
eth0      Link encap:Ethernet  HWaddr 02:42:ac:11:00:04
          inet addr:172.17.0.4  Bcast:172.17.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:31 errors:0 dropped:0 overruns:0 frame:0
          TX packets:4 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:3450 (3.4 KB)  TX bytes:250 (250.0 B)

eth1      Link encap:Ethernet  HWaddr 02:42:ac:17:00:02
          inet addr:172.23.0.2  Bcast:172.23.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:59 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:7657 (7.6 KB)  TX bytes:0 (0.0 B)
```

```bash
jeff@docker-host01:~$ docker network inspect web-network
[
    {
        "Name": "web-network",
        "Id": "d047135e8a70ec8126e88f72276c444b41d3c470cdd7781f722d6c4f232a9f2c",
        "Created": "2021-03-11T11:36:24.774431165+09:00",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": {},
            "Config": [
                {
                    "Subnet": "172.23.0.0/16",
                    "Gateway": "172.23.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Containers": {
            "2e42ba315a8106450721d1b2bdaa917c2484113e8bbe9348586b0743476de185": {
                "Name": "add-net",
                "EndpointID": "daabfaa22def62fcc7914aceecaac1b40da243094561fbdbba23a48ce0df2111",
                "MacAddress": "02:42:ac:17:00:02",
                "IPv4Address": "172.23.0.2/16",
                "IPv6Address": ""
            }
        },
        "Options": {},
        "Labels": {}
    }
]
jeff@docker-host01:~$ docker network rm web-network
Error response from daemon: error while removing network: network web-network id d047135e8a70ec8126e88f72276c444b41d3c470cdd7781f722d6c4f232a9f2c has active endpoints
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                    NAMES
2e42ba315a81   ubuntu:14.04             "/bin/bash"              5 minutes ago    Up 5 minutes                             add-net
c47dd75c9850   mysql:5.7                "docker-entrypoint.s…"   32 minutes ago   Up 32 minutes   3306/tcp, 33060/tcp      wp-db2
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   24 hours ago     Up 20 hours     0.0.0.0:9559->8080/tcp   cadvisor
jeff@docker-host01:~$ docker container stop add-net
또는
jeff@docker-host01:~$ docker network disconnect web-network add-net
jeff@docker-host01:~$ docker network rm web-network
jeff@docker-host01:~$ docker network ls
NETWORK ID     NAME         DRIVER    SCOPE
f1b1f071026b   appdb-net    bridge    local
68c9da664f88   bridge       bridge    local
6c8d61d65e81   host         host      local
deb0065c72cf   netlb        bridge    local
dd3daf2aca85   none         null      local
1bc504426b1f   vswitch-ap   bridge    local
a89fe8e918d6   webap-net    bridge    local
```

### attach → 동시에 움직인다

```bash
=============
터미널 1
=============
jeff@docker-host01:~$ docker run -it --name=centos8 centos:8 bash
=============
터미널 2
=============
jeff@docker-host01:~$ docker attach centos8
[root@f2a6b28b2fa3 /]# ls
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
=============
터미널 1
=============
[root@f2a6b28b2fa3 /]# ls
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
```

### 가동중인 컨테이너 조작

```bash
jeff@docker-host01:~$ docker run --name webserver6 -d -p 8006:80 nginx
14c7e3493b03558ea3e35177040ac5643d901d9357b69626e14cfee199269239
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                    NAMES
14c7e3493b03   nginx                    "/docker-entrypoint.…"   2 seconds ago    Up 1 second     0.0.0.0:8006->80/tcp     webserver6
c47dd75c9850   mysql:5.7                "docker-entrypoint.s…"   38 minutes ago   Up 38 minutes   3306/tcp, 33060/tcp      wp-db2
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   24 hours ago     Up 20 hours     0.0.0.0:9559->8080/tcp   cadvisor
jeff@docker-host01:~$ docker top webserver6
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                20759               20735               0                   11:47               ?                   00:00:00            nginx: master process nginx -g daemon off;
systemd+            20850               20759               0                   11:47               ?                   00:00:00            nginx: worker process
jeff@docker-host01:~$ docker port webserver6
80/tcp -> 0.0.0.0:8006
jeff@docker-host01:~$ docker rename webserver6 nginx_test
```

### 컨테이너 내에서 파일 복사

```bash
// test container의 /etc/passwd 파일을 host의 /tmp/etc에 복사
jeff@docker-host01:~$  docker run -itd --name=test_container centos:8
3e9a443610c97f66111a09d9370bd45963ce5fbff8708018425b970ff5374a09
jeff@docker-host01:~$ docker container cp test_container:/etc/passwd /home/jeff/centos_passwd.txt

// Host의 현재 디렉터리에 있는 local.txt 파일을 text container의 /tmp/local.txt로 복사
jeff@docker-host01:~$ touch local.txt
jeff@docker-host01:~$ docker container cp ./local.txt test_container:/tmp/local.txt
jeff@docker-host01:~$ docker exec -it test_container ls /tmp
ks-script-esd4my7v  ks-script-eusq_sc5  local.txt

// webserver container의 /etc/nginx/nginx.conf를 HostOS 경로에 복사
jeff@docker-host01:~$ docker run -d -p 7777:80 --name=webserver nginx:1.19
ae126aac86393776cec3cd73ce7014718b0710ae128a4ea541f9fcb38bf763a1
jeff@docker-host01:~$ docker cp webserver:/etc/nginx/nginx.conf /home/jeff/nginx.conf  //수정
jeff@docker-host01:~$ docker cp nginx.conf webserver:/etc/nginx/nginx.conf
```

save/load : image

export/import : container

### tar(tape archive) 묶음

tar

- -cvf, xvf, tvf → *.tar
- -cvzf, xvzf, tvzf → *.tar.gzip
- -cvjf, xvjf, tvjf → *.tar.bzip2

```bash
jeff@docker-host01:~$ docker run -d --name=webserver10 -p 8010:80 nginx:1.19
jeff@docker-host01:~$ docker export webserver10 > webserver10.tar
jeff@docker-host01:~$ tar -tvf webserver10.tar
jeff@docker-host01:~$ scp webserver10.tar 192.168.56.103:/home/jeff
The authenticity of host '192.168.56.103 (192.168.56.103)' can't be established.
ECDSA key fingerprint is SHA256:bHnRBzucr2T5EN0Mlhec3bh5xMhpXTk6I9/vLAX+ajk.
Are you sure you want to continue connecting (yes/no)? y
Please type 'yes' or 'no': yes
Warning: Permanently added '192.168.56.103' (ECDSA) to the list of known hosts.
jeff@192.168.56.103's password:
webserver10.tar                                                                  100%  129MB 156.7MB/s   00:00
jeff@docker-host01:~$ ssh jeff@192.168.56.103
jeff@192.168.56.103's password:
Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 5.0.0-23-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

 * Introducing self-healing high availability clusters in MicroK8s.
   Simple, hardened, Kubernetes for production, from RaspberryPi to DC.

     https://microk8s.io/high-availability

 * Canonical Livepatch is available for installation.
   - Reduce system reboots and improve kernel security. Activate at:
     https://ubuntu.com/livepatch

144 packages can be updated.
1 update is a security update.

New release '20.04.2 LTS' available.
Run 'do-release-upgrade' to upgrade to it.

Your Hardware Enablement Stack (HWE) is supported until April 2023.
*** System restart required ***
Last login: Wed Mar 10 18:12:39 2021 from 192.168.56.1
jeff@docker-host02:~$ ls
apt-transport-https  curl     Documents  examples.desktop  Pictures  software-properties-common  Videos
ca-certificates      Desktop  Downloads  Music             Public    Templates                   webserver10.tar
jeff@docker-host02:~$ cat webserver10.tar | docker import - webapp:1.0
sha256:a78937933e059e73d00ef3e8c28df2a5faa255377e36238c85b84ae4830b6411
jeff@docker-host02:~$ docker images | grep webapp
webapp       1.0       a78937933e05   3 seconds ago   131MB
```

■ Docker를 이용한 MariaDB sharding 구축
(write 성능 향상, read 성능 향상은 replication)

- — terminal 1(spider)       spider-db	master
-- terminal 2(korea1)	spider-client1	slave1
-- terminal 3(korea2)	spider-client2	slave2
-- terminal 4	image pull, docker monitoring
- - terminal 4

    ```bash
    jeff@jeff-VirtualBox:~$ docker pull mariadb:10.1
    10.1: Pulling from library/mariadb
    898c46f3b1a1: Downloading [============================> ] 18.73MB/32.47MB
    63366dfa0a50: Download complete
    ...
    ```

- - terminal 1

    ```bash
    jeff@jeff-VirtualBox:~$ docker run -d -e MYSQL_ROOT_PASSWORD=koreapass --name=spider mariadb:10.1
    25c64999c04b0005820397a8d3617e3c5cbbd906b8df7cecb2f46028da434ca7
    jeff@jeff-VirtualBox:~$ docker exec -it spider bash
    root@25c64999c04b:/#
    root@6c017597b562:/# apt-get update
    root@6c017597b562:/# apt-get install net-tools && ifconfig
    root@6c017597b562:/# apt-get install -y iputils-ping
    root@6c017597b562:/# ifconfig
    eth0: 172.17.0.3

    root@25c64999c04b:~# mysql -u root -p < /usr/share/mysql/install_spider.sql
    Enter password: (koreapass)

    root@25c64999c04b:~# mysql -uroot -p
    Enter password: (koreapass)
    MariaDB [(none)]> show engines\G;
    +--------------------+---------+--------------------------------------------------------------------------------------------------+--------------+------+------------+
    | Engine             | Support | Comment                                                                                          | Transactions | XA   | Savepoints |
    +--------------------+---------+--------------------------------------------------------------------------------------------------+--------------+------+------------+
    | SPIDER             | YES     | Spider storage engine                                                                            | YES          | YES  | NO         |
    ```

- - terminal 2

    ```bash
    jeff@jeff-VirtualBox:~$ docker run -d -e MYSQL_ROOT_PASSWORD=koreapass --name=korea1 mariadb:10.1
    b213421a26f857ed582f53b67d01172e0e22994d148ea186b7a9501f584354b6
    ```

- - terminal 3

    ```bash
    jeff@jeff-VirtualBox:~$ docker run -d -e MYSQL_ROOT_PASSWORD=koreapass --name=korea2 mariadb:10.1
    2b14ce03d85de7b0acfd4caefd90efb9aaccfd5eacf165408fecabf6f67b5d6a
    ```

- - terminal 4

    ```bash
    jeff@jeff-VirtualBox:~$ docker ps -a
    CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
    2b14ce03d85d mariadb:10.1 "docker-entrypoint.s…" 22 seconds ago Up 20 seconds 3306/tcp korea2
    b213421a26f8 mariadb:10.1 "docker-entrypoint.s…" 29 seconds ago Up 28 seconds 3306/tcp korea1
    25c64999c04b mariadb:10.1 "docker-entrypoint.s…" 2 minutes ago Up 2 minutes 3306/tcp spider
    ...
    ```

- - terminal 2

    ```bash
    jeff@jeff-VirtualBox:~$ docker exec -it korea1 bash
    root@b213421a26f8:/#
    root@b213421a26f8:/# apt-get update
    root@b213421a26f8:/# apt-get install net-tools && ifconfig
    root@b213421a26f8:/# apt-get install -y iputils-ping
    root@b213421a26f8:/# ifconfig
    eth0: 172.17.0.4
    ```

- - terminal 3

    ```bash
    jeff@jeff-VirtualBox:~$ docker exec -it korea2 bash
    root@2b14ce03d85d:/#
    root@2b14ce03d85d:/# apt-get update
    root@2b14ce03d85d:/# apt-get install net-tools && ifconfig
    root@2b14ce03d85d:/# apt-get install -y iputils-ping
    root@2b14ce03d85d:/# ifconfig
    eth0: 172.17.0.5
    ```

- - terminal 4★★★★★★

    ```bash
    jeff@jeff-VirtualBox:~$ docker inspect spider | grep "IPAddress"
    "SecondaryIPAddresses": null,
    "IPAddress": "172.17.0.3",
    "IPAddress": "172.17.0.3",
    jeff@jeff-VirtualBox:~$ docker inspect korea1 | grep "IPAddress"
    "SecondaryIPAddresses": null,
    "IPAddress": "172.17.0.4",
    "IPAddress": "172.17.0.4",
    jeff@jeff-VirtualBox:~$ docker inspect korea2 | grep "IPAddress"
    "SecondaryIPAddresses": null,
    "IPAddress": "172.17.0.5",
    "IPAddress": "172.17.0.5",
    ```

- - terminal 2~3 모두 수행

    ```bash
    root@b213421a26f8:/# cd /usr/share/mysql
    root@b213421a26f8:/usr/share/mysql# mysql -uroot -p < /usr/share/mysql/install_spider.sql
    Enter password:
    root@b213421a26f8:/usr/share/mysql# mysql -uroot -p
    MariaDB [(none)]> show databases;
    MariaDB [(none)]> show engines;
    +--------------------+---------+--------------------------------------------------------------------------------------------------+--------------+------+------------+
    | Engine | Support | Comment | Transactions | XA | Savepoints |
    +--------------------+---------+--------------------------------------------------------------------------------------------------+--------------+------+------------+
    | SPIDER | YES | Spider storage engine | YES | YES | NO |
    ...
    ```

- - terminal 1, 2, 3 에 모두 수행

    ```bash
    MariaDB [(none)]> use mysql;
    Reading table information for completion of table and column names
    You can turn off this feature to get a quicker startup with -A
    Database changed
    MariaDB [mysql]> create user 'spider-user'@'%' identified by 'spiderpass';
    Query OK, 0 rows affected (0.00 sec)

    MariaDB [mysql]> grant all on *.* to 'spider-user'@'%' with grant option;
    Query OK, 0 rows affected (0.00 sec)

    MariaDB [mysql]> flush privileges;
    Query OK, 0 rows affected (0.00 sec)

    MariaDB [(none)]> create database koreaDB;
    ```

- - terminal 1 (master)

    ```bash
    MariaDB [(none)]> use koreaDB;
    MariaDB [(koreaDB)]> create server korea1
    ->  foreign data wrapper mysql
    -> options(
    ->  host '172.17.0.3',
    ->  database 'koreaDB',
    ->  user 'spider-user',
    ->  password 'spiderpass',
    ->  port 3306
    -> );

    Query OK, 0 rows affected (0.00 sec)

    MariaDB [(koreaDB)]> create server korea2
    ->  foreign data wrapper mysql
    -> options(
    ->  host '172.17.0.4',
    ->  database 'koreaDB',
    ->  user 'spider-user',
    ->  password 'spiderpass',
    ->  port 3306
    -> );

    Query OK, 0 rows affected (0.00 sec)

    MariaDB [(koreaDB)]> select * from mysql.servers;
    +-------------+------------+---------+-------------+-----------+------+--------+---------+-------+
    | Server_name | Host       | Db      | Username    | Password  | Port | Socket | Wrapper | Owner |
    +-------------+------------+---------+-------------+-----------+------+--------+---------+-------+
    | korea1      | 172.17.0.3 | koreaDB | spider-user | koreapass | 3306 |        | mysql   |       |
    | korea2      | 172.17.0.4 | koreaDB | spider-user | koreapass | 3306 |        | mysql   |       |
    +-------------+------------+---------+-------------+-----------+------+--------+---------+-------+
    2 rows in set (0.01 sec)

    MariaDB [koreaDB]> create table shard_table
    -> (id int not null auto_increment
    -> , name varchar(255) not null
    -> , address varchar(255) not null
    -> , primary key(id))
    -> engine=spider comment='wrapper "mysql", table "shard_table"'
    -> partition by key(id)
    -> ( partition korea1 comment = 'srv "korea1"'
    -> , partition korea2 comment = 'srv "korea2"' );
    Query OK, 0 rows affected (0.04 sec)

    MariaDB [koreaDB]> FLUSH TABLES;
    Query OK, 0 rows affected (0.03 sec)
    ```

- - terminal 2~3

    ```bash
    root@2b14ce03d85d:~# mysql -uroot -p
    Enter password:

    MariaDB [(none)]> use koreaDB;
    MariaDB [koreaDB]> create table shard_table
    -> (
    ->  id int not null auto_increment,
    ->  name varchar(255) not null,
    ->  address varchar(255) not null,
    ->  primary key(id)
    -> );
    Query OK, 0 rows affected (0.08 sec)

    MariaDB [koreaDB]> select * from shard_table;
    Empty set (0.00 sec)

    MariaDB [koreaDB]> FLUSH TABLES;
    Query OK, 0 rows affected (0.03 sec)
    ```

- - terminal 1 (spider-db)

    ```bash
    insert into shard_table(name, address) values ('kim', 'seoul');
    insert into shard_table(name, address) values ('lee', 'seoul');
    insert into shard_table(name, address) values ('park', 'seoul');
    insert into shard_table(name, address) values ('kim', 'busan');
    insert into shard_table(name, address) values ('lee', 'daegu');
    insert into shard_table(name, address) values ('park', 'jeju');
    ...(여러번 수행)
    select * from shard_table;
    ```

- - (Terminal 2, 3)_korea1,2에서도 각각 확인

    ```bash
    select * from shard_table;
    ```

```bash
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>"Hi~ Docker~!"</title>
</head>
<body>
    <h1>"Welcome to Docker World~~"</h1>
</body>
</html>
```
