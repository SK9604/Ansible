# 네트워크

Docker Container 네트워크 설정

```bash
~$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       docker-host01
192.168.56.101 docker-host01
192.168.56.102 docker-host02
192.168.56.103 docker-host03
# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

```bash
ping : packet internet groper
lb - cluster와 3개의 컨테이너

DNS : ping 8.8.8.8

MAC address
08:00:27  
11:22:33

jeff@docker-host01:~$ docker run -d -p 8001:80 nginx:1.19
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS          PORTS                  NAMES
8ed7a1bcddfc   nginx:1.19   "/docker-entrypoint.…"   20 seconds ago   Up 12 seconds   0.0.0.0:8001->80/tcp   sleepy_cartwright
jeff@docker-host01:~$ docker port sleepy_cartwright
80/tcp -> 0.0.0.0:8001
jeff@docker-host01:~$ sudo netstat -nlp | grep 8001
[sudo] password for jeff:
tcp        0      0 0.0.0.0:8001            0.0.0.0:*               LISTEN      3714/docker-proxy
jeff@docker-host01:~$ ps -ef | grep 3714
root      3714  1733  0 09:50 ?        00:00:00 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 8001 -container-ip 172.17.0.2 -container-port 80
jeff      4805  2935  0 09:51 pts/1    00:00:00 grep --color=auto 3714

--expose 옵션
jeff@docker-host01:~$ docker run -d -p 8002:80 --expose=90 nginx:1.19
ac3227663c864643ba6048bbd4af3ced15851acfe4504a9cee8cb73d685816b8
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS         PORTS                          NAMES
ac3227663c86   nginx:1.19   "/docker-entrypoint.…"   3 seconds ago   Up 2 seconds   90/tcp, 0.0.0.0:8002->80/tcp   bold_kapitsa
8ed7a1bcddfc   nginx:1.19   "/docker-entrypoint.…"   2 minutes ago   Up 2 minutes   0.0.0.0:8001->80/tcp           sleepy_cartwright

--net 옵션
jeff@docker-host01:~$ docker info | grep Network
WARNING: No swap limit support
  Network: bridge host ipvlan macvlan null overlay

-p 8002:
```

### Docker Container 네트워크 설정

```bash

jeff@docker-host01:~$ docker run -d -p 8001:80 nginx:1.19
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS          PORTS                  NAMES
8ed7a1bcddfc   nginx:1.19   "/docker-entrypoint.…"   20 seconds ago   Up 12 seconds   0.0.0.0:8001->80/tcp   sleepy_cartwright
jeff@docker-host01:~$ docker port sleepy_cartwright
80/tcp -> 0.0.0.0:8001
jeff@docker-host01:~$ sudo netstat -nlp | grep 8001
[sudo] password for jeff:
tcp        0      0 0.0.0.0:8001            0.0.0.0:*               LISTEN      3714/docker-proxy
jeff@docker-host01:~$ ps -ef | grep 3714
root      3714  1733  0 09:50 ?        00:00:00 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 8001 -container-ip 172.17.0.2 -container-port 80
jeff      4805  2935  0 09:51 pts/1    00:00:00 grep --color=auto 3714

--expose 옵션
jeff@docker-host01:~$ docker run -d -p 8002:80 --expose=90 nginx:1.19
ac3227663c864643ba6048bbd4af3ced15851acfe4504a9cee8cb73d685816b8
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS         PORTS                          NAMES
ac3227663c86   nginx:1.19   "/docker-entrypoint.…"   3 seconds ago   Up 2 seconds   90/tcp, 0.0.0.0:8002->80/tcp   bold_kapitsa
8ed7a1bcddfc   nginx:1.19   "/docker-entrypoint.…"   2 minutes ago   Up 2 minutes   0.0.0.0:8001->80/tcp           sleepy_cartwright

--net 옵션
jeff@docker-host01:~$ docker info | grep Network
WARNING: No swap limit support
  Network: bridge host ipvlan macvlan null overlay

-p 8002:80 = 명시적으로 호스트:컨테이너 를 연결
-P = 컨테이너 내부에 expose된 포트와(nginx:80) 호스트 포트(32768~)를 자동으로 연결
jeff@docker-host01:~$ docker run -d -P nginx:1.19
ce17cfe2dc7ca3ec87dcbe04fe6cebd370d69dbf82dde88b5ca3d0fe4960e565
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS         PORTS                          NAMES
ce17cfe2dc7c   nginx:1.19   "/docker-entrypoint.…"   6 seconds ago    Up 4 seconds   0.0.0.0:49153->80/tcp          ecstatic_lamarr
ac3227663c86   nginx:1.19   "/docker-entrypoint.…"   7 minutes ago    Up 7 minutes   90/tcp, 0.0.0.0:8002->80/tcp   bold_kapitsa
8ed7a1bcddfc   nginx:1.19   "/docker-entrypoint.…"   10 minutes ago   Up 9 minutes   0.0.0.0:8001->80/tcp           sleepy_cartwright

```

### Docker-proxy(process)

Host가 받은 패킷을 그대로 Container의 port로 전달

```bash
jeff@docker-host01:~$ docker run -it --dns=8.8.8.8 centos bash
Unable to find image 'centos:latest' locally
latest: Pulling from library/centos
7a0437f04f83: Pull complete
Digest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1
Status: Downloaded newer image for centos:latest
[root@2f583fcde3ab /]# cat /etc/resolv.conf
nameserver 8.8.8.8
[root@2f583fcde3ab /]# exit
exit
jeff@docker-host01:~$ docker container run -d --mac-address="92:d0:c6:0a:29:33"                            centos:7
```

### iptraf-ng

```bash
jeff@docker-host01:~$ sudo apt-get -y install iptraf-ng
E: Could not get lock /var/lib/dpkg/lock - open (11: Resource temporarily unavailable)
E: Unable to lock the administration directory (/var/lib/dpkg/), is another process using it?
jeff@docker-host01:~$ sudo rm /var/lib/dpkg/lock*
jeff@docker-host01:~$ sudo apt-get -y install iptraf-ng
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following NEW packages will be installed:
  iptraf-ng
0 upgraded, 1 newly installed, 0 to remove and 431 not upgraded.
2 not fully installed or removed.
Need to get 291 kB of archives.
After this operation, 758 kB of additional disk space will be used.
Get:1 http://kr.archive.ubuntu.com/ubuntu bionic/main amd64 iptraf-ng amd64 1:1.1.4-6 [291 kB]
Fetched 291 kB in 2s (137 kB/s)
Selecting previously unselected package iptraf-ng.
(Reading database ... 132016 files and directories currently installed.)
Preparing to unpack .../iptraf-ng_1%3a1.1.4-6_amd64.deb ...
Unpacking iptraf-ng (1:1.1.4-6) ...
Setting up docker-ce (5:20.10.5~3-0~ubuntu-bionic) ...
Setting up iptraf-ng (1:1.1.4-6) ...
Setting up docker-ce-rootless-extras (5:20.10.5~3-0~ubuntu-bionic) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
W: APT had planned for dpkg to do more than it reported back (8 vs 12).
   Affected packages: docker-ce:amd64
jeff@docker-host01:~$ sudo iptraf-ng
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bdb80bde-2ad8-4961-9a49-67cd01cb5f03/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bdb80bde-2ad8-4961-9a49-67cd01cb5f03/Untitled.png)

### 네트워크 만들기

`docker network create network_name`

docker0 bridge는 소프트웨어적인 스위치방식. 일반적인 스위치 개념과는 다르게 DHCP로 연결된 container에게 사전에 정의된 IP Pool을 할당. 

독립된 네트워크 망 : 172.18.X.X 대역으로

### **host 네트워크** : port forwarding이 필요 없다.

컨테이너의 네트워크를 호스트 모드로 설정하면 컨테이너 내부의 어플리케이션을 별도의 포트 포워딩 없이 바로 서비스 할 수 있다.

```bash
//nginx 이미지에 노출된 포트 80번을 호스트 포트 80번에 연결 호스트 IP를 이용하여 서비스
jeff@docker-host01:~$ docker run -d --name=nginx_host \
> --net=host \
> nginx
Unable to find image 'nginx:latest' locally
latest: Pulling from library/nginx
Digest: sha256:f3693fe50d5b1df1ecd315d54813a77afd56b0245a404055a946574deb6b34fc
Status: Downloaded newer image for nginx:latest
b7957b40fb2b545fe8e899874d55a673004c2a938b3434d7e20de0d4491e926f
jeff@docker-host01:~$ sudo netstat -nlp | grep 80
[sudo] password for jeff:
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      7483/nginx: master
tcp6       0      0 :::80                   :::*                    LISTEN      7483/nginx: master
jeff@docker-host01:~$ curl localhost:80
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>

// -p 옵션으로 포트를 연결한 경우에는 docker-proxy를 이용했지만, 
	출력된 결과를 보면 호스트 운영체제에 직접 PID를 할당 받아 서비스하는 것을 알 수 있다.
jeff@docker-host01:~$ ps -ef | grep 7483
root      7483  7454  0 10:38 ?        00:00:00 nginx: master process nginx -g daemon off;
systemd+  7540  7483  0 10:38 ?        00:00:00 nginx: worker process   <=<= 호스트 운영체제
jeff      7588  2935  0 10:39 pts/1    00:00:00 grep --color=auto 7483

// 따라서 컨테이너에는 별도의 IP를 부여할 필요가 없어진다.
jeff@docker-host01:~$ docker inspect nginx_host | grep IPAddress
            "SecondaryIPAddresses": null,
            "IPAddress": "",
                    "IPAddress": "",
```

### bridge 네트워크

```bash
-d : driver 옵션
jeff@docker-host01:~$ docker network create -d bridge webap-net
a89fe8e918d6fc76890735513ffceeb9df550f42f1568f496bd117115a000b0f
jeff@docker-host01:~$ route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         _gateway        0.0.0.0         UG    100    0        0 enp0s3
10.0.2.0        0.0.0.0         255.255.255.0   U     100    0        0 enp0s3
link-local      0.0.0.0         255.255.0.0     U     1000   0        0 enp0s3
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-a89fe8e918d6 <<
192.168.56.0    0.0.0.0         255.255.255.0   U     101    0        0 enp0s8
jeff@docker-host01:~$ ifconfig
br-a89fe8e918d6: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
        inet 172.18.0.1  netmask 255.255.0.0  broadcast 172.18.255.255
        ether 02:42:04:4b:65:ef  txqueuelen 0  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
...
jeff@docker-host01:~$ docker network ls
NETWORK ID     NAME        DRIVER    SCOPE
5f14e733d72d   bridge      bridge    local
6c8d61d65e81   host        host      local
dd3daf2aca85   none        null      local
a89fe8e918d6   webap-net   bridge    local  <<
jeff@docker-host01:~$ brctl show

Command 'brctl' not found, but can be installed with:

sudo apt install bridge-utils

jeff@docker-host01:~$ sudo apt install bridge-utils
jeff@docker-host01:~$ brctl show
bridge name     bridge id               STP enabled     interfaces
br-a89fe8e918d6         8000.0242044b65ef       no  <<
docker0         8000.024288fee721       no
jeff@docker-host01:~$ docker run --net=webap-net -it --name=net-check ubuntu:14.04 bash
=============
새로운 터미널(Terminal 2)
=============

jeff@docker-host01:~$ brctl show
bridge name     bridge id               STP enabled     interfaces
br-a89fe8e918d6         8000.0242044b65ef       no              veth54ec08b  <<
docker0         8000.024288fee721       no
jeff@docker-host01:~$ docker network inspect webap-net
[
    {
        "Name": "webap-net",
        "Id": "a89fe8e918d6fc76890735513ffceeb9df550f42f1568f496bd117115a000b0f",
        "Created": "2021-03-10T10:51:12.669273859+09:00",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": {},
            "Config": [
                {
                    "Subnet": "172.18.0.0/16",
                    "Gateway": "172.18.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Containers": {},
        "Options": {},
        "Labels": {}
    }
]
jeff@docker-host01:~$ docker exec net-check route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         docker-host01   0.0.0.0         UG    0      0        0 eth0
172.18.0.0      *               255.255.0.0     U     0      0        0 eth0
```

```bash
jeff@docker-host01:~$ docker network create \
> --driver bridge \
> --subnet 172.100.1.0/24 \
> --ip-range 172.100.1.0/24 \
> --gateway 172.100.1.1 \
> vswitch-ap
1bc504426b1fae345348bd2bd4ceefdeae55665d2da8a21a839c71a4899fb490
jeff@docker-host01:~$ docker network ls
NETWORK ID     NAME         DRIVER    SCOPE
5f14e733d72d   bridge       bridge    local
6c8d61d65e81   host         host      local
dd3daf2aca85   none         null      local
1bc504426b1f   vswitch-ap   bridge    local
a89fe8e918d6   webap-net    bridge    local
jeff@docker-host01:~$ docker network inspect vswitch-ap
[
    {
        "Name": "vswitch-ap",
        "Id": "1bc504426b1fae345348bd2bd4ceefdeae55665d2da8a21a839c71a4899fb490",
        "Created": "2021-03-10T11:04:40.211073582+09:00",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": {},
            "Config": [
                {
                    "Subnet": "172.100.1.0/24",
                    "IPRange": "172.100.1.0/24",
                    "Gateway": "172.100.1.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Containers": {},
        "Options": {},
        "Labels": {}
    }
]
jeff@docker-host01:~$ docker run --net=vswitch-ap -itd --name=net1 ubuntu:14.04
28a2b04bb234d7c1de3343d27f10c7f29d514a5a30e5122e43280d1c56a7ae50
jeff@docker-host01:~$ docker run --net=vswitch-ap -itd --name=net2 --ip 172.100.1.100 ubuntu:14.04
b483f6aa61cf013325b3a9961974912846393a3f6f0320cb6e59f64c2033d0c7
jeff@docker-host01:~$ docker inspect net1 | grep IPAddress
            "SecondaryIPAddresses": null,
            "IPAddress": "",
                    "IPAddress": "172.100.1.2",
jeff@docker-host01:~$ docker inspect net2 | grep IPAddress
            "SecondaryIPAddresses": null,
            "IPAddress": "",
                    "IPAddress": "172.100.1.100",
jeff@docker-host01:~$ brctl show
bridge name     bridge id               STP enabled     interfaces
br-1bc504426b1f         8000.0242ce9bdeac       no              veth71d9c51
                                                        vethed1eec3
br-a89fe8e918d6         8000.0242044b65ef       no
docker0         8000.024288fee721       no
jeff@docker-host01:~$ route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         _gateway        0.0.0.0         UG    100    0        0 enp0s3
10.0.2.0        0.0.0.0         255.255.255.0   U     100    0        0 enp0s3
link-local      0.0.0.0         255.255.0.0     U     1000   0        0 enp0s3
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-a89fe8e918d6
172.100.1.0     0.0.0.0         255.255.255.0   U     0      0        0 br-1bc504426b1f
192.168.56.0    0.0.0.0         255.255.255.0   U     101    0        0 enp0s8
jeff@docker-host01:~$ docker exec net1 route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         cpe-172-100-1-1 0.0.0.0         UG    0      0        0 eth0
172.100.1.0     *               255.255.255.0   U     0      0        0 eth0
jeff@docker-host01:~$ nmcli
enp0s3: connected to Wired connection 1
        "Intel 82540EM Gigabit Ethernet Controller (PRO/1000 MT Desktop Adapter)"
        ethernet (e1000), 08:00:27:A6:E0:62, hw, mtu 1500
        ip4 default
        inet4 10.0.2.15/24
        route4 0.0.0.0/0
        route4 10.0.2.0/24
        route4 169.254.0.0/16
        inet6 fe80::c448:b5c2:a673:1590/64
        route6 ff00::/8
        route6 fe80::/64
        route6 fe80::/64

br-1bc504426b1f: connected to br-1bc504426b1f
        "br-1bc504426b1f"
        bridge, 02:42:CE:9B:DE:AC, sw, mtu 1500
        inet4 172.100.1.1/24
        route4 172.100.1.0/24
        inet6 fe80::42:ceff:fe9b:deac/64
        route6 ff00::/8
        route6 fe80::/64

br-a89fe8e918d6: connected to br-a89fe8e918d6
        "br-a89fe8e918d6"
        bridge, 02:42:04:4B:65:EF, sw, mtu 1500
        inet4 172.18.0.1/16
        route4 172.18.0.0/16
        inet6 fe80::42:4ff:fe4b:65ef/64
        route6 ff00::/8
        route6 fe80::/64
```

### Docker0의 대역  - 실습 X

docker0의 172.17.0.1 컨테이너 관리

docker0의 이름과 네트워크 대역을 바꿀 수 있을까?

→ 가능하다!

```bash
~$ ip link
~$ ip addr
~$ sudo ip link set dev docker0 down
~$ sudo ip addr add 192.168.99.0/24 dev docker0
~$ sudo ip link set dev docker0 up
~$ ifconfig docker0
```

```bash
# docker service stop
~$ sudo service docker stop
~$ sudo ip link set dev docker0 down

# docker0를 br에서 삭제
~$ sudo brctl delbr docker0

~$ sudo iptables –t nat –F POSTROUTING

# 신규 default bridge net 이름 등록 및 추가
~$ echo 'DOCKER_OPTS="-b=new-br0"' >> /etc/default/docker
~$ sudo brctl addbr new-br0
~$ sudo ip addr add 192.168.99.0/24 dev new-br0
~$ sudo ip link set dev new-br0 up
~$ sudo service docker start
~$ ifconfig new-br0
```

### 컨테이너 간 IP 공유

`--net  container=container_name`

IP가 없어도 같은 대역의 컨테이너는 서로 통신이 가능하다

```bash
jeff@docker-host01:~$ docker run -it -d --name net_container_1 ubuntu:14.04
aab79b34065d7ce8a245e40eb561c267a3725cbf8beb6578eec34b848a7c0743
jeff@docker-host01:~$ docker run -itd --name net_container_2 \
> --net container:net_container_1 \
> ubuntu:14.04
25da24769d9911e28c09daf61c09b95befc1a89864c52bbea10651d09fe0b567
jeff@docker-host01:~$ docker exec net_container_1 ifconfig
eth0      Link encap:Ethernet  HWaddr 02:42:ac:11:00:02
          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
 
jeff@docker-host01:~$ docker exec net_container_2 ifconfig
eth0      Link encap:Ethernet  HWaddr 02:42:ac:11:00:02
          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
```

—→ ip주소와 MAC주소가 완벽히 일치한다

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/93e37758-8ffa-4cc9-9637-0e068ca59c04/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/93e37758-8ffa-4cc9-9637-0e068ca59c04/Untitled.png)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a131d744-f8b6-4a28-8808-af3db9139f90/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a131d744-f8b6-4a28-8808-af3db9139f90/Untitled.png)

### —net=container: 실습

```bash
jeff@docker-host01:~$ docker run -d --name=httpd-server httpd
eb823b6b3e4401860269d24f050f482c6b6cc4d13cdf3802add9c54586cadb54
jeff@docker-host01:~$ docker run -d --name=redis-server --net=container:httpd-server redis
f0f6f64efcc79ff1df3cd2f9436edf5a42ea0c1d4eaedd837bda146e8b81595e
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS     NAMES
f0f6f64efcc7   redis          "docker-entrypoint.s…"   6 seconds ago    Up 3 seconds              redis-server
eb823b6b3e44   httpd          "httpd-foreground"       2 minutes ago    Up 2 minutes    80/tcp    httpd-server
25da24769d99   ubuntu:14.04   "/bin/bash"              26 minutes ago   Up 26 minutes             net_container_2
aab79b34065d   ubuntu:14.04   "/bin/bash"              27 minutes ago   Up 27 minutes             net_container_1
b483f6aa61cf   ubuntu:14.04   "/bin/bash"              36 minutes ago   Up 36 minutes             net2
28a2b04bb234   ubuntu:14.04   "/bin/bash"              37 minutes ago   Up 37 minutes             net1
jeff@docker-host01:~$ docker inspect httpd-server | grep IPAddress
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.3",
                    "IPAddress": "172.17.0.3",
jeff@docker-host01:~$ docker inspect redis-server | grep IPAddress
            "SecondaryIPAddresses": null,
            "IPAddress": "",
jeff@docker-host01:~$ brctl show
bridge name     bridge id               STP enabled     interfaces
br-1bc504426b1f         8000.0242ce9bdeac       no              veth71d9c51
                                                        vethed1eec3
br-a89fe8e918d6         8000.0242044b65ef       no
docker0         8000.024288fee721       no              veth011cfcf
                                                        vethd9a31c0
jeff@docker-host01:~$ docker network inspect bridge
[
    {
        "Name": "bridge",
        "Id": "5f14e733d72d9ebfb4577a2ea704e66d48d0637cdde5bb1a7ac75581650bcbbd",
        "Created": "2021-03-09T19:25:39.149664019+09:00",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": null,
            "Config": [
                {
                    "Subnet": "172.17.0.0/16",
                    "Gateway": "172.17.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Containers": {
            "aab79b34065d7ce8a245e40eb561c267a3725cbf8beb6578eec34b848a7c0743": {
                "Name": "net_container_1",
                "EndpointID": "1aad773d7572e85b5829aa5c696694b1fbeb68d62d346c74db0f16b814e81fe3",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            },
            "eb823b6b3e4401860269d24f050f482c6b6cc4d13cdf3802add9c54586cadb54": {
                "Name": "httpd-server",
                "EndpointID": "0dfd1136b16994b649eb9721031ce774444c5bf83d67822bc9fd5b2b994da167",
                "MacAddress": "02:42:ac:11:00:03",
                "IPv4Address": "172.17.0.3/16",
                "IPv6Address": ""
            }
        },
        "Options": {
            "com.docker.network.bridge.default_bridge": "true",
            "com.docker.network.bridge.enable_icc": "true",
            "com.docker.network.bridge.enable_ip_masquerade": "true",
            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",
            "com.docker.network.bridge.name": "docker0",
            "com.docker.network.driver.mtu": "1500"
        },
        "Labels": {}
    }
]
```

### vethxxxx 가상 host의 숫자보다 하나 작은 값을 가진다

```bash
jeff@docker-host01:~$ brctl show
bridge name     bridge id               STP enabled     interfaces
br-1bc504426b1f         8000.0242ce9bdeac       no              veth71d9c51
                                                        vethed1eec3
br-a89fe8e918d6         8000.0242044b65ef       no
docker0         8000.024288fee721       no              veth011cfcf
                                                        vethd9a31c0
jeff@docker-host01:~$ docker run -itd --name=ub_test1 ubuntu:14.04
67637a0e85d161040eeaeaba29530583a91618df98000f6e65001010342f3c15
jeff@docker-host01:~$ brctl show
bridge name     bridge id               STP enabled     interfaces
br-1bc504426b1f         8000.0242ce9bdeac       no              veth71d9c51
                                                        vethed1eec3
br-a89fe8e918d6         8000.0242044b65ef       no
docker0         8000.024288fee721       no              veth011cfcf
                                                        vethd97a947   <<
                                                        vethd9a31c0
jeff@docker-host01:~$ docker exec ub_test1 ip addr show eth0
29: eth0@if30: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:ac:11:00:04 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.4/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
jeff@docker-host01:~$ sudo su -
[sudo] password for jeff:
root@docker-host01:~# cat /sys/class/net/vethd97a947/ifindex
30
root@docker-host01:~# exit
logout
jeff@docker-host01:~$ docker exec -it ub_test1 bash
root@67637a0e85d1:/# cat /sys/class/net/eth0/iflink
30
```

### 컨테이너끼리 통신할 수 있는 개별 네트워크 구성

```bash
=======
terminal 1
=======
jeff@docker-host01:~$ docker network create appdb-net
f1b1f071026b361b0214db28764bda74991d130b3e9038ab39975c7b09084003
jeff@docker-host01:~$ docker network ls
NETWORK ID     NAME         DRIVER    SCOPE
f1b1f071026b   appdb-net    bridge    local
5f14e733d72d   bridge       bridge    local
6c8d61d65e81   host         host      local
dd3daf2aca85   none         null      local
1bc504426b1f   vswitch-ap   bridge    local
a89fe8e918d6   webap-net    bridge    local
jeff@docker-host01:~$ sudo apt install bridge-utils
Reading package lists... Done
Building dependency tree
Reading state information... Done
bridge-utils is already the newest version (1.5-15ubuntu1).
0 upgraded, 0 newly installed, 0 to remove and 145 not upgraded.
jeff@docker-host01:~$ brctl show
bridge name     bridge id               STP enabled     interfaces
br-1bc504426b1f         8000.0242ce9bdeac       no              veth71d9c51
                                                        vethed1eec3
br-a89fe8e918d6         8000.0242044b65ef       no
br-f1b1f071026b         8000.02422db63472       no
docker0         8000.024288fee721       no              veth011cfcf
                                                        vethd97a947
                                                        vethd9a31c0
=======
terminal 2
=======
jeff@docker-host01:~$ docker run --name ubuntu1 -it --network=appdb-net ubuntu:14.04 /bin/bash
root@7c5521c0ba4c:/#

=======
terminal 3
=======
jeff@docker-host01:~$ docker run --name ubuntu2 -it --network=appdb-net ubuntu:14.04 /bin/bash
root@81c55cec95e0:/#

=======
terminal 1
=======
jeff@docker-host01:~$ brctl show
bridge name     bridge id               STP enabled     interfaces
br-1bc504426b1f         8000.0242ce9bdeac       no              veth71d9c51
                                                        vethed1eec3
br-a89fe8e918d6         8000.0242044b65ef       no
br-f1b1f071026b         8000.02422db63472       no              vethc444c1e
                                                        vethf3307ca
docker0         8000.024288fee721       no              veth011cfcf
                                                        vethd97a947
                                                        vethd9a31c0
=======
terminal 2
=======
root@7c5521c0ba4c:/# ping ubuntu2
PING ubuntu2 (172.19.0.3) 56(84) bytes of data.
64 bytes from ubuntu2.appdb-net (172.19.0.3): icmp_seq=1 ttl=64 time=0.052 ms
64 bytes from ubuntu2.appdb-net (172.19.0.3): icmp_seq=2 ttl=64 time=0.039 ms
^C
--- ubuntu2 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1030ms
rtt min/avg/max/mdev = 0.039/0.045/0.052/0.009 ms
=======
terminal 3
=======
root@81c55cec95e0:/# ping ubuntu1
PING ubuntu1 (172.19.0.2) 56(84) bytes of data.
64 bytes from ubuntu1.appdb-net (172.19.0.2): icmp_seq=1 ttl=64 time=0.036 ms
64 bytes from ubuntu1.appdb-net (172.19.0.2): icmp_seq=2 ttl=64 time=0.040 ms
64 bytes from ubuntu1.appdb-net (172.19.0.2): icmp_seq=3 ttl=64 time=0.042 ms
^C
--- ubuntu1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2055ms
rtt min/avg/max/mdev = 0.036/0.039/0.042/0.005 ms
```

- 서로 ping을 보내는 동안 cadvisor 확인

## LoadBalancer Demo

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8b57a1f9-fce6-45bd-98fe-7c065911b337/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8b57a1f9-fce6-45bd-98fe-7c065911b337/Untitled.png)

```bash
jeff@docker-host01:~$ docker network create \
> --driver bridge \
> --subnet 172.200.1.0/24 \
> --ip-range 172.200.1.0/24 \
> --gateway 172.200.1.1 \
> netlb
deb0065c72cf8d1ef969ca9aa975febc55b9ff0b0fc5d2f5ccd20de9a8fa3a3d
jeff@docker-host01:~$ docker network ls
NETWORK ID     NAME         DRIVER    SCOPE
f1b1f071026b   appdb-net    bridge    local
5f14e733d72d   bridge       bridge    local
6c8d61d65e81   host         host      local
deb0065c72cf   netlb        bridge    local
dd3daf2aca85   none         null      local
1bc504426b1f   vswitch-ap   bridge    local
a89fe8e918d6   webap-net    bridge    local
jeff@docker-host01:~$ docker run -itd --name=netlbtest1 --net=netlb --net-alias inner-net ubuntu:14.04
2216769206a1e291ba95344b8637eb0b583a33ed85761feac9e642045f911a77
jeff@docker-host01:~$ docker run -itd --name=netlbtest2 --net=netlb --net-alias inner-net ubuntu:14.04
d0008a998fd1aa6a36914306326bfd6a7a994c3e7f26d5186c74a655fb71e843
jeff@docker-host01:~$ docker run -itd --name=netlbtest3 --net=netlb --net-alias inner-net ubuntu:14.04
5cf35e7009b52be4175c38164ac0b3b9649291e91e8ce7225f39f677ae8839c8
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED              STATUS              PORTS                    NAMES
5cf35e7009b5   ubuntu:14.04             "/bin/bash"              About a minute ago   Up About a minute                            netlbtest3
d0008a998fd1   ubuntu:14.04             "/bin/bash"              About a minute ago   Up About a minute                            netlbtest2
2216769206a1   ubuntu:14.04             "/bin/bash"              About a minute ago   Up About a minute                            netlbtest1
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   31 minutes ago       Up 31 minutes       0.0.0.0:9559->8080/tcp   cadvisor
jeff@docker-host01:~$ brctl show
bridge name     bridge id               STP enabled     interfaces
br-1bc504426b1f         8000.0242ce9bdeac       no
br-a89fe8e918d6         8000.0242044b65ef       no
br-deb0065c72cf         8000.0242a6b03d75       no              veth21ca2c0
                                                        veth7548476
                                                        veth86f1ab5
br-f1b1f071026b         8000.02422db63472       no
docker0         8000.024288fee721       no              veth9326eb2
jeff@docker-host01:~$ docker inspect netlbtest1 | grep IPA
            "SecondaryIPAddresses": null,
            "IPAddress": "",
                    "IPAMConfig": null,
                    "IPAddress": "172.200.1.2",
jeff@docker-host01:~$ docker inspect netlbtest2 | grep IPA
            "SecondaryIPAddresses": null,
            "IPAddress": "",
                    "IPAMConfig": null,
                    "IPAddress": "172.200.1.3",
jeff@docker-host01:~$ docker inspect netlbtest3 | grep IPA
            "SecondaryIPAddresses": null,
            "IPAddress": "",
                    "IPAMConfig": null,
                    "IPAddress": "172.200.1.4",
jeff@docker-host01:~$ docker run -it --name=frontend --net=netlb ubuntu:14.04 bash
root@ec959d053f11:/# ping -c 2 inner-net
PING inner-net (172.200.1.3) 56(84) bytes of data.
64 bytes from netlbtest2.netlb (172.200.1.3): icmp_seq=1 ttl=64 time=0.031 ms
64 bytes from netlbtest2.netlb (172.200.1.3): icmp_seq=2 ttl=64 time=0.044 ms

--- inner-net ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1025ms
rtt min/avg/max/mdev = 0.031/0.037/0.044/0.008 ms
root@ec959d053f11:/# ping -c 2 inner-net
PING inner-net (172.200.1.4) 56(84) bytes of data.
64 bytes from netlbtest3.netlb (172.200.1.4): icmp_seq=1 ttl=64 time=0.055 ms
64 bytes from netlbtest3.netlb (172.200.1.4): icmp_seq=2 ttl=64 time=0.049 ms

--- inner-net ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1022ms
rtt min/avg/max/mdev = 0.049/0.052/0.055/0.003 ms
root@ec959d053f11:/# ping -c 2 inner-net
PING inner-net (172.200.1.2) 56(84) bytes of data.
64 bytes from netlbtest1.netlb (172.200.1.2): icmp_seq=1 ttl=64 time=0.080 ms
64 bytes from netlbtest1.netlb (172.200.1.2): icmp_seq=2 ttl=64 time=0.041 ms

--- inner-net ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1015ms
rtt min/avg/max/mdev = 0.041/0.060/0.080/0.021 ms

--> docker dns가 inner-net 랜덤으로 뿌린다.

root@ec959d053f11:/# apt update
root@ec959d053f11:/# apt -y install dnsutils
root@ec959d053f11:/# dig inner-net

; <<>> DiG 9.9.5-3ubuntu0.19-Ubuntu <<>> inner-net
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 19897
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;inner-net.                     IN      A

;; ANSWER SECTION:   <<< 자동으로 등록되어있음. docker dns에서 관리해준다
inner-net.              600     IN      A       172.200.1.4
inner-net.              600     IN      A       172.200.1.2
inner-net.              600     IN      A       172.200.1.3

;; Query time: 0 msec
;; SERVER: 127.0.0.11#53(127.0.0.11)
;; WHEN: Wed Mar 10 03:46:04 UTC 2021
;; MSG SIZE  rcvd: 102

========
terminal 2
========
jeff@docker-host01:~$ docker run -itd --name=netlbtest4 --net=netlb --net-alias inner-net ubuntu:14.04
7ad30fd00fdea1e8e7061291cc656f93473f65f96170d30c492258a27a694670

========
terminal 1
========
root@ec959d053f11:/# dig inner-net

; <<>> DiG 9.9.5-3ubuntu0.19-Ubuntu <<>> inner-net
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 30064
;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;inner-net.                     IN      A

;; ANSWER SECTION:
inner-net.              600     IN      A       172.200.1.6 <<< 실시간으로 바로 추가!
inner-net.              600     IN      A       172.200.1.3
inner-net.              600     IN      A       172.200.1.4
inner-net.              600     IN      A       172.200.1.2

;; Query time: 0 msec
;; SERVER: 127.0.0.11#53(127.0.0.11)
;; WHEN: Wed Mar 10 03:47:47 UTC 2021
;; MSG SIZE  rcvd: 127
root@ec959d053f11:/# ping -c 2 inner-net
PING inner-net (172.200.1.6) 56(84) bytes of data.
64 bytes from netlbtest4.netlb (172.200.1.6): icmp_seq=1 ttl=64 time=0.068 ms
64 bytes from netlbtest4.netlb (172.200.1.6): icmp_seq=2 ttl=64 time=0.051 ms

--- inner-net ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1028ms
rtt min/avg/max/mdev = 0.051/0.059/0.068/0.011 ms
root@ec959d053f11:/# ping -c 2 inner-net
PING inner-net (172.200.1.2) 56(84) bytes of data.
64 bytes from netlbtest1.netlb (172.200.1.2): icmp_seq=1 ttl=64 time=0.092 ms
64 bytes from netlbtest1.netlb (172.200.1.2): icmp_seq=2 ttl=64 time=0.139 ms

--- inner-net ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1049ms
rtt min/avg/max/mdev = 0.092/0.115/0.139/0.025 ms
root@ec959d053f11:/# ping -c 2 inner-net
PING inner-net (172.200.1.4) 56(84) bytes of data.
64 bytes from netlbtest3.netlb (172.200.1.4): icmp_seq=1 ttl=64 time=0.054 ms
64 bytes from netlbtest3.netlb (172.200.1.4): icmp_seq=2 ttl=64 time=0.068 ms

--- inner-net ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1018ms
rtt min/avg/max/mdev = 0.054/0.061/0.068/0.007 ms
root@ec959d053f11:/# ping -c 2 inner-net
PING inner-net (172.200.1.3) 56(84) bytes of data.
64 bytes from netlbtest2.netlb (172.200.1.3): icmp_seq=1 ttl=64 time=0.042 ms
64 bytes from netlbtest2.netlb (172.200.1.3): icmp_seq=2 ttl=64 time=0.041 ms

--- inner-net ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1021ms
rtt min/avg/max/mdev = 0.041/0.041/0.042/0.006 ms
========
terminal 2
========
jeff@docker-host01:~$ sudo iptraf-ng
```

- terminal 1에서 핑 날리는 동안 terminal 2에서 모니터링

### nginx load balancing

docker container를 이용한 load balancer

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8aa8ea3e-f50a-40b7-9303-949cf0680fc0/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8aa8ea3e-f50a-40b7-9303-949cf0680fc0/Untitled.png)

```bash
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                    NAMES
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   50 minutes ago   Up 50 minutes   0.0.0.0:9559->8080/tcp   cadvisor

// ubuntu에 직접 nginx 설치
jeff@docker-host01:~$ sudo apt -y install nginx
jeff@docker-host01:~$ sudo systemctl status nginx.service
● nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: active (running) since Wed 2021-03-10 12:59:32 KST; 8min ago
     Docs: man:nginx(8)
  Process: 423 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=0/SUCCESS)
  Process: 410 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS
 Main PID: 427 (nginx)
    Tasks: 5 (limit: 4674)
   CGroup: /system.slice/nginx.service
           ├─427 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
           ├─430 nginx: worker process
           ├─432 nginx: worker process
           ├─435 nginx: worker process
           └─436 nginx: worker process

 3월 10 12:59:32 docker-host01 systemd[1]: Starting A high performance web server and a reverse proxy server...
 3월 10 12:59:32 docker-host01 systemd[1]: Started A high performance web server and a reverse proxy server.
jeff@docker-host01:~$ sudo netstat -nlp | grep 80
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      427/nginx: master p
tcp6       0      0 :::80                   :::*                    LISTEN      427/nginx: master p
unix  2      [ ACC ]     STREAM     LISTENING     180671   11519/gnome-keyring  /run/user/1000/keyring/control
unix  2      [ ACC ]     STREAM     LISTENING     180836   11519/gnome-keyring  /run/user/1000/keyring/ssh
```

- 192.168.56.101 접속 welcome to nginx 확인

— container 3개 띄우기 > 서로 포트가 달라야 한다! (NAPT)

```bash
jeff@docker-host01:~$ docker run -itd \
> -e SERVER_PORT-10001 -p 10001:10001 \
> -h nginx-lb-01 \
> --name=nginx-lb-01 \
> dbgurum/nginxlb:1.0
f61616d2548c61d8a3c8c48b3f560faa1d32c9ed9544f89f116b58dd537b8256
jeff@docker-host01:~$ docker run -itd -e SERVER_PORT-10002 -p 10002:10002 -h nginx-lb-02 --name=nginx-lb-02 dbgurum/nginxlb:1.0
4e8d00819ce86fb76ea5cd4af06c690e88ea79dd0061429d95323147457b715a
jeff@docker-host01:~$ docker run -itd -e SERVER_PORT-10003 -p 10003:10003 -h nginx-lb-03 --name=nginx-lb-03 dbgurum/nginxlb:1.0
c54b278be29557706a8d8defdc4271b7f9d80744c0de87f0f990f7df8e0162a2
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED              STATUS              PORTS                      NAMES
c54b278be295   dbgurum/nginxlb:1.0      "/cnb/lifecycle/laun…"   About a minute ago   Up About a minute   0.0.0.0:10003->10003/tcp   nginx-lb-03
4e8d00819ce8   dbgurum/nginxlb:1.0      "/cnb/lifecycle/laun…"   2 minutes ago        Up 2 minutes        0.0.0.0:10002->10002/tcp   nginx-lb-02
f61616d2548c   dbgurum/nginxlb:1.0      "/cnb/lifecycle/laun…"   3 minutes ago        Up 3 minutes        0.0.0.0:10001->10001/tcp   nginx-lb-01
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   3 hours ago          Up 3 hours          0.0.0.0:9559->8080/tcp     cadvisor
jeff@docker-host01:~$ sudo netstat -nlp | grep 10001
tcp        0      0 0.0.0.0:10001           0.0.0.0:*               LISTEN      2324/docker-proxy
jeff@docker-host01:~$ sudo netstat -nlp | grep 10002
tcp        0      0 0.0.0.0:10002           0.0.0.0:*               LISTEN      2679/docker-proxy
jeff@docker-host01:~$ sudo netstat -nlp | grep 10003
tcp        0      0 0.0.0.0:10003           0.0.0.0:*               LISTEN      3059/docker-proxy
```

— proxy 구성

```bash
jeff@docker-host01:~$ cd /etc/nginx/
jeff@docker-host01:/etc/nginx$ ls
conf.d          koi-utf     modules-available  proxy_params     sites-enabled  win-utf
fastcgi.conf    koi-win     modules-enabled    scgi_params      snippets
fastcgi_params  mime.types  nginx.conf         sites-available  uwsgi_params
jeff@docker-host01:/etc/nginx$ sudo mv nginx.conf nginx.conf.org
jeff@docker-host01:/etc/nginx$ ls
conf.d          koi-utf     modules-available  proxy_params     sites-enabled  win-utf
fastcgi.conf    koi-win     modules-enabled    scgi_params      snippets
fastcgi_params  mime.types  nginx.conf.org     sites-available  uwsgi_params
jeff@docker-host01:/etc/nginx$ sudo vi nginx.conf
events { worker_connections 100; }
http{
  upstream nginx-lb {
    server 127.0.0.1:10001 weight=60;
    server 127.0.0.1:10002 weight=20;
    server 127.0.0.1:10003 weight=20;
  }
  server {
    listen 80 default_server;
    listen [::]:80 default_server;
    location / {
      proxy_pass http://nginx-lb;
    }
  }
}
jeff@docker-host01:/etc/nginx$ sudo systemctl restart nginx.service
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d682f5e3-2ba8-4a27-94f9-7f71c2f151f1/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d682f5e3-2ba8-4a27-94f9-7f71c2f151f1/Untitled.png)

— 실습 완료 후 완전 삭제

```bash
jeff@docker-host01:~$ sudo apt-get --purge remove nginx*
jeff@docker-host01:~$ docker image rm 300e315adb2f
```

## 자원 소비 제어

- 제한적 자원을 사용한다. → 효율적 사용 → 독점 방지

`docker container run [리소스 옵션] <image명>[:태그명] [값]`

— 자원 모니터링

```bash
jeff@docker-host01:~$ vmstat 2 5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  0  60928 1146860 114528 1603996    0    1    26   125  164  204  7  1 91  1  0
 0  0  60928 1146932 114528 1604032    0    0     0     0  508  803  0  0 99  0  0
 0  0  60928 1147056 114528 1604032    0    0     0     0  544  988  0  1 99  0  0
 0  0  60928 1147056 114536 1604024    0    0     0     6  447  655  0  0 99  0  0
 0  0  60928 1147024 114536 1604032    0    0     0     0  530  847  0  0 99  0  0
Command 'sar' not found, but can be installed with:

sudo apt install sysstat

jeff@docker-host01:~$ sudo apt install sysstat
jeff@docker-host01:~$ sar 2 5
Linux 5.0.0-23-generic (docker-host01)  2021년 03월 10일        _x86_64_        (4 CPU)

15시 41분 19초     CPU     %user     %nice   %system   %iowait    %steal     %idle
15시 41분 21초     all      0.13      0.00      0.00      0.00      0.00     99.87
15시 41분 23초     all      0.38      0.00      0.25      0.38      0.00     99.00
15시 41분 25초     all      0.12      0.00      0.12      0.00      0.00     99.75
15시 41분 27초     all      0.13      0.00      0.13      0.00      0.00     99.75
15시 41분 29초     all      0.13      0.00      0.13      0.00      0.00     99.75
Average:          all      0.18      0.00      0.13      0.08      0.00     99.62
jeff@docker-host01:~$ iostat 2 5
Linux 5.0.0-23-generic (docker-host01)  2021년 03월 10일        _x86_64_        (4 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           2.03    4.92    1.04    0.84    0.00   91.17

Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
loop0             0.00         0.01         0.00        131          0
loop1             0.00         0.01         0.00        116          0
loop2             0.04         0.05         0.00       1211          0
loop3             0.01         0.03         0.00        589          0
loop4             0.00         0.00         0.00         46          0
loop5             0.00         0.01         0.00        330          0
loop6             0.02         0.06         0.00       1442          0
loop7             0.47         0.51         0.00      11631          0
scd1              0.02         0.41         0.00       9354          0
sda              13.42       101.62       499.04    2298113   11285072
loop8             0.10         0.11         0.00       2470          0
loop9             0.70         0.75         0.00      16915          0
loop10            0.00         0.00         0.00         54          0
loop11            0.00         0.00         0.00         48          0
loop12            0.00         0.01         0.00        116          0
loop13            0.00         0.01         0.00        122          0
loop14            0.05         0.09         0.00       2095          0
loop15            0.02         0.06         0.00       1462          0
loop16            0.04         0.08         0.00       1882          0
loop17            0.00         0.00         0.00          4          0
jeff@docker-host01:~$ top
top - 15:43:55 up  6:17,  3 users,  load average: 0.25, 0.31, 0.27
Tasks: 269 total,   1 running, 206 sleeping,   0 stopped,   0 zombie
%Cpu(s):  2.0 us,  0.9 sy,  4.9 ni, 91.2 id,  0.8 wa,  0.0 hi,  0.1 si,  0.0 st
KiB Mem :  4036836 total,  1145980 free,  1170980 used,  1719876 buff/cache
KiB Swap:  2097148 total,  2036220 free,    60928 used.  2591972 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
 8700 jeff      20   0   45528   4476   3696 R   6.2  0.1   0:00.01 top
    1 root      20   0  225908   9952   6988 S   0.0  0.2   0:23.58 systemd
    2 root      20   0       0      0      0 S   0.0  0.0   0:00.01 kthreadd
    3 root       0 -20       0      0      0 I   0.0  0.0   0:00.00 rcu_gp
    4 root       0 -20       0      0      0 I   0.0  0.0   0:00.00 rcu_par_gp
    6 root       0 -20       0      0      0 I   0.0  0.0   0:00.00 kworker/0:0H-kb
...
jeff@docker-host01:~$ free -mt
              total        used        free      shared  buff/cache   available
Mem:           3942        1143        1119          11        1679        2531
Swap:          2047          59        1988
Total:         5990        1202        3108
jeff@docker-host01:~$ df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            2.0G     0  2.0G   0% /dev
tmpfs           395M  1.8M  393M   1% /run
/dev/sda1        98G  9.0G   84G  10% /
```

— 부하 모니터링

```bash
jeff@docker-host01:~$ vi srvmon.sh
#!/bin/bash
printf "Memory\t\tDisk\t\tCPU\n"
end=$((SECONDS+3600))
while [ $SECONDS -lt $end ]; do
MEMORY=$(free -m | awk 'NR==2{printf "%.2f%%\t\t", $3*100/$2 }')
DISK=$(df -h | awk '$NF=="/"{printf "%s\t\t", $5}')
CPU=$(top -bn1 | grep load | awk '{printf "%.2f%%\t\t\n", $(NF-2)}')
echo "$MEMORY$DISK$CPU"
sleep 5
done
jeff@docker-host01:~$ chmod 744 srvmon.sh
jeff@docker-host01:~$ ./srvmon.sh
Memory          Disk            CPU
29.15%          10%             0.28%
29.15%          10%             0.26%
jeff@docker-host01:~$ sudo apt -y install stress
jeff@docker-host01:~$ sudo apt -y install htop

// 모니터링 준비
jeff@docker-host01:~$ ./srvmon.sh > srv_report.txt
jeff@docker-host01:~$ htop

// 부하
jeff@docker-host01:~$ stress -c 2 -i 1 -m 1 --vm-bytes 128M -t 3600s
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/87d797cc-4f7e-47fd-aa93-108a2913bff8/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/87d797cc-4f7e-47fd-aa93-108a2913bff8/Untitled.png)

— memory 제한 경고

```bash
jeff@docker-host01:~$ docker run -d --memory=1g --name=nginx_mem_1g nginx:1.19
WARNING: Your kernel does not support swap limit capabilities or the cgroup is not mounted. Memory limited without swap.
b858d6c6c7cb388d646d4ab456d208fdc1606e5567c9e7e7d2936ff5571b146f
jeff@docker-host01:~$ docker stop nginx_mem_1g
jeff@docker-host01:~$ docker rm nginx_mem_1g
jeff@docker-host01:~$ docker info
....
WARNING: No swap limit support
-> 해결
jeff@docker-host01:~$ sudo vi /etc/default/grub
# If you change this file, run 'update-grub' afterwards to update
# /boot/grub/grub.cfg.
# For full documentation of the options in this file, see:
#   info -f grub -n 'Simple configuration'

GRUB_DEFAULT=0
GRUB_TIMEOUT_STYLE=hidden
GRUB_TIMEOUT=0
GRUB_DISTRIBUTOR=`lsb_release -i -s 2> /dev/null || echo Debian`
GRUB_CMDLINE_LINUX_DEFAULT="cgroup_enable=memory swapaccount=1" <<<
#GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"                      <<<
GRUB_CMDLINE_LINUX=""
jeff@docker-host01:~$ sudo update-grub
jeff@docker-host01:~$ sudo reboot
jeff@docker-host01:~$ docker run -d --memory=1g --name=nginx_mem_1g nginx:1.19
52f84c8002ea3dbcbb626fa62520a9a2e9efd4ca59b6dcf8a74cb46134b37c24
jeff@docker-host01:~$ docker info
--> Warning message 없어진 것을 확인!
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9c1ccc0f-e4f4-4bcd-a710-a423cd838b87/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9c1ccc0f-e4f4-4bcd-a710-a423cd838b87/Untitled.png)

제한 주기 전

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/46c8bdac-4800-4a7d-b3c7-5bd3954f45a0/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/46c8bdac-4800-4a7d-b3c7-5bd3954f45a0/Untitled.png)

제한 준 후

— container 메모리 제한

```bash
// 물리 메모리 200M, swap 메모리 400m을 가지는 container를 실행
jeff@docker-host01:~$ docker run -m=200m --memory-swap=400m -itd --name=mem-test ubuntu:14.04
30efd4eccbe0461dbbe098c40bd3c233fc3df76302163e1e834698d2777d41ff
jeff@docker-host01:~$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED         STATUS         PORTS                    NAMES
30efd4eccbe0   ubuntu:14.04             "/bin/bash"              4 seconds ago   Up 2 seconds                            mem-test
52f84c8002ea   nginx:1.19               "/docker-entrypoint.…"   2 minutes ago   Up 2 minutes   80/tcp                   nginx_mem_1g
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   4 hours ago     Up 4 minutes   0.0.0.0:9559->8080/tcp   cadvisor

// container 메모리 할당 확인
jeff@docker-host01:~$ docker inspect mem-test | grep \"Memory\"
            "Memory": 209715200,
jeff@docker-host01:~$ docker inspect mem-test | grep \"MemorySwap\"
            "MemorySwap": 419430400,
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bc59a6a9-4d03-43a9-aa13-da99696c7ea0/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bc59a6a9-4d03-43a9-aa13-da99696c7ea0/Untitled.png)

— CPU 제한

`--cpu-share`

```bash
jeff@docker-host01:~$ docker run -d --name cpu_1024 --cpu-shares 1024 leecloudo/stress:1.0 stress --cpu 4
f86cdab7d175a5ede9618114a53d1909f81a41454c3c1c5958830b4a321da1ab
jeff@docker-host01:~$ docker run -d --name cpu_512 --cpu-shares 512 leecloudo/stress:1.0 stress --cpu 4
97605ec7a4d52e7e06de8216cc146c1f8938e1a30c834503318c90b319cc79d6
jeff@docker-host01:~$ ps -auxf | grep stress
jeff      4366  0.0  0.0  15716  1008 pts/1    S+   16:44   0:00              \_ grep --color=auto stress
root      4126  0.0  0.0   7480   868 ?        Ss   16:43   0:00  \_ stress --cpu 4
root      4178 90.2  0.0   7480    92 ?        R    16:43   0:40      \_ stress --cpu 4
root      4179 89.9  0.0   7480    92 ?        R    16:43   0:40      \_ stress --cpu 4
root      4180 89.7  0.0   7480    92 ?        R    16:43   0:40      \_ stress --cpu 4
root      4181 89.9  0.0   7480    92 ?        R    16:43   0:40      \_ stress --cpu 4
root      4292  0.1  0.0   7480   932 ?        Ss   16:44   0:00  \_ stress --cpu 4
root      4338 34.0  0.0   7480    92 ?        R    16:44   0:04      \_ stress --cpu 4
root      4339 34.1  0.0   7480    92 ?        R    16:44   0:04      \_ stress --cpu 4
root      4340 33.6  0.0   7480    92 ?        R    16:44   0:04      \_ stress --cpu 4
root      4341 33.9  0.0   7480    92 ?        R    16:44   0:04      \_ stress --cpu 4
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f03aabc7-13dc-40ce-9362-5cd01bf8cbfe/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f03aabc7-13dc-40ce-9362-5cd01bf8cbfe/Untitled.png)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/90a8c176-d033-42e1-9b4f-a34df471bbd4/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/90a8c176-d033-42e1-9b4f-a34df471bbd4/Untitled.png)

```bash
jeff@docker-host01:~$ docker stop cpu_1024 cpu_512
jeff@docker-host01:~$ docker rm cpu_1024 cpu_512
```

`--cpuset-cpus`

```bash
--cpuset-cpus="0,3" -> 1,4 번째 cpu 사용
--cpuset-cpus="0-2" -> 1,2,3 번째 cpu 사용
jeff@docker-host01:~$ docker run -d --name cpuset_1 --cpuset-cpus=2 leecloudo/stress:1.0 stress --cpu 1
d5f9fd63b4046d1fbd78e3a5bbd4491bb63b0a6456a95b2953e032b9ce1b6b23
jeff@docker-host01:~$ htop
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ec2b0b66-f3f3-43d9-b0a1-1345d3b2ad04/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ec2b0b66-f3f3-43d9-b0a1-1345d3b2ad04/Untitled.png)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d65eee98-9cf8-42cd-916e-5dc8768d4e77/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d65eee98-9cf8-42cd-916e-5dc8768d4e77/Untitled.png)

```bash
jeff@docker-host01:~$ docker stop cpuset_1
jeff@docker-host01:~$ docker rm cpuset_1
jeff@docker-host01:~$ docker run -d --name cpuset_ --cpuset-cpus=0,3 leecloudo/stress:1.0 stress --cpu 2
eca51c561cddede22fd711bede081cd0df7f1156c19db880ad83554a8f937fb0
jeff@docker-host01:~$ htop
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7ad8228d-682c-4679-8600-94db4d267e46/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7ad8228d-682c-4679-8600-94db4d267e46/Untitled.png)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5605a634-a834-4e46-8d3c-494c3cd50ace/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5605a634-a834-4e46-8d3c-494c3cd50ace/Untitled.png)

```bash
jeff@docker-host01:~$ docker stop cpuset_
jeff@docker-host01:~$ docker rm cpuset_
```

— 실행중인 container의 cpu 제한

```bash
~$ docker update --cpu-shares 512 -m 300M container_name
~$ docker update --cpus=rate(%) container_name

jeff@docker-host01:~$ docker run -d --name cpuset_1 --cpuset-cpus=2 leecloudo/stress:1.0 stress --cpu 1
0715a006d7c2749a2207633061fd93d7b1c2de11d2bb5829ff9ffc2144591238
jeff@docker-host01:~$ docker update --cpus=0.2 cpuset_1
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6197fa9b-1dfe-4ee1-a5a8-df884c1ee7e1/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6197fa9b-1dfe-4ee1-a5a8-df884c1ee7e1/Untitled.png)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bc695725-1af8-4148-b86e-c919d8ce7885/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bc695725-1af8-4148-b86e-c919d8ce7885/Untitled.png)

💡cpu 사용률이 줄은 것을 확인!

```bash
jeff@docker-host01:~$ docker stop cpuset_1
jeff@docker-host01:~$ docker rm cpuset_1
```

### Disk 제한

```bash
jeff@docker-host01:~$ docker run -it --rm ubuntu:14.04 bash
root@298ed6d92c37:/# dd if=/dev/zero of=test.out bs=1M count=10 oflag=direct
10+0 records in
10+0 records out
10485760 bytes (10 MB) copied, 0.534085 s, 19.6 MB/s

jeff@docker-host01:~$ docker run -it --device-write-bps /dev/sda:1mb ubuntu:14.04 bash
root@82908b83c8d2:/# dd if=/dev/zero of=test.out bs=1M count=10 oflag=direct
10+0 records in
10+0 records out
10485760 bytes (10 MB) copied, 10.0035 s, 1.0 MB/s

jeff@docker-host01:~$ docker run -it --device-write-bps /dev/sda:10mb ubuntu:14.04 bash
root@c1ad894caab6:/# dd if=/dev/zero of=test.out bs=1M count=10 oflag=direct
10+0 records in
10+0 records out
10485760 bytes (10 MB) copied, 1.00432 s, 10.4 MB/s
```

속도 차이 확인

19.6MB/s → 1.0 MB/s → 10.4 MB/s

## Docker Volume 생성

### Host OS directory와 Container partition(bind mount)과 파일 공유

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7f8aa167-3a71-4605-8b75-6213112ebfab/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7f8aa167-3a71-4605-8b75-6213112ebfab/Untitled.png)

1. volume

    → `docker volume create 볼륨이름(/var/lib/docker/...)`

2. bind mount

    → `docker run -v "host_dir":"container_dir"`

3. tmpfs mount

    → `docker run --tmpfs /container_app`

### Docker Bind Mount

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3476f05a-c9c0-4633-8748-f889d30d1da5/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3476f05a-c9c0-4633-8748-f889d30d1da5/Untitled.png)

— Host OS directory와 Container partition(bind mount)과 파일 공유

```bash
jeff@docker-host01:~$ mkdir hello1 hello2
jeff@docker-host01:~$ cd hello1
jeff@docker-host01:~/hello1$ cat > test1
test1      << ctrl+d로 빠져나오기
jeff@docker-host01:~/hello1$ cd ..
jeff@docker-host01:~$ cd hello2
jeff@docker-host01:~/hello2$ cat > test2
test2      << ctrl+d로 빠져나오기
jeff@docker-host01:~$ docker run -it \
> --name ubuntu_volume \
> -v /home/jeff/hello1:/hello1 \
> -v /home/jeff/hello2:/hello2 \
> ubuntu:16.04 bash
root@3e1dc6fa4c26:/# ls
bin   dev  hello1  home  lib64  mnt  proc  run   srv  tmp  var
boot  etc  hello2  lib   media  opt  root  sbin  sys  usr
root@3e1dc6fa4c26:/# cd hello1
root@3e1dc6fa4c26:/hello1# ls
test1
root@3e1dc6fa4c26:/hello1# cd ../hello2
root@3e1dc6fa4c26:/hello2# ls
test2
root@3e1dc6fa4c26:/hello2# cd ../hello1

// 두 개의 볼륨 확인
root@3e1dc6fa4c26:/hello1# mount
...
/dev/sda1 on /hello1 type ext4 (rw,relatime,errors=remount-ro)
/dev/sda1 on /hello2 type ext4 (rw,relatime,errors=remount-ro)
...

// 한 개의 볼륨 확인
root@3e1dc6fa4c26:/hello1# df -h
Filesystem      Size  Used Avail Use% Mounted on
...
/dev/sda1        98G  9.0G   84G  10% /hello1
...
root@3e1dc6fa4c26:/hello1# echo "Hi~" >> test1
root@3e1dc6fa4c26:/hello1# cat test1
test1
Hi~
root@3e1dc6fa4c26:/hello1#    << CTRL+P+Q
jeff@docker-host01:~$ cd hello1
jeff@docker-host01:~/hello1$ cat test1
test1
Hi~
jeff@docker-host01:~/hello1$ cd
jeff@docker-host01:~$ docker inspect \
> --format="{{ .HostConfig.Binds }}" \
> ubuntu_volume
[/home/jeff/hello1:/hello1 /home/jeff/hello2:/hello2]
```

```bash
방법 1)
jeff@docker-host01:~$ mkdir target
jeff@docker-host01:~$ docker run -itd --name=bind-test1 \
> --mount type=bind,source="$(pwd)"/target,target=/var/log \
> centos:8
be7689823447efb55d97920a22088d0c387a0efa88956d77e9876bb02fdef112

방법 2)
jeff@docker-host01:~$ docker run -itd --name=bind-test2 \
> -v /home/jeff/target2:/var/log \
> centos:8
f4040b2f2987383d5da3985f84e022946f2569acf075c75d51eb3a75390a315b
jeff@docker-host01:~$ ls -l
total 72
....
drwxrwxr-x 2 jeff jeff 4096  3월 10 17:49 target
drwxr-xr-x 2 root root 4096  3월 10 17:52 target2   < 소유권이 root에게 간다
....

방법 3)
jeff@docker-host01:~$ docker run -itd --name=bind-test3 \
> -v /home/jeff/target_ro:/app1:ro \
> -v /home/jeff/target_rw:/app2:rw \
> centos:8
60c2bfe4426aa9b58d9e3c840b3fe61b23914d874349df0b5c131474492f00bf

=============================================================================
jeff@docker-host01:~$ docker inspect --format="{{ .HostConfig.Binds }}" bind-test2
[/home/jeff/target2:/var/log]
jeff@docker-host01:~$ docker inspect --format="{{ .HostConfig.Binds }}" bind-test3
[/home/jeff/target_ro:/app1:ro /home/jeff/target_rw:/app2:rw]
```

— tmpfs

```bash
jeff@docker-host01:~$ docker run -itd --name=tmpfs-test1 \
> --mount type=tmpfs,destination=/var/www/html \
> httpd:2
d25f103a4a9519c41beeefd794287c8ed2971460cf1e0ee79939bf35d17cb2d6

jeff@docker-host01:~$ docker run -itd --name=tmpfs-test2 \
> --tmpfs /var/www/html \
> httpd:2
71452d2a43e0a3219a13e0a138e5d6a23eebbf76110894286b2c5d40f9629a50

jeff@docker-host01:~$ docker inspect --format="{{ .HostConfig.Tmpfs }}" tmpfs-test2
map[/var/www/html:]
```

— volume : docker가 직접 관리 (docker volume create)

```bash
jeff@docker-host01:~$ docker volume create my-appvol-1
my-appvol-1
jeff@docker-host01:~$ docker volume ls
DRIVER    VOLUME NAME
local     31505bec9bbaff51e8252231d92be8cede489062a67eb832c4d04488624e14e2
local     my-appvol-1
jeff@docker-host01:~$ docker volume inspect my-appvol-1
[
    {
        "CreatedAt": "2021-03-10T18:03:01+09:00",
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/my-appvol-1/_data",
        "Name": "my-appvol-1",
        "Options": {},
        "Scope": "local"
    }
]
jeff@docker-host01:~$ docker run -itd --name=vol-test1 \
> -v my-appvol-1:/var/log \
> ubuntu:14.04
264a25758f2db37632798a080a35e9286d0db03f8f4056a60b7b1958c6f2fa34
jeff@docker-host01:~$ docker run -itd --name=vol-test2 \
> --mount source=my-appvol-1,target=/var/log \
> ubuntu:14.04
3b47026b87e0eeec8deea97241e4c58073cc1108e5ee65cf2564243fdb270b17

jeff@docker-host01:~$ docker inspect --format="{{ .Mounts }}" vol-test1
[{volume my-appvol-1 /var/lib/docker/volumes/my-appvol-1/_data /var/log local z true }]
```
