### nodejs 기반의 runserver 구성

```bash
jeff@docker-host01:~$ mkdir devteam_js
jeff@docker-host01:~$ cd devteam_js/
jeff@docker-host01:~/devteam_js$ vi runapp.js
const http = require('http');

const server = http.createServer().listen(6060);

server.on('request', (req, res) => {
    console.log('request arrived.');
    res.write("HostName: " + process.env.HOSTNAME + "\n");
    res.end();
});

server.on('connection', (socket) => {
    console.log("Connected");
});
jeff@docker-host01:~/devteam_js$ vi Dockerfile
FROM node:15.3.0-alpine3.10

RUN apk add --no-cache tini curl

WORKDIR /app

COPY runapp.js .

EXPOSE 6060

ENTRYPOINT ["/sbin/tini", "--"]

CMD ["node", "runapp.js"]
jeff@docker-host01:~/devteam_js$ docker build -t nodejs:1.0 .
Sending build context to Docker daemon  3.072kB
Step 1/7 : FROM node:15.3.0-alpine3.10
15.3.0-alpine3.10: Pulling from library/node
21c83c524219: Pull complete
dcc3d4e3dbdc: Pull complete
fb2ff0a998fc: Pull complete
00d593b0c323: Pull complete
Digest: sha256:62efdbf5c32d43dc4c67e1b7dad4a30039b8efbb419e82ca1d108f71c3bfbc41
Status: Downloaded newer image for node:15.3.0-alpine3.10
 ---> b0b3b9ce4043
Step 2/7 : RUN apk add --no-cache tini curl
 ---> Running in da8442a7555b
fetch http://dl-cdn.alpinelinux.org/alpine/v3.10/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.10/community/x86_64/APKINDEX.tar.gz
(1/5) Installing ca-certificates (20191127-r2)
(2/5) Installing nghttp2-libs (1.39.2-r1)
(3/5) Installing libcurl (7.66.0-r3)
(4/5) Installing curl (7.66.0-r3)
(5/5) Installing tini (0.18.0-r0)
Executing busybox-1.30.1-r3.trigger
Executing ca-certificates-20191127-r2.trigger
OK: 9 MiB in 21 packages
Removing intermediate container da8442a7555b
 ---> 9a9eb92aa065
Step 3/7 : WORKDIR /app
 ---> Running in d868a6e02419
Removing intermediate container d868a6e02419
 ---> 3a4fb967fb5f
Step 4/7 : COPY runapp.js .
 ---> 42985a77a3d6
Step 5/7 : EXPOSE 6060
 ---> Running in 7ee37ac81f04
Removing intermediate container 7ee37ac81f04
 ---> 40b975508809
Step 6/7 : ENTRYPOINT ["/sbin/tini", "--"]
 ---> Running in 3f5b28f6e503
Removing intermediate container 3f5b28f6e503
 ---> 8e9159b7ebfb
Step 7/7 : CMD ["node", "runapp.js"]
 ---> Running in 09b93b7f10ee
Removing intermediate container 09b93b7f10ee
 ---> e2750a55da2b
Successfully built e2750a55da2b
Successfully tagged nodejs:1.0
jeff@docker-host01:~/devteam_js$ docker run -itd -p 6060:6060 --name=nodejs nodejs:1.0
7ac3a3e2d5dffe2b6f0334a1fbc4a069812314f6ea2ac637cd89882278d7c828
jeff@docker-host01:~/devteam_js$ curl 192.168.56.102:6060
HostName: 7ac3a3e2d5df
```

### Go 언어를 활용한 Service 배포

```bash
jeff@docker-host01:~$ mkdir devteam_go
jeff@docker-host01:~$ cd devteam_go/
jeff@docker-host01:~/devteam_go$ vi Dockerfile
FROM golang:1.11-alpine AS build

MAINTAINER kevin,lee <hylee@dshub.cloud>
LABEL "purpose"="Go Application Service Deployment"

WORKDIR /src/
COPY main.go go.* /src/
RUN CGO_ENABLED=0 go build -o /bin/demo

FROM scratch
COPY --from=build /bin/demo /bin/demo
ENTRYPOINT ["/bin/demo"]
jeff@docker-host01:~/devteam_go$ vi main.go
package main

import (
        "fmt"
        "os"
        "log"
        "net/http"
)
func handler(w http.ResponseWriter, r *http.Request){
    name, err := os.Hostname()
    if err != nil {
      panic(err)
    }

    fmt.Fprintln(w, "hostname:", name)
}
func main() {
    fmt.Fprintln(os.Stdout,"Starting GoApp Server......")
      http.HandleFunc("/",handler)
      log.Fatal(http.ListenAndServe(":8080",nil))
}
jeff@docker-host01:~/devteam_go$ docker build -t goapp:1.0 .
Sending build context to Docker daemon  3.072kB
Step 1/9 : FROM golang:1.11-alpine AS build
1.11-alpine: Pulling from library/golang
9d48c3bd43c5: Pull complete
7f94eaf8af20: Pull complete
9fe9984849c1: Pull complete
ec448270508e: Pull complete
65ba82af53f7: Pull complete
Digest: sha256:09e47edb668c2cac8c0bbce113f2f72c97b1555d70546dff569c8b9b27fcebd3
Status: Downloaded newer image for golang:1.11-alpine
 ---> e116d2efa2ab
Step 2/9 : MAINTAINER kevin,lee <hylee@dshub.cloud>
 ---> Running in 24f574dedac9
Removing intermediate container 24f574dedac9
 ---> b1159798e848
Step 3/9 : LABEL "purpose"="Go Application Service Deployment"
 ---> Running in edf0cd892057
Removing intermediate container edf0cd892057
 ---> b086d46b42cc
Step 4/9 : WORKDIR /src/
 ---> Running in 2c85e67cee78
Removing intermediate container 2c85e67cee78
 ---> b429c85c1ba6
Step 5/9 : COPY main.go go.* /src/
 ---> d6bd3751fbe8
Step 6/9 : RUN CGO_ENABLED=0 go build -o /bin/demo
 ---> Running in c3c454cc07ff
Removing intermediate container c3c454cc07ff
 ---> 6a1207173ffc
Step 7/9 : FROM scratch
 --->
Step 8/9 : COPY --from=build /bin/demo /bin/demo
 ---> 4dcd48dfd04e
Step 9/9 : ENTRYPOINT ["/bin/demo"]
 ---> Running in 1ca01ea1e108
Removing intermediate container 1ca01ea1e108
 ---> 5219b84fb50e
Successfully built 5219b84fb50e
Successfully tagged goapp:1.0
jeff@docker-host01:~/devteam_go$ docker images
REPOSITORY        TAG                 IMAGE ID       CREATED          SIZE
goapp             1.0                 5219b84fb50e   47 seconds ago   6.51MB
jeff@docker-host01:~/devteam_go$ docker run --name goapp-deploy -p 8080:8080 -d goapp:1.0
98ae24e26d95311b8827299501778c422ff5509c3aee87dee5b0d73fec9f50ec
jeff@docker-host01:~/devteam_go$ curl localhost:8080
hostname: 98ae24e26d95
jeff@docker-host01:~/devteam_go$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED         STATUS         PORTS                    NAMES
98ae24e26d95   goapp:1.0                "/bin/demo"              9 seconds ago   Up 9 seconds   0.0.0.0:8080->8080/tcp   goapp-deploy
7ac3a3e2d5df   nodejs:1.0               "/sbin/tini -- node …"   7 minutes ago   Up 7 minutes   0.0.0.0:6060->6060/tcp   nodejs
def157f00539   google/cadvisor:latest   "/usr/bin/cadvisor -…"   30 hours ago    Up 26 hours    0.0.0.0:9559->8080/tcp   cadvisor
jeff@docker-host01:~/devteam_go$ docker inspect goapp-deploy
[
    {
        "Id": "98ae24e26d95311b8827299501778c422ff5509c3aee87dee5b0d73fec9f50ec",
        "Created": "2021-03-11T09:35:28.337596324Z",
        "Path": "/bin/demo",
        "Args": [],
        "State": {
            "Status": "running",
            "Running": true,
            "Paused": false,
            "Restarting": false,
            "OOMKilled": false,
            "Dead": false,
            "Pid": 480,
            "ExitCode": 0,
            "Error": "",
            "StartedAt": "2021-03-11T09:35:28.703947379Z",
            "FinishedAt": "0001-01-01T00:00:00Z"
        },
        "Image": "sha256:5219b84fb50ef576bda836b0fea638a20f73fc047cf3dc56219d8ad07daf8cc6",
        "ResolvConfPath": "/var/lib/docker/containers/98ae24e26d95311b8827299501778c422ff5509c3aee87dee5b0d73fec9f50ec/resolv.conf",
        "HostnamePath": "/var/lib/docker/containers/98ae24e26d95311b8827299501778c422ff5509c3aee87dee5b0d73fec9f50ec/hostname",
        "HostsPath": "/var/lib/docker/containers/98ae24e26d95311b8827299501778c422ff5509c3aee87dee5b0d73fec9f50ec/hosts",
        "LogPath": "/var/lib/docker/containers/98ae24e26d95311b8827299501778c422ff5509c3aee87dee5b0d73fec9f50ec/98ae24e26d95311b8827299501778c422ff5509c3aee87dee5b0d73fec9f50ec-json.log",
        "Name": "/goapp-deploy",
        "RestartCount": 0,
        "Driver": "overlay2",
        "Platform": "linux",
        "MountLabel": "",
        "ProcessLabel": "",
        "AppArmorProfile": "docker-default",
        "ExecIDs": null,
        "HostConfig": {
            "Binds": null,
            "ContainerIDFile": "",
            "LogConfig": {
                "Type": "json-file",
                "Config": {}
            },
            "NetworkMode": "default",
            "PortBindings": {
                "8080/tcp": [
                    {
                        "HostIp": "",
                        "HostPort": "8080"
                    }
                ]
            },
            "RestartPolicy": {
                "Name": "no",
                "MaximumRetryCount": 0
            },
            "AutoRemove": false,
            "VolumeDriver": "",
            "VolumesFrom": null,
            "CapAdd": null,
            "CapDrop": null,
            "CgroupnsMode": "host",
            "Dns": [],
            "DnsOptions": [],
            "DnsSearch": [],
            "ExtraHosts": null,
            "GroupAdd": null,
            "IpcMode": "private",
            "Cgroup": "",
            "Links": null,
            "OomScoreAdj": 0,
            "PidMode": "",
            "Privileged": false,
            "PublishAllPorts": false,
            "ReadonlyRootfs": false,
            "SecurityOpt": null,
            "UTSMode": "",
            "UsernsMode": "",
            "ShmSize": 67108864,
            "Runtime": "runc",
            "ConsoleSize": [
                0,
                0
            ],
            "Isolation": "",
            "CpuShares": 0,
            "Memory": 0,
            "NanoCpus": 0,
            "CgroupParent": "",
            "BlkioWeight": 0,
            "BlkioWeightDevice": [],
            "BlkioDeviceReadBps": null,
            "BlkioDeviceWriteBps": null,
            "BlkioDeviceReadIOps": null,
            "BlkioDeviceWriteIOps": null,
            "CpuPeriod": 0,
            "CpuQuota": 0,
            "CpuRealtimePeriod": 0,
            "CpuRealtimeRuntime": 0,
            "CpusetCpus": "",
            "CpusetMems": "",
            "Devices": [],
            "DeviceCgroupRules": null,
            "DeviceRequests": null,
            "KernelMemory": 0,
            "KernelMemoryTCP": 0,
            "MemoryReservation": 0,
            "MemorySwap": 0,
            "MemorySwappiness": null,
            "OomKillDisable": false,
            "PidsLimit": null,
            "Ulimits": null,
            "CpuCount": 0,
            "CpuPercent": 0,
            "IOMaximumIOps": 0,
            "IOMaximumBandwidth": 0,
            "MaskedPaths": [
                "/proc/asound",
                "/proc/acpi",
                "/proc/kcore",
                "/proc/keys",
                "/proc/latency_stats",
                "/proc/timer_list",
                "/proc/timer_stats",
                "/proc/sched_debug",
                "/proc/scsi",
                "/sys/firmware"
            ],
            "ReadonlyPaths": [
                "/proc/bus",
                "/proc/fs",
                "/proc/irq",
                "/proc/sys",
                "/proc/sysrq-trigger"
            ]
        },
        "GraphDriver": {
            "Data": {
                "LowerDir": "/var/lib/docker/overlay2/59d00749efda67a2aec4cb9c1890ff045f8d7a88566eb011e0d8722052ea3646-init/diff:/var/lib/docker/overlay2/e58f866fa89fe4a82f42773ece298b1e4b57de83e8bfe0d3af73e5018e329138/diff",
                "MergedDir": "/var/lib/docker/overlay2/59d00749efda67a2aec4cb9c1890ff045f8d7a88566eb011e0d8722052ea3646/merged",
                "UpperDir": "/var/lib/docker/overlay2/59d00749efda67a2aec4cb9c1890ff045f8d7a88566eb011e0d8722052ea3646/diff",
                "WorkDir": "/var/lib/docker/overlay2/59d00749efda67a2aec4cb9c1890ff045f8d7a88566eb011e0d8722052ea3646/work"
            },
            "Name": "overlay2"
        },
        "Mounts": [],
        "Config": {
            "Hostname": "98ae24e26d95",
            "Domainname": "",
            "User": "",
            "AttachStdin": false,
            "AttachStdout": false,
            "AttachStderr": false,
            "ExposedPorts": {
                "8080/tcp": {}
            },
            "Tty": false,
            "OpenStdin": false,
            "StdinOnce": false,
            "Env": [
                "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
            ],
            "Cmd": null,
            "Image": "goapp:1.0",
            "Volumes": null,
            "WorkingDir": "",
            "Entrypoint": [
                "/bin/demo"
            ],
            "OnBuild": null,
            "Labels": {}
        },
        "NetworkSettings": {
            "Bridge": "",
            "SandboxID": "d2e678a85e796d22c60dc185263529680c45d9bceca2ec3ec5f4f589a2163810",
            "HairpinMode": false,
            "LinkLocalIPv6Address": "",
            "LinkLocalIPv6PrefixLen": 0,
            "Ports": {
                "8080/tcp": [
                    {
                        "HostIp": "0.0.0.0",
                        "HostPort": "8080"
                    }
                ]
            },
            "SandboxKey": "/var/run/docker/netns/d2e678a85e79",
            "SecondaryIPAddresses": null,
            "SecondaryIPv6Addresses": null,
            "EndpointID": "4de05cab9a402e1eeeda6b5148187b0ec4ed500c1ad5f6952ce6455f504d8ea0",
            "Gateway": "172.17.0.1",
            "GlobalIPv6Address": "",
            "GlobalIPv6PrefixLen": 0,
            "IPAddress": "172.17.0.4",
            "IPPrefixLen": 16,
            "IPv6Gateway": "",
            "MacAddress": "02:42:ac:11:00:04",
            "Networks": {
                "bridge": {
                    "IPAMConfig": null,
                    "Links": null,
                    "Aliases": null,
                    "NetworkID": "68c9da664f8884187b812beb478a3ee24eb64069acda8a7cd3122855bdcb9c21",
                    "EndpointID": "4de05cab9a402e1eeeda6b5148187b0ec4ed500c1ad5f6952ce6455f504d8ea0",
                    "Gateway": "172.17.0.1",
                    "IPAddress": "172.17.0.4",
                    "IPPrefixLen": 16,
                    "IPv6Gateway": "",
                    "GlobalIPv6Address": "",
                    "GlobalIPv6PrefixLen": 0,
                    "MacAddress": "02:42:ac:11:00:04",
                    "DriverOpts": null
                }
            }
        }
    }
]
jeff@docker-host01:~/devteam_go$ docker stop goapp-deploy
jeff@docker-host01:~/devteam_go$ docker rm goapp-deploy
jeff@docker-host01:~/devteam_go$ docker image tag goapp:1.0 tjsrud428/goapp:1.0
jeff@docker-host01:~/devteam_go$ docker login
Login with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.
Username: tjsrud428
Password:
WARNING! Your password will be stored unencrypted in /home/jeff/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
jeff@docker-host01:~/devteam_go$ docker push tjsrud428/goapp:1.0
The push refers to repository [docker.io/tjsrud428/goapp]
c7e550f8ae89: Pushed
1.0: digest: sha256:9e6d3316dc3f9e8d638cf75530add38f19654bd0233bbffdd04b306c3c71bd48 size: 528
jeff@docker-host01:~/devteam_go$ docker pull seokhyun1121/go-app:1.0
1.0: Pulling from seokhyun1121/go-app
893f2a01e52b: Pull complete
Digest: sha256:9414a0d45d63d6ee01a98dc1f3dfbea288a4ec1a602ba27cc5bb35e5a7a03758
Status: Downloaded newer image for seokhyun1121/go-app:1.0
docker.io/seokhyun1121/go-app:1.0
```

### Dockerfile을 이용한 인프라 구성 → 테스트 완료

1. 이미지 공유 → [hub.docker.com](http://hub.docker.com)
2. code 공유 → [github.com](http://github.com) → [hub.docker.com](http://hub.docker.com) 으로 자동 빌드

    public registry

    <> private registry(container) - 1번 서버에 구축

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3976b9f5-cbf4-4100-9876-b6dd3abb4290/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3976b9f5-cbf4-4100-9876-b6dd3abb4290/Untitled.png)

```bash
jeff@docker-host01:~$ git clone https://github.com/SK9604/docker-app-repo.git
Cloning into 'docker-app-repo'...
remote: Enumerating objects: 6, done.
remote: Counting objects: 100% (6/6), done.
remote: Compressing objects: 100% (4/4), done.
remote: Total 6 (delta 0), reused 0 (delta 0), pack-reused 0
Unpacking objects: 100% (6/6), done.
jeff@docker-host01:~$ cd docker-app-repo/
jeff@docker-host01:~/docker-app-repo$ ls
Dockerfile  index.html
jeff@docker-host01:~/docker-app-repo$ cat Dockerfile
FROM ubuntu:latest

RUN apt-get update && apt-get install -y -q nginx

COPY ./index.html /usr/share/nginx/html/

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
jeff@docker-host01:~/docker-app-repo$ cat index.html
<h1> Hello, Docker + Github </h1>
```

hub.docker에 github 계정 연동

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/dc5c242e-8741-42f7-b720-207cbf55ce23/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/dc5c242e-8741-42f7-b720-207cbf55ce23/Untitled.png)

- docker elasticsearch cluster_3nodes

    ```bash
    jeff@jeff-VirtualBox:~$ mkdir elk_cluster
    jeff@jeff-VirtualBox:~$ cd elk_cluster/
    jeff@jeff-VirtualBox:~/elk_cluster$ vi docker-compose.yml
    version: '2.2'
    services:
    elasticsearch:
    container_name: elk_m
    image: elasticsearch:6.5.3
    environment:
    - cluster.name=LDCC-cluster
    - node.name=master-node1
    - bootstrap.memory_lock=true
    - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    ulimits:
    memlock:
    soft: -1
    hard: -1
    volumes:
    - es1:/usr/share/elasticsearch/data
    ports:
    - 9200:9200
    - 9300:9300
    networks:
    - esnet
    stdin_open: true
    tty: true
    elasticsearch1:
    container_name: elk_d1
    image: elasticsearch:6.5.3
    environment:
    - cluster.name=LDCC-cluster
    - node.name=data-node1
    - bootstrap.memory_lock=true
    - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    - "discovery.zen.ping.unicast.hosts=elasticsearch"
    ulimits:
    memlock:
    soft: -1
    hard: -1
    volumes:
    - es2:/usr/share/elasticsearch/data
    ports:
    - 9301:9300
    networks:
    - esnet
    stdin_open: true
    tty: true
    depends_on:
    - elasticsearch
    elasticsearch2:
    container_name: elk_d2
    image: elasticsearch:6.5.3
    environment:
    - cluster.name=LDCC-cluster
    - node.name=data-node2
    - bootstrap.memory_lock=true
    - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    - "discovery.zen.ping.unicast.hosts=elasticsearch1"
    ulimits:
    memlock:
    soft: -1
    hard: -1
    volumes:
    - es3:/usr/share/elasticsearch/data
    ports:
    - 9302:9300
    networks:
    - esnet
    stdin_open: true
    tty: true
    depends_on:
    - elasticsearch
    kibana:
    container_name: kibana
    image: kibana:6.5.3
    ports:
    - 5601:5601
    networks:
    - esnet
    depends_on:
    - elasticsearch
    - elasticsearch1
    - elasticsearch2
    volumes:
    es1:
    driver: local
    es2:
    driver: local
    es3:
    driver: local
    networks:
    esnet:
    ```

- - 설치 (동일 dir.)

    ```bash
    $ docker-compose up -d
    $ docker-compose logs -f
    ```

- - 정지 및 삭제

    ```bash
    $ docker-compose down
    Stopping kibana ... done
    Stopping elasticsearch2 ... done
    Stopping elasticsearch ... done
    Removing kibana ... done
    Removing elasticsearch2 ... done
    Removing elasticsearch ... done
    Removing network elasticsearch_esnet
    ```
