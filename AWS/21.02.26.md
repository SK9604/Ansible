# Architecting On AWS

## 과정 결과

AWS 아키텍처의 각 측면과 어떻게 이들이 결합되어 복잡한 시스템을 구축하는지

```
클라우드 설계

- 전반적인 AWS 서비스 이해를 기본으로
- 클라우드 아키텍트 직무자
    - 어떻게? 클라우드 아키텍트 직무자는 회사(조직)의 로지스틱에 관해 충분한 이해와 정보를 통해 의사결절정을 도와주는 형태
- 업무에 대한 이해를 기반으로 클라우드 서비스 설계
```

### 간단 복습

클라우드란 무엇입니까? (네트워킹이 연결된 인터넷 세상) AWS란 무엇입니까?(CSP중에 하나) 온프레미스(기업자체 서버)

클라우드 설계 지침

Well-Architected 프레임워크(품질, 비용효율)

AWS 글로벌 인프라

대규모 아키텍처 설계 : 컴퓨팅 서비스 & 서버리스환경의 개발

## Amazon.com

전자 상거래 도구는 "뒤죽박죽" 섞여 있었다

애플리케이션 및 아키텍처가 적절한 계획 없이 구축된 것

서비스는 서로 구분되어야 했습니다

해결책 : 도구가 잘 문서화된 일련의 API로 정비되어 Amazon에서 서비스 개발을 위한 표준이 되었다.

```
AWS의 모든 서비스들은 API를 이용해 통신
```

### 문제 지속

여전히 Amazon.com은 신속하게 애플리케이션을 구축하는 데 어려움을 겪었다

데이터베이스, 컴퓨팅 및 스토리지 구성 요소는 구축하는 데 3개월이 걸렸습니다

각 팀이 규모 또는 재사용에 대한 계획 없이 자체 리소스를 구축했습니다

해결책 : 인프라 상에 고가용성, 확장성, 신뢰성이 뛰어난 아키텍처를 생성하기 위한 내부 서비스를 구축했습니다. 2006년, 이들 서비스를 AWS로 판매하기 시작했습니다.

```
아마존에서 AWS 탄생 비화? 리소스 사용 비중 50% 이하

A회사에서 서버구축(금요일 저녁)
미국 서버구매(3.5억) → 인천 → 통관 → 금요일 저녁 8시에 회사에 도착 → 서버 조립(메뉴얼) → 하루 → OS 엔지니어 unix 설치 * 3회 → 데이터베이스(oracle) * 3회 → 화요일 오후 2시 작업 완료
```

### AWS란?

프로그래밍 가능한 리소스(API) IaC

동적 기능

종량 과금제

```
자본지축(CapEx)을 운영 비용(OpEx)으로 대체한다.
```

### 클라우드 컴퓨팅의 여섯 가지 장점

자본 비용을 가변 비용으로 대체

규모의 경제로 얻게 되는 이점

용량 추정 불필요

속도 및 민첩성 개선

중요한 문제에 집중

몇 분 만에 전 세계에 배포

### AWS Well-Architected 프레임 워크

다섯가지 핵심 요소

보안, 안정성, 비용 최적화, 성능 효율성, 운영 우수성

### 보안

자격 증명 기반

추적 가능성 활성화 (감사 기능, Audit)

모든 계층에서의 보안

위험 평가 및 완화 전략

```
정책 = 권한 -> 최소 권한의 원칙! (업무적으로 필요한 권한만 부여!)
```

### 안정성

컴퓨팅 리소스를 동적으로 확보하여 수요를 충족

인프라 또는 서비스 장애로부터 신속하게 복구 (경험이 중요하다)

다음과 같은 중단을 완화

구성 오류

일시적인 네트워크 문제

```
D증권사 : 서버 플래시 디스크 2장 꽂혀 있는 상태 -> 둘 중 하나가 장애가 났다
	-> hot swap 방식의 서버 -> 고장난 2번 디스크 교체 -> 실수로 1번을 뺐다
	-> 곧바로 장애 발생 -> 한시간만에 복구완료 
	-> 장애 발생 시 증권사는 평균 10분당 손실액 120억 -> 약 700억 손실
	-> 직원 해고 -> 그래서 경력자를 뽑음,,
```

### 비용 최적화

효율성 측정

불필요한 비용 제거

관리형 서비스 사용을 고려

클라우드 규모로 운영되므로 더 저렴한 비용으로 트랜잭션 또는 서비스를 제공

서버를 유지 관리하는 운영상의 부담 감소

```
서버의 수명은 5년
5년마다 교체를 해야 한다 -> 교체 비용이 많이 든다 -> 클라우드로 이전
```

```
클라우드 서비스
	ㄴ비관리형 서비스 : 고객이 직접 관리하는 서비스
	ㄴ관리형 서비스 : 고객과 CSP가 반반씩 관리하는 서비스
	ㄴ완전관리형 서비스 : CSP가 완전 관리하는 서비스
```

### 운영 우수성

시스템을 실행 및 모니터링하는 기능 (CloudWatch)

지원 프로세스 및 절차를 지속적으로 개선하기 위한

배포, 업데이트(버전, 패치), 운영

### 성능 효율성

효율적인 리소스를 선택하고 수요 변화에 맞춰 효율성을 유지

고급 기술을 대중화

Mechanical Sympathy(기계적 동정심) (서버를 모르는 사람이 서버를 운영 할 수 없다는 뜻)

## AWS 글로벌 인프라

### AWS 데이터 센터

보통 단일 데이터 센터에서 수만 개의 서버를 운영

모든 데이터 센터는 "콜드 연결"이 아니라 온라인으로 연결됨

AWS 사용자 정의 네트워크 장비

다양한 ODM 사용

사용자 지정 네트워크 프로토콜 스택

```
데이터 센터의 집합 = 가용영역 
가용영역의 집합 = 리전
```

### AWS 가용 영역

각 가용 영역은

하나 이상의 데이터 센터로 구성됩니다

내결함성을 갖도록 설계됩니다

프라이빗 링크를 통해 다른 가용영역과 상호 연결됩니다

가용 영역은 사용자가 선택할 수 있습니다

AWS는 복원성을 위해 가용 영역 간 복제를 권장합니다

### AWS 리전

각 AWS 리전은 두 개 이상의 가용 영역으로 이루어져 있습니다

AWS는 전 세계에 24개의 리전을 보유하고 있습니다

사용자는 리전 간 데이터 복제를 활성화하고 제어할 수 있습니다

리전 간 통신은 AWS 백본 네트워크 인프라를 사용합니다

## 대규모 아키텍처 다이어그램

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0c8da003-0695-4c7a-b736-270115493621/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0c8da003-0695-4c7a-b736-270115493621/Untitled.png)

## 가장 간단한 아키텍처

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bb3c1b82-a608-43a7-9a9f-3e0c428833f2/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bb3c1b82-a608-43a7-9a9f-3e0c428833f2/Untitled.png)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f8f0492a-eadf-457c-a2aa-28b728c3eab0/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f8f0492a-eadf-457c-a2aa-28b728c3eab0/Untitled.png)

아키텍처 측면에서의 필요성

이제 막 창업한 기업으로서 클라우드에서 안정적으로 데이터를 배포, 저장, 분석하는 간편한 방법이 필요합니다.

모듈 개요

Amazon Simple Storage Service(S3)가 해결할 수 있는 문제

콘텐츠(bucket → object)를 효율적으로 저장

Amazon S3 Glacier가 해결할 수 있는 문제

리전 선택 : 업로드한 콘텐츠는 리전내의 모든 AZ에 복제된다.

# Amazon S3

객체(Object = contents = file) 수준 스토리지

99.999999999% 내구성을 제공하도록 설계 → **복제**

이벤트 트리거(lambda 함수) : 설정한 조건에 부합이 되면 어떤 서비스를 실행하다.

이것이 어떤 문제를 해결하는데 도움이 되었습니까?

정적 (관련 프로세스가 없다) 웹 콘텐츠와 미디어 저장 및 배포(endpoint = 주소)

```
EC2 + httpd(아파치웹서비스 > process) + index.html
```

### 액세스 제어 - 일반

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/de69e583-4df6-4b69-a3e4-c0c9d5945ac9/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/de69e583-4df6-4b69-a3e4-c0c9d5945ac9/Untitled.png)

```
다른 사용자의 접근 제어 > IAM(user) + role + policy
액세스 정책은 XML 코드로 작성한다
```

### 액세스 제어 - 버킷 정책

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/112fd099-604c-401e-9c95-ac79671d668a/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/112fd099-604c-401e-9c95-ac79671d668a/Untitled.png)

### 액세스 포인트

Amazon S3 액세스 포인트는 해당 엔드포인트를 사용하여 데이터에 액세스하는 방법을 설명하는 전용 액세스 정책을 포함하는 고유한 호스트 이름입니다

액세스 포인트는 다음을 지원합니다

다일 사용자

애플리케이션

사용자들의 그룹 또는 애플리케이션

### 버전 관리

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7995dbbf-304b-48da-92cf-e60667e81ac4/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7995dbbf-304b-48da-92cf-e60667e81ac4/Untitled.png)

### 액세스 제어 - CORS

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/087519ff-27f0-4646-8715-a9fd7da94bc7/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/087519ff-27f0-4646-8715-a9fd7da94bc7/Untitled.png)

버킷이 서로 다른 경우에 사용하는 정책

XML 코드(Javascript 형태로 공유)

### 사용사례

정적 (관련 프로세스가 없다) 웹 콘텐츠와 미디어 저장 및 배포(endpoint = 주소)

전체 정적 웹 사이트 호스팅 (HTML, 파일, 이미지, 동영상 및 클라이언트 측 스크립트)

연산 및 대규모 분석용 데이터 스토어

금융 거래 분석, 클릭스트림 분석, 미디어 트랜스코딩

백업 도구

### Amazon S3로 데이터를 이동

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b3a8f6b3-9b84-442a-9789-9e4ab614775c/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b3a8f6b3-9b84-442a-9789-9e4ab614775c/Untitled.png)

```
/dev/sda1
/dev 모든 장치 디렉토리
sd   SCSI device
a    disk number
1    partition number
```

- 실습

### 멀티파트 업로드

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b95a11d8-f607-47f0-b8ed-35745481b45d/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b95a11d8-f607-47f0-b8ed-35745481b45d/Untitled.png)

분할해서 업로드가 진행이 되지만 끝나면 하나로 합쳐져서 사용할 수 있다

### Transfer Acceleration

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c1f23f49-0541-46a2-b2bc-c94575a9476e/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c1f23f49-0541-46a2-b2bc-c94575a9476e/Untitled.png)

대용량이나 빠르게 업로드 해야되는 경우라면 CDN 서비스(CloudFront)를 이용하면 가속화 할 수 있다.

전용 네트워크를 사용하여 가속하여 빠르게 업로드됨

```
데이터 용량
K < M < G < T < Peta < Exa < Zeta < Yota

ex) facebook이 하루에 처리하는 데이터 용량은? 4800 Peta 처리
```

### Amazon S3로 데이터를 이동

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6302c382-9d2f-48a5-8829-b6d2124f757e/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6302c382-9d2f-48a5-8829-b6d2124f757e/Untitled.png)

### Amazon S3는 언제 사용해야 하는가?

- **모범 사용 사례**

    한 번 쓰고 여러 번 읽어야 하는 경우

    데이터 액세스가 일시적으로 급증

    사용자가 매우 많고 콘텐츠 양이 다양

    데이터 세트가 계속 증가

- **이상적인 사용 사례가 아닌 경우**

    블록 스토리지 요구 사항

    자주 바뀌는 데이터

    장기 아카이브 스토리지

    → EBS같은 다른 스토리지 사용이 낫다

### 비용

- **다음에 대해 사용한 만큼만 지불**

    월별 GB

    다른 리전 또는 인터넷으로 전송

    PUT, COPY, POST, LIST 및 GET 요청

- **다음에 대해서는 비용을 지불할 필요가 없음**

    Amazon S3로 수신

    동일한 리전 내 Amazon EC2로 또는 CloudFront로 전송

# Amazon S3 Glacier

장기 데이터 스토리지

아카이브 또는 백업

매우 저렴한 스토리지 (Standard S3에 비해 1/5수준, 대신 액세스 타임이 매우 느림)

```
Cold Data 저장용 (자주 액세스 하지 않는다)
```

### 아카이브 및 저장소

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c05dc3db-0ce1-4e04-9413-c7bde6162d00/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c05dc3db-0ce1-4e04-9413-c7bde6162d00/Untitled.png)

감사 저장소는 함부로 저장 수정하지 못하게 함

### 관련 비용

신속 검색

표준 검색

대량 검색

### Amazon S3/Amazon S3 Glacier 스토리지 클래스

S3 Standard: 자주 액세스하는 데이터

S3 Standard 1A: 수명이 길고 자주 액세스하지 않는 데이터

S3 One Zone 1A: 수명이 길고 자주 액세스하지 않지만 빠른 액세스가 필요한 데이터

Amazon Glacier/Deep Archive: 거의 액세스하지 않는 데이터 보관

### 수명 주기 정책

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1806c74f-d945-426b-a494-b754e94a7e96/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1806c74f-d945-426b-a494-b754e94a7e96/Untitled.png)

# 아키텍처용 리전 선택

## 리전 선택

- 데이터 주권 및 규정 준수

    관련된 지역 데이터 프라이버시 법률이 있습니까?

    고객 데이터를 해외에 저장할 수 있습니까?

    거버넌스 의무를 준수할 수 있습니까?

- 사용자와 데이터 간 근접성

    지연 시간의 작은 차이가 고객 경험에 영향을 미칠 수 있습니다.

    사용자에게 가장 가까운 리전을 선택하십시오.

- 서비스 및 기능 가용성

    일부 서비스는 아직 모든 리전에서 제공되지는 않습니다.

    일부 서비스는 교차 리전으로 사용할 수 있지만 지연 시간이 증가합니다.

    정기적으로 서비스를 새 리전으로 확장하고 있습니다.

- 비용 효율성

    비용은 리전별로 다릅니다.

    Amazon S3와 같은 일부 서비스는 데이터를 외부로 전송할 때 비용이 발생합니다.

    전체 환경을 다른 리전으로 복제하는 비용 효율성을 고려하십시오.

# 어제 한 것

```
ELB + ASG + EC2*4 + httpd + index.html
사용자가 어디에 접속? EC2 네 대 중 어딘가(로드밸런서가 결정해준다)
밸런스 있게 뿌려주는 기능이 ELB에 있음
```

# 실습

아마존 리눅스환경

PuTTY

```
ec2-user로 접속
$ aws help
$ aws ec2 help
$ aws ec2 stop-instances --instance-ids
$ aws configure
	AWS Access Key ID [None]:
	AWS Secret Access Key [None]:
	Default region name [None]:
	Default output format [None]:
```

### awscli (명령어, aws)를 사용하려면?

- aws 명령어 버전 2 이상 권고

    ```
    $ aws --version
    	aws-cli/1.18.147 Python/2.7.18 Linux/4.14.219-161.340.amzn2.x86_64 botocore/1.18                .6
    ```

    ```
    $ curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                     Dload  Upload   Total   Spent    Left  Speed
    100 35.1M  100 35.1M    0     0  99.6M      0 --:--:-- --:--:-- --:--:-- 99.3M
    ```

    ```
    $ ls
    	awscliv2.zip
    $ unzip awscliv2.zip
    $ ls
    	aws  awscliv2.zip
    $ cd aws
    $ ls
    	dist  install  README.md  THIRD_PARTY_LICENSES
    $ sudo ./aws/install
    	Found preexisting AWS CLI installation: /usr/local/aws-cli/v2/current. Please rerun install script with --update flag.
    $ aws --version
    	aws-cli/2.1.28 Python/3.8.8 Linux/4.14.219-161.340.amzn2.x86_64 exe/x86_64.amzn.2 prompt/off
    ```

- IAM 사용자 생성  → Access Key / Secret Access Key 획득
    - 화면

    IAM 페이지 → 사용자 → 사용자 추가

    사용자 이름 : awscliuser

    액세스 유형 : 프로그래밍 방식 액세스 체크

    다음: 권한 클릭

    권한설정 : 기존 정책 직접 연결

    Administrator Access 선택

    다음: 태그 클릭

    다음: 검토 클릭

    사용자 만들기 클릭

    .csv 다운로드

- aws configure
    - 터미널에서 설정

## S3 ↔ EC2 : 송수신되는 데이터는 비용 없음

```
AWS S3에 파일 업로드하기
$ aws s3 ls
2021-02-26 06:13:01 myweb-sk
$ aws s3 ls s3://myweb-sk
                           PRE css/
                           PRE images/
2021-02-26 06:13:20        627 index.html
$ mkdir LABs
$ cd LABs/
$ touch test-awscli.txt
$ ls
test-awscli.txt
$ aws s3 cp test-awscli.txt s3://myweb-sk/test-awscli.txt
upload: ./test-awscli.txt to s3://myweb-sk/test-awscli.txt
```

Console에서 업로드 됐음을 확인

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1e65837d-6358-4a3a-b2cf-06577faada56/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1e65837d-6358-4a3a-b2cf-06577faada56/Untitled.png)

### **새로운 버킷 생성**

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/76720cf3-8222-45b2-9dd3-f18315a0bb68/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/76720cf3-8222-45b2-9dd3-f18315a0bb68/Untitled.png)

업로드 작업

```
$ mkdir upload
$ echo 'hi korea' > upload/korea.txt
$ echo 'hi usa' > upload/usa.txt
$ echo 'hi canada' > upload/canada.txt
$ ls upload/
	canada.txt  korea.txt  usa.txt
$ aws s3 sync upload s3://awscli-bucket-sk/
	upload: upload/canada.txt to s3://awscli-bucket-sk/canada.txt
	upload: upload/usa.txt to s3://awscli-bucket-sk/usa.txt
	upload: upload/korea.txt to s3://awscli-bucket-sk/korea.txt
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1c7f3c95-2809-454b-bdce-05d51569fd76/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1c7f3c95-2809-454b-bdce-05d51569fd76/Untitled.png)

### **퍼블릭으로 업로드**

```
$ echo 'hi aws' > upload/aws.txt
$ aws s3 sync upload s3://awscli-bucket-sk/ \
> --acl public-read
	upload: upload/aws.txt to s3://awscli-bucket-sk/aws.txt
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/501fc46a-922a-44ca-84cf-14cf01192488/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/501fc46a-922a-44ca-84cf-14cf01192488/Untitled.png)

별다른 퍼블릭 설정 없이 한번에 확인할 수 있음

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9794af6f-8e24-466a-85dc-ffcf17c8a95d/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9794af6f-8e24-466a-85dc-ffcf17c8a95d/Untitled.png)

Public read만 허용되어 있음을 확인

### **스토리지 클래스 바꿔서 업로드하기**

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0e40a2fb-4b06-4c94-9aed-15b45630e951/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0e40a2fb-4b06-4c94-9aed-15b45630e951/Untitled.png)

```
$ mkdir upload_IA
$ echo 'hi korea' > upload_IA/korea.txt
$ echo 'hi usa' > upload_IA/usa.txt
$ echo 'hi canada' > upload_IA/canada.txt
$ aws s3 sync upload_IA s3://awscli-bucket-sk/standard_IA/ --storage-class STANDARD_IA
	upload: upload_IA/canada.txt to s3://awscli-bucket-sk/standard_IA/canada.txt
	upload: upload_IA/usa.txt to s3://awscli-bucket-sk/standard_IA/usa.txt
	upload: upload_IA/korea.txt to s3://awscli-bucket-sk/standard_IA/korea.txt
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/2d1f24a9-ccfc-4b72-bf28-ff46c6cc6d69/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/2d1f24a9-ccfc-4b72-bf28-ff46c6cc6d69/Untitled.png)

### 실습 시나리오

A 회사는 웹사이트 개발 회사이다. 개발팀이 웹사이트를 개발한 뒤 github에 해당 자료를 upload 했다.

이 객체를 S3://버킷 에 업로드 하기 전에 압축 파일을 풀고 업로드 수행. 서비스 배포.

개발되는 사이트 데이터들(*.js, *.html...)는 directory단위로 개발 → 압축 → github에 공유

```
$ sudo yum -y install git
$ git clone https://github.com/brayanlee/website.git
	Cloning into 'website'...
	remote: Enumerating objects: 16, done.
	remote: Counting objects: 100% (16/16), done.
	remote: Compressing objects: 100% (11/11), done.
	remote: Total 16 (delta 0), reused 0 (delta 0), pack-reused 0
	Unpacking objects: 100% (16/16), done.
$ cd website/
$ ls
	website.tar.gz
$ tar xvzf website.tar.gz
	./
	./images/
	./images/big_cloud.png
	./index.html
	./css/
	./css/bootstrap.css
$ ls
	css  images  index.html  website.tar.gz
$ rm website.tar.gz
$ ls
	css  images  index.html
// 버킷 생성 (--region 생략 시 미국 오레곤으로 지정)
$ aws s3 mb s3://myweb-4463 --region ap-northeast-2
	make_bucket: myweb-4463
$ aws s3 ls
	2021-02-26 06:34:07 awscli-bucket-sk
	2021-02-26 06:59:28 myweb-4463
	2021-02-26 06:13:01 myweb-sk
$ aws s3 sync ./website s3://myweb-4463 --acl public-read
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c2d0cee2-5edc-4f04-bc9a-c746cf81f722/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c2d0cee2-5edc-4f04-bc9a-c746cf81f722/Untitled.png)

myweb-4463이 생겼음을 확인

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/651ba4d1-8c6b-4866-849e-c0e749fe0068/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/651ba4d1-8c6b-4866-849e-c0e749fe0068/Untitled.png)

파일들이 정상적으로 올라갔음을 확인

index.html의 객체 URL 클릭시 

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/db9dd0a2-238f-46fd-bcb2-c1bffed543c3/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/db9dd0a2-238f-46fd-bcb2-c1bffed543c3/Untitled.png)

정상적으로 작동됨을 확인

# 실습: AWS SDK-python을 이용한 S3 관리 및 조회

## 개발자 도구 : SDK

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/22628887-4c48-42a6-9875-a8974924371a/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/22628887-4c48-42a6-9875-a8974924371a/Untitled.png)

**S3_select_test.csv 저장**

```
Name,PhoneNumber,City,Occupation
Sam,(010) 555-6701,Irvine,Solutions Architect
Vinod,(010) 555-6702,Los Angeles,Solutions Architect
Jeff,(010) 555-6703,Seattle,AWS Evangelist
Jane,(010) 555-6704,Chicago,Developer
kevin,(010) 555-6705,Seoul,Instructor
Mary,(010) 555-6706,Chicago,Developer
Kate,(010) 555-6707,Chicago,Developer
Alice,(010) 555-6708,Seattle,AWS Evangelist
Sunny,(010) 555-6709,Seoul,Instructor
Sam,(010) 555-6710,Los Angeles,Solutions Architect
```

```
$ mkdir SDK
$ cd SDK/
$ vi S3_select_test.csv
$ cat S3_select_test.csv
	Name,PhoneNumber,City,Occupation
	Sam,(010) 555-6701,Irvine,Solutions Architect
	Vinod,(010) 555-6702,Los Angeles,Solutions Architect
	Jeff,(010) 555-6703,Seattle,AWS Evangelist
	Jane,(010) 555-6704,Chicago,Developer
	kevin,(010) 555-6705,Seoul,Instructor
	Mary,(010) 555-6706,Chicago,Developer
	Kate,(010) 555-6707,Chicago,Developer
	Alice,(010) 555-6708,Seattle,AWS Evangelist
	Sunny,(010) 555-6709,Seoul,Instructor
	Sam,(010) 555-6710,Los Angeles,Solutions Architect
```

Step 1) S3_select_4463 버킷 awscli로 생성

```
$ aws s3 mb s3://s3-select-4463 --region ap-northeast-2
	make_bucket: s3-select-4463
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ce82b6d9-ee3d-4e4b-a3a1-e2918a8d077c/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ce82b6d9-ee3d-4e4b-a3a1-e2918a8d077c/Untitled.png)

Step 2) 생성한 csv파일을 upload 수행

```
$ aws s3 cp S3_select_test.csv s3://s3-select-4463/S3_select_test.csv
	upload: ./S3_select_test.csv to s3://s3-select-4463/S3_select_test.csv
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a52c8ca7-4699-4005-940e-bc9cef06e95e/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a52c8ca7-4699-4005-940e-bc9cef06e95e/Untitled.png)

```
$ sudo yum -y install python3
$ python3
	Python 3.7.9 (default, Feb 18 2021, 03:10:35)
	[GCC 7.3.1 20180712 (Red Hat 7.3.1-12)] on linux
	Type "help", "copyright", "credits" or "license" for more information.
	>>> exit()
$ python -m venv ~/s3select_demo/env
	/usr/bin/python: No module named venv
$ python3 -m venv ~/s3select_demo/env
$ source ~/s3select_demo/env/bin/activate
(env) $ pip install boto3
```

```
$ vi kevin_stats.py
아래 코드 복붙
```

```
import boto3
s3 = boto3.client('s3')
resp = s3.select_object_content(
    Bucket='s3-select-4463',            //버킷 이름
    Key='S3_select_test.csv',           //업로드 된 csv 파일 이름
    ExpressionType='SQL',
    Expression="SELECT * FROM s3object s where s.\"Name\" = 'kevin'",
    InputSerialization = {'CSV': {"FileHeaderInfo": "Use"}, 'CompressionType': 'NONE'},
    OutputSerialization = {'CSV': {}},
)

for event in resp['Payload']:
    if 'Records' in event:
        records = event['Records']['Payload'].decode('utf-8')
        print(records)
    elif 'Stats' in event:
        statsDetails = event['Stats']['Details']
        print("Stats details bytesScanned: ")
        print(statsDetails['BytesScanned'])
        print("Stats details bytesProcessed: ")
        print(statsDetails['BytesProcessed'])
        print("Stats details bytesReturned: ")
        print(statsDetails['BytesReturned'])
```

```
$ python3 kevin_stats.py
kevin,(010) 555-6705,Seoul,Instructor

Stats details bytesScanned:
460
Stats details bytesProcessed:
460
Stats details bytesReturned:
38

kevin_stats.py 파일에 "Name\" = 'Jeff'" 로 바꾼 뒤

$ python3 kevin_stats.py
Jeff,(010) 555-6703,Seattle,AWS Evangelist

Stats details bytesScanned:
460
Stats details bytesProcessed:
460
Stats details bytesReturned:
43
```

### 번외 ( 로또 돌리기! )

```
from random import shuffle
from time import sleep

gamenum = input('로또 게임 회수를 입력하세요: ')

for i in range(int(gamenum)):
   balls = [x+1 for x in range(45)]
   ret = []
   for j in range(6):
      shuffle(balls)			# balls를 무작위로 섞고,
      number = balls.pop()		# balls의 제일 마지막 숫자를 추출하고, 제거
      ret.append(number)		# 추출된 숫자를 ret에 추가
   print('로또번호[%d]: ' %(i+1), end='')
   print(ret)
   sleep(1)
```

```
$ vi lotto.py
$ python lotto.py
	로또 게임 회수를 입력하세요: 5
	로또번호[1]: [39, 30, 11, 32, 15, 23]
	로또번호[2]: [1, 20, 39, 37, 19, 7]
	로또번호[3]: [27, 19, 12, 28, 8, 34]
	로또번호[4]: [9, 16, 12, 42, 39, 23]
	로또번호[5]: [37, 41, 10, 45, 21, 32]
```

### 압축

압축률

GZIP < BZIP2

CPU overhead

GZIP < BZIP2

```
$ ls
kevin_stats.py  lotto.py  S3_select_test.csv
(env) $ gzip S3_select_test.csv
(env) $ ls
	kevin_stats.py  lotto.py  S3_select_test.csv.gz
```

```
$ cat kevin_stats_gzip.py
import boto3
s3 = boto3.client('s3')
resp = s3.select_object_content(
    Bucket='s3-select-4463',
    Key='S3_select_test.csv.gz',
    ExpressionType='SQL',
    Expression="SELECT * FROM s3object s where s.\"Name\" = 'Jeff'",
    InputSerialization = {'CSV': {"FileHeaderInfo": "Use"}, 'CompressionType': 'GZIP'},
    OutputSerialization = {'CSV': {}},
)

for event in resp['Payload']:
    if 'Records' in event:
        records = event['Records']['Payload'].decode('utf-8')
        print(records)
    elif 'Stats' in event:
        statsDetails = event['Stats']['Details']
        print("Stats details bytesScanned: ")
        print(statsDetails['BytesScanned'])
        print("Stats details bytesProcessed: ")
        print(statsDetails['BytesProcessed'])
        print("Stats details bytesReturned: ")
        print(statsDetails['BytesReturned'])
$ cp kevin_stats.py kevin_stats_gzip.py
(env) $ ls
	kevin_stats_gzip.py  kevin_stats.py  lotto.py  S3_select_test.csv.gz
(env) $ aws s3 cp S3_select_test.csv.gz s3://s3-select-4463
	upload: ./S3_select_test.csv.gz to s3://s3-select-4463/S3_select_test.csv.gz
(env) $ python3 kevin_stats_gzip.py
	Jeff,(010) 555-6703,Seattle,AWS Evangelist

	Stats details bytesScanned:
	242
	Stats details bytesProcessed:
	460
	Stats details bytesReturned:
	43
```

## 정적 웹사이트 호스팅

- 캡처

myweb-sk 버킷 → 속성 → 정적 웹 사이트 호스팅 → 편집 → 정적 웹 사이트 호스팅 활성화 → 인덱스 문서 : index.html → 확인 → 버킷 권한 탭 → 버킷 정책 → 편집 → 정책 생성기 → Allow, , GetObject, ARN입력 → ADD → get Policy → 복사 → Resource 마지막에 /* 추가 → 변경 사항 저장 → 모든 객체 퍼블릭으로 설정 → myweb-sk가 퍼블릭 액세스 가능 상태인 것을 확인

S3 upload된 웹사이트 정보를 CloudFront에 연결 → global cache(엣지로케이션)

### CloudFront

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e1b5404a-bf19-476f-9618-dec84dc69545/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e1b5404a-bf19-476f-9618-dec84dc69545/Untitled.png)

위 그림 : CDN 사용 전 , 아래 그림 : CDN 사용 후

- 캡처

Console에서 CloudFront로 이동 → Create Distribution → Get Started → Origin Domain Name에 본인 S3 선택 → Origin ID 자동 → default root object : index.html → 생성 완료 → status가 deployed로 변하면 Domain Name으로 웹사이트 접속 → 접속됨을 확인

웹 페이지 로딩 시간 테스트

[사이트](https://www.webpagetest.org/) 접속

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6ff19f4e-3661-44cf-89f8-34b7fa842f48/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6ff19f4e-3661-44cf-89f8-34b7fa842f48/Untitled.png)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/be8a6b0a-06a8-4d8f-b70f-2c4f491ef2de/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/be8a6b0a-06a8-4d8f-b70f-2c4f491ef2de/Untitled.png)

클라우드 프론트가 훨씬 빠름을 확인

## 프리 도메인 만들기!

[사이트](https://www.freenom.com/en/index.html?lang=en) 접속

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/27297d6b-ad0a-4c6b-a3e5-fe0e7c91ccb2/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/27297d6b-ad0a-4c6b-a3e5-fe0e7c91ccb2/Untitled.png)

도메인 확보!

- 도메인

AWS Console에 ACM 검색

AWS Certificate Manager

인증서 프로비저닝 시작하기
